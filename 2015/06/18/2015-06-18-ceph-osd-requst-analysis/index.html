<!doctype html>
<html class="theme-next use-motion theme-next-mala">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>



  <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


    <meta name="description" content="学无止境" />



  <meta name="keywords" content="ceph,filestore,osd," />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="OSD Message示例分析12345678910111213141516171819202122232425262728293031323334353637osd_op(client.4813.0:510 default.4161.780__shadow__99999.txt_0 [write 2097152~524288] 5.ba5249f6 ack+ondisk+write+known_">
<meta name="keywords" content="ceph,filestore,osd">
<meta property="og:type" content="article">
<meta property="og:title" content="Ceph osd request分析">
<meta property="og:url" content="http://www.ictfox.cn/2015/06/18/2015-06-18-ceph-osd-requst-analysis/index.html">
<meta property="og:site_name" content="ictfox blog">
<meta property="og:description" content="OSD Message示例分析12345678910111213141516171819202122232425262728293031323334353637osd_op(client.4813.0:510 default.4161.780__shadow__99999.txt_0 [write 2097152~524288] 5.ba5249f6 ack+ondisk+write+known_">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2017-07-20T01:58:03.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ceph osd request分析">
<meta name="twitter:description" content="OSD Message示例分析12345678910111213141516171819202122232425262728293031323334353637osd_op(client.4813.0:510 default.4161.780__shadow__99999.txt_0 [write 2097152~524288] 5.ba5249f6 ack+ondisk+write+known_">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mala',
    sidebar: 'post'
  };
</script>

  <title> Ceph osd request分析 | ictfox blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">ForTech</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-next-categories"></i> <br />
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            <i class="menu-item-icon icon-next-about"></i> <br />
            About
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              Ceph osd request分析
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-06-18T10:31:17+08:00" content="2015-06-18">
            2015-06-18
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/ceph/" itemprop="url" rel="index">
                  <span itemprop="name">ceph</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><h2 id="OSD-Message示例分析"><a href="#OSD-Message示例分析" class="headerlink" title="OSD Message示例分析"></a>OSD Message示例分析</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">osd_op(client<span class="number">.4813</span><span class="number">.0</span>:<span class="number">510</span> <span class="keyword">default</span><span class="number">.4161</span><span class="number">.780</span>__shadow__99999.txt_0 [write <span class="number">2097152</span>~<span class="number">524288</span>] <span class="number">5.b</span>a5249f6 ack+ondisk+write+known_if_redirected e130) v4</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MOSDOp</span> :</span> <span class="keyword">public</span> Message &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(ostream&amp; out)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        out &lt;&lt; <span class="string">"osd_op("</span> &lt;&lt; get_reqid();     client<span class="number">.4813</span><span class="number">.0</span>:<span class="number">510</span></span><br><span class="line">        out &lt;&lt; <span class="string">" "</span>;</span><br><span class="line">        <span class="keyword">if</span> (!oloc.nspace.empty())</span><br><span class="line">            out &lt;&lt; oloc.nspace &lt;&lt; <span class="string">"/"</span>;</span><br><span class="line">        out &lt;&lt; oid;                         <span class="keyword">default</span><span class="number">.4161</span><span class="number">.780</span>__shadow__99999.txt_0</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">        out &lt;&lt; <span class="string">" "</span>;</span><br><span class="line">        <span class="keyword">if</span> (may_read())</span><br><span class="line">            out &lt;&lt; <span class="string">"r"</span>;</span><br><span class="line">        <span class="keyword">if</span> (may_write())</span><br><span class="line">            out &lt;&lt; <span class="string">"w"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (snapid != CEPH_NOSNAP)</span><br><span class="line">            out &lt;&lt; <span class="string">"@"</span> &lt;&lt; snapid;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (oloc.key.size())</span><br><span class="line">            out &lt;&lt; <span class="string">" "</span> &lt;&lt; oloc;</span><br><span class="line"></span><br><span class="line">        out &lt;&lt; <span class="string">" "</span> &lt;&lt; ops;           [write <span class="number">2097152</span>~<span class="number">524288</span>]</span><br><span class="line">        out &lt;&lt; <span class="string">" "</span> &lt;&lt; pgid;          <span class="number">5.b</span>a5249f6</span><br><span class="line">        <span class="keyword">if</span> (is_retry_attempt())</span><br><span class="line">            out &lt;&lt; <span class="string">" RETRY="</span> &lt;&lt; get_retry_attempt();</span><br><span class="line">        <span class="keyword">if</span> (reassert_version != <span class="keyword">eversion_t</span>())</span><br><span class="line">            out &lt;&lt; <span class="string">" reassert_version="</span> &lt;&lt; reassert_version;</span><br><span class="line">        <span class="keyword">if</span> (get_snap_seq())</span><br><span class="line">            out &lt;&lt; <span class="string">" snapc "</span> &lt;&lt; get_snap_seq() &lt;&lt; <span class="string">"="</span> &lt;&lt; snaps;</span><br><span class="line">        out &lt;&lt; <span class="string">" "</span> &lt;&lt; ceph_osd_flag_string(get_flags());     ack+ondisk+write+known_if_redirected</span><br><span class="line">        out &lt;&lt; <span class="string">" e"</span> &lt;&lt; osdmap_epoch;     e130</span><br><span class="line">        out &lt;&lt; <span class="string">")"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="OSD-Message处理流程"><a href="#OSD-Message处理流程" class="headerlink" title="OSD Message处理流程"></a>OSD Message处理流程</h2><h3 id="Message在Primary-OSD的处理流程"><a href="#Message在Primary-OSD的处理流程" class="headerlink" title="Message在Primary OSD的处理流程"></a>Message在Primary OSD的处理流程</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> OSD::dispatch_op_fast(OpRequestRef&amp; op, OSDMapRef&amp; osdmap)</span><br><span class="line"><span class="keyword">void</span> OSD::handle_op(OpRequestRef&amp; op, OSDMapRef&amp; osdmap)</span><br><span class="line"><span class="keyword">void</span> OSD::enqueue_op(PG *pg, OpRequestRef&amp; op)</span><br><span class="line"><span class="keyword">void</span> PG::queue_op(OpRequestRef&amp; op) -- &#123; osd-&gt;op_wq.<span class="built_in">queue</span>(make_pair(PGRef(<span class="keyword">this</span>), op));&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">void</span> OSD::ShardedOpWQ::_process(<span class="keyword">uint32_t</span> thread_index, heartbeat_handle_d *hb) </span><br><span class="line"><span class="keyword">void</span> OSD::dequeue_op(PGRef pg, OpRequestRef op, ThreadPool::TPHandle &amp;handle)</span><br><span class="line"><span class="keyword">void</span> ReplicatedPG::do_request(OpRequestRef&amp; op, ThreadPool::TPHandle &amp;handle)</span><br><span class="line"><span class="keyword">void</span> ReplicatedPG::do_op(OpRequestRef&amp; op)          <span class="comment">// case CEPH_MSG_OSD_OP</span></span><br><span class="line"><span class="keyword">void</span> ReplicatedPG::execute_ctx(OpContext *ctx)</span><br><span class="line">|--  <span class="keyword">int</span> ReplicatedPG::prepare_transaction(OpContext *ctx)</span><br><span class="line">|    <span class="keyword">int</span> ReplicatedPG::do_osd_ops(OpContext *ctx, <span class="built_in">vector</span>&lt;OSDOp&gt;&amp; ops)</span><br><span class="line">|--  <span class="keyword">void</span> ReplicatedPG::issue_repop(RepGather *repop, <span class="keyword">utime_t</span> now)</span><br><span class="line">|    <span class="keyword">void</span> ReplicatedBackend::submit_transaction()</span><br><span class="line">|    |--  <span class="keyword">void</span> ReplicatedBackend::issue_op()</span><br><span class="line">|    |    |-- <span class="keyword">void</span> ReplicatedPG::send_message_osd_cluster()     <span class="comment">// send write data to replica osds</span></span><br><span class="line">|    |    |-- <span class="keyword">void</span> OSDService::send_message_osd_cluster(<span class="keyword">int</span> peer, Message *m, <span class="keyword">epoch_t</span> from_epoch) </span><br><span class="line">|    |--  parent-&gt;queue_transaction(<span class="keyword">op_t</span>, op.op);</span><br><span class="line">|    |    |-- <span class="keyword">int</span> FileStore::queue_transactions()    <span class="comment">// 没有journal或需要同时写journal和disk时，会调用 queue_op(osr, o);</span></span><br><span class="line">|    |    |-- <span class="keyword">void</span> JournalingObjectStore::_op_journal_transactions()</span><br><span class="line">|    |    |-- <span class="keyword">void</span> FileJournal::submit_entry()       <span class="comment">//添加到 deque&lt;write_item&gt; writeq;</span></span><br><span class="line">|--  <span class="keyword">void</span> ReplicatedPG::eval_repop(RepGather *repop)</span><br></pre></td></tr></table></figure>
<h3 id="异步journal写数据"><a href="#异步journal写数据" class="headerlink" title="异步journal写数据"></a>异步journal写数据</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FileJournal.Writer.entry() -&gt; FileJournal::write_thread_entry() -&gt; FileJournal::do_write() -&gt; FileJournal::write_bl()</span><br></pre></td></tr></table></figure>
<h3 id="Message在Replica-OSD的处理流程"><a href="#Message在Replica-OSD的处理流程" class="headerlink" title="Message在Replica OSD的处理流程"></a>Message在Replica OSD的处理流程</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> OSD::dispatch_op_fast(OpRequestRef&amp; op, OSDMapRef&amp; osdmap)</span><br><span class="line"><span class="keyword">void</span> OSD::handle_op(OpRequestRef&amp; op, OSDMapRef&amp; osdmap)</span><br><span class="line"><span class="keyword">void</span> OSD::enqueue_op(PG *pg, OpRequestRef&amp; op)</span><br><span class="line"><span class="keyword">void</span> PG::queue_op(OpRequestRef&amp; op) -- &#123; osd-&gt;op_wq.<span class="built_in">queue</span>(make_pair(PGRef(<span class="keyword">this</span>), op));&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> OSD::ShardedOpWQ::_process(<span class="keyword">uint32_t</span> thread_index, heartbeat_handle_d *hb) </span><br><span class="line"><span class="keyword">void</span> OSD::dequeue_op(PGRef pg, OpRequestRef op, ThreadPool::TPHandle &amp;handle)</span><br><span class="line"><span class="keyword">void</span> ReplicatedPG::do_request(OpRequestRef&amp; op, ThreadPool::TPHandle &amp;handle)</span><br><span class="line"><span class="keyword">bool</span> ReplicatedBackend::handle_message()</span><br><span class="line"><span class="keyword">void</span> ReplicatedBackend::sub_op_modify(OpRequestRef op)</span><br><span class="line">|--  parent-&gt;queue_transaction(<span class="keyword">op_t</span>, op.op);</span><br><span class="line">|    |-- <span class="keyword">int</span> FileStore::queue_transactions()</span><br></pre></td></tr></table></figure>
<h2 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a>回调函数</h2><p>在把transaction加入队列前，会初始化transaction的几个operation回调函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectStore</span>:</span></span><br><span class="line">        <span class="built_in">list</span>&lt;Context *&gt; on_applied;</span><br><span class="line">        <span class="built_in">list</span>&lt;Context *&gt; on_commit;</span><br><span class="line">        <span class="built_in">list</span>&lt;Context *&gt; on_applied_sync;</span><br></pre></td></tr></table></figure>
<h3 id="Primary-OSD"><a href="#Primary-OSD" class="headerlink" title="Primary OSD"></a>Primary OSD</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">— 发往replica的operation，处理replica reply是否全部返回</span><br><span class="line">Context *on_all_commit = <span class="keyword">new</span> C_OSD_RepopCommit(<span class="keyword">this</span>, repop);</span><br><span class="line">Context *on_all_applied = <span class="keyword">new</span> C_OSD_RepopApplied(<span class="keyword">this</span>, repop);</span><br><span class="line">Context *onapplied_sync = <span class="keyword">new</span> C_OSD_OndiskWriteUnlock(</span><br><span class="line">    repop-&gt;obc,</span><br><span class="line">    repop-&gt;ctx-&gt;clone_obc,</span><br><span class="line">    unlock_snapset_obc ? repop-&gt;ctx-&gt;snapset_obc : ObjectContextRef());</span><br><span class="line"></span><br><span class="line">— 发送到本OSD的operation，处理写本OSD的reply是否返回</span><br><span class="line"><span class="keyword">op_t</span>-&gt;register_on_applied_sync(on_local_applied_sync);</span><br><span class="line"><span class="keyword">op_t</span>-&gt;register_on_applied(</span><br><span class="line">    parent-&gt;bless_context(</span><br><span class="line">        <span class="keyword">new</span> C_OSD_OnOpApplied(<span class="keyword">this</span>, &amp;op)));</span><br><span class="line"><span class="keyword">op_t</span>-&gt;register_on_applied(</span><br><span class="line">    <span class="keyword">new</span> ObjectStore::C_DeleteTransaction(<span class="keyword">op_t</span>));</span><br><span class="line"><span class="keyword">op_t</span>-&gt;register_on_commit(</span><br><span class="line">    parent-&gt;bless_context(</span><br><span class="line">        <span class="keyword">new</span> C_OSD_OnOpCommit(<span class="keyword">this</span>, &amp;op)));</span><br></pre></td></tr></table></figure>
<h3 id="Replica-OSD"><a href="#Replica-OSD" class="headerlink" title="Replica OSD"></a>Replica OSD</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">— 发送到本OSD的operation，处理写本OSD的reply是否返回</span><br><span class="line">rm-&gt;localt.register_on_commit(</span><br><span class="line">    parent-&gt;bless_context(</span><br><span class="line">        <span class="keyword">new</span> C_OSD_RepModifyCommit(<span class="keyword">this</span>, rm)));</span><br><span class="line">rm-&gt;localt.register_on_applied(</span><br><span class="line">    parent-&gt;bless_context(     </span><br><span class="line">        <span class="keyword">new</span> C_OSD_RepModifyApply(<span class="keyword">this</span>, rm)));</span><br></pre></td></tr></table></figure>
<h2 id="Finisher类"><a href="#Finisher类" class="headerlink" title="Finisher类"></a>Finisher类</h2><p>Finisher类是在src/common中定义的一个专门查看操作是否结束的一个类。</p>
<p>在这个类里面拥有一个线程<code>finisher_thread</code>和一个类型为Context指针的队列<code>finisher_queue</code>。当一个操作线程完成自己的操作后，会将Context类型对象送入队列。此时<code>finisher_thread</code>线程循环监视着自己的<code>finisher_queue</code>队列，当发现了有新进入的Context时，会调用这个<code>Context::complete</code>函数，这个函数则会调用到Context子类自己实现的finish函数，来处理操作完成后的后续工作。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Finisher</span> &#123;</span></span><br><span class="line">    CephContext *cct;</span><br><span class="line">...</span><br><span class="line">    <span class="built_in">vector</span>&lt;Context*&gt; finisher_queue;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">void</span> *<span class="title">finisher_thread_entry</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">FinisherThread</span> :</span> <span class="keyword">public</span> Thread &#123;</span><br><span class="line">        Finisher *fin;</span><br><span class="line">        FinisherThread(Finisher *f) : fin(f) &#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span>* <span class="title">entry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">void</span>*)fin-&gt;finisher_thread_entry();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finisher_thread;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *Finisher::finisher_thread_entry()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">while</span> (!finisher_stop) &#123;</span><br><span class="line">        <span class="keyword">while</span> (!finisher_queue.empty()) &#123;</span><br><span class="line">            <span class="built_in">vector</span>&lt;Context*&gt; ls;</span><br><span class="line">            ls.swap(finisher_queue);</span><br><span class="line">...</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">vector</span>&lt;Context*&gt;::iterator p = ls.begin();</span><br><span class="line">                    p != ls.end();</span><br><span class="line">                    ++p) &#123;</span><br><span class="line">                <span class="keyword">if</span> (*p) &#123;</span><br><span class="line">                    (*p)-&gt;complete(<span class="number">0</span>);  <span class="comment">// 调用Context子类实现的finish函数</span></span><br><span class="line">                &#125;...</span><br><span class="line">            &#125;</span><br><span class="line">...</span><br><span class="line">        &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IO相关finisher"><a href="#IO相关finisher" class="headerlink" title="IO相关finisher"></a>IO相关finisher</h3><p>跟IO相关的finisher有三个，journal有一个，filestore有两个：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JournalingObjectStore</span> :</span> <span class="keyword">public</span> ObjectStore &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    Journal *journal;</span><br><span class="line">    Finisher finisher;   <span class="comment">// 负责journal写完后的通知处理</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileStore</span> :</span> <span class="keyword">public</span> JournalingObjectStore,</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">md_config_obs_t</span></span><br><span class="line">&#123;</span><br><span class="line">    Finisher ondisk_finisher;   <span class="comment">// 负责data写到journal后commit的通知处理</span></span><br><span class="line">    Finisher op_finisher;       <span class="comment">// 负责data写到filestore后apply的通知处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="写数据到FileStore和IO回调"><a href="#写数据到FileStore和IO回调" class="headerlink" title="写数据到FileStore和IO回调"></a>写数据到FileStore和IO回调</h2><h3 id="Primary-OSD-1"><a href="#Primary-OSD-1" class="headerlink" title="Primary OSD"></a>Primary OSD</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> FileStore::queue_transactions(Sequencer *posr, <span class="built_in">list</span>&lt;Transaction*&gt; &amp;tls,</span><br><span class="line">                                  TrackedOpRef osd_op,</span><br><span class="line">                                  ThreadPool::TPHandle *handle)</span><br><span class="line">&#123;</span><br><span class="line">            _op_journal_transactions(o-&gt;tls, o-&gt;op,</span><br><span class="line">                                     <span class="keyword">new</span> C_JournaledAhead(<span class="keyword">this</span>, osr, o, ondisk),</span><br><span class="line">                                     osd_op);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">C_JournaledAhead</span> :</span> <span class="keyword">public</span> Context &#123;</span><br><span class="line">    FileStore *fs;</span><br><span class="line">    FileStore::OpSequencer *osr;</span><br><span class="line">    FileStore::Op *o;</span><br><span class="line">    Context *ondisk;</span><br><span class="line"></span><br><span class="line">    C_JournaledAhead(FileStore *f, FileStore::OpSequencer *os, FileStore::Op *o, Context *ondisk):</span><br><span class="line">        fs(f), osr(os), o(o), ondisk(ondisk) &#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">finish</span><span class="params">(<span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        fs-&gt;_journaled_ahead(osr, o, ondisk);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在journal commit后会通过<code>JournalingObjectStore</code>类的 finisher 来通知调用到<code>C_JournaledAhead.finish()</code>函数。</p>
<p>在<code>_journal_ahead</code>函数里会把op添加到filestore的写队列里和FileStore类的<code>ondisk_finisher</code>队列里。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> FileStore::_journaled_ahead(OpSequencer *osr, Op *o, Context *ondisk)</span><br><span class="line">|-- queue_op(osr, o);                 —  <span class="keyword">void</span> FileStore::queue_op(OpSequencer *osr, Op *o) &#123;op_wq.<span class="built_in">queue</span>(osr);&#125;，把op添加到FileStore的op_wq队列中。</span><br><span class="line">|-- ondisk_finisher.<span class="built_in">queue</span>(to_queue);  —  这里通过ondisk_finisher来通知上层IO已经commit到journal，具体会调用到C_OSD_OnOpCommit.finish()函数。</span><br></pre></td></tr></table></figure>
<p>FileStore workqueue处理过程：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FileStore.OpWQ._process &#123;store-&gt;_do_op(osr, handle);&#125;</span><br><span class="line"><span class="keyword">void</span> FileStore::_do_op(OpSequencer *osr, ThreadPool::TPHandle &amp;handle)</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	apply_manager.op_apply_start(o-&gt;op);</span><br><span class="line">	<span class="keyword">int</span> r = _do_transactions(o-&gt;tls, o-&gt;op, &amp;handle);</span><br><span class="line">	apply_manager.op_apply_finish(o-&gt;op);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FileStore::_do_transactions() &#123;r = _do_transaction(**p, op_seq, trans_num, handle);&#125;</span><br><span class="line"><span class="keyword">unsigned</span> FileStore::_do_transaction() &#123;r = _write(cid, oid, off, len, bl, replica);<span class="comment">// case write&#125;</span></span><br></pre></td></tr></table></figure>
<p><code>C_OSD_OnOpCommit.finish()</code>函数调用到：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ReplicatedBackend::op_commit(InProgressOp *op)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    op-&gt;waiting_for_commit.erase(get_parent()-&gt;whoami_shard());       <span class="comment">// 把waiting_for_commit set里对应的信息清除</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (op-&gt;waiting_for_commit.empty()) &#123;            <span class="comment">// 为空是表明所有OSD写请求都已经返回</span></span><br><span class="line">        op-&gt;on_commit-&gt;complete(<span class="number">0</span>);                  <span class="comment">// 会调用到C_OSD_RepOpCommit.finish()</span></span><br><span class="line">        op-&gt;on_commit = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (op-&gt;done()) &#123;</span><br><span class="line">        assert(!op-&gt;on_commit &amp;&amp; !op-&gt;on_applied);</span><br><span class="line">        in_progress_ops.erase(op-&gt;tid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Replica-OSD-1"><a href="#Replica-OSD-1" class="headerlink" title="Replica OSD"></a>Replica OSD</h3><p>从OSD写请求返回后处理流程：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ReplicatedBackend::sub_op_modify_reply(OpRequestRef op)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">if</span> (in_progress_ops.count(rep_tid)) &#123;</span><br><span class="line">        ip_op.waiting_for_applied.erase(from);</span><br><span class="line">...</span><br><span class="line">        <span class="keyword">if</span> (ip_op.waiting_for_applied.empty() &amp;&amp;</span><br><span class="line">                ip_op.on_applied) &#123;</span><br><span class="line">            ip_op.on_applied-&gt;complete(<span class="number">0</span>);    <span class="comment">// C_OSD_RepOpApplied.finish()</span></span><br><span class="line">            ip_op.on_applied = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ip_op.waiting_for_commit.empty() &amp;&amp;</span><br><span class="line">                ip_op.on_commit) &#123;</span><br><span class="line">            ip_op.on_commit-&gt;complete(<span class="number">0</span>);    <span class="comment">// C_OSD_RepOpCommit.finish()</span></span><br><span class="line">            ip_op.on_commit= <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ip_op.done()) &#123;</span><br><span class="line">            assert(!ip_op.on_commit &amp;&amp; !ip_op.on_applied);</span><br><span class="line">            in_progress_ops.erase(iter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>C_OSD_RepOpCommit.finish()函数调用到：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ReplicatedPG::repop_all_committed(RepGather *repop)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    repop-&gt;all_committed = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!repop-&gt;rep_aborted) &#123;</span><br><span class="line">...</span><br><span class="line">        eval_repop(repop);  <span class="comment">// 返回reply给client端</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="sync数据到disk"><a href="#sync数据到disk" class="headerlink" title="sync数据到disk"></a>sync数据到disk</h2><p>filestore数据sync到disk(调底层fs的sync接口)：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileStore</span> :</span> <span class="keyword">public</span> JournalingObjectStore,</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">md_config_obs_t</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">SyncThread</span> :</span> <span class="keyword">public</span> Thread &#123;</span><br><span class="line">        FileStore *fs;</span><br><span class="line">        SyncThread(FileStore *f) : fs(f) &#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> *<span class="title">entry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            fs-&gt;sync_entry();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; sync_thread;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>FileStore::mount</code>方法中，会创建sync线程<code>sync_thread.create()</code>, 该线程的入口函数为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> FileStore::sync_entry()</span><br><span class="line">&#123;</span><br><span class="line">     <span class="keyword">utime_t</span> max_interval;</span><br><span class="line">     max_interval.set_from_double(m_filestore_max_sync_interval);   <span class="comment">// 参数可配</span></span><br><span class="line">     <span class="keyword">utime_t</span> min_interval;</span><br><span class="line">     min_interval.set_from_double(m_filestore_min_sync_interval);   <span class="comment">// 参数可配</span></span><br><span class="line">...</span><br><span class="line">     sync_cond.WaitInterval(g_ceph_context, lock, max_interval);    <span class="comment">// 等待interval时间</span></span><br><span class="line">     ...</span><br><span class="line">     <span class="keyword">if</span> (apply_manager.commit_start()) &#123;</span><br><span class="line">     ...</span><br><span class="line">     apply_manager.commit_started();</span><br><span class="line">     <span class="keyword">int</span> err = backend-&gt;syncfs();</span><br><span class="line">     err = write_op_seq(op_fd, cp);</span><br><span class="line">     err = ::fsync(op_fd);</span><br><span class="line">     apply_manager.commit_finish();</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要通过sync函数，将FileStore打开的文件进行数据的flush磁盘操作。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> GenericFileStoreBackend::syncfs()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">if</span> (m_filestore_fsync_flushes_journal_data) &#123;</span><br><span class="line">        ret = ::fsync(get_op_fd());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ret = sync_filesystem(get_current_fd());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>commit_finish会把commit_waiters加入finisher队列，由finisher函数通知commit完成：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> JournalingObjectStore::ApplyManager::commit_finish()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">if</span> (journal)</span><br><span class="line">        journal-&gt;committed_thru(committing_seq);</span><br><span class="line"></span><br><span class="line">    committed_seq = committing_seq;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="keyword">version_t</span>, <span class="built_in">vector</span>&lt;Context*&gt; &gt;::iterator p = commit_waiters.begin();</span><br><span class="line">    <span class="keyword">while</span> (p != commit_waiters.end() &amp;&amp;</span><br><span class="line">            p-&gt;first &lt;= committing_seq) &#123;</span><br><span class="line">        finisher.<span class="built_in">queue</span>(p-&gt;second);</span><br><span class="line">        commit_waiters.erase(p++);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>何时唤醒sync线程：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">— sync_cond.Signal();</span><br><span class="line"><span class="keyword">void</span> FileStore::_start_sync()                &lt;- <span class="keyword">unsigned</span> FileStore::_do_transaction() &#123;<span class="keyword">case</span> Transaction::OP_STARTSYNC:&#125;</span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">if</span> (!journal) &#123;</span><br><span class="line">      sync_cond.Signal();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> FileStore::do_force_sync()              &lt;- <span class="keyword">int</span> FileStore::umount()</span><br><span class="line"><span class="keyword">void</span> FileStore::start_sync(Context *onsafe)  &lt;- <span class="keyword">void</span> FileStore::sync()</span><br></pre></td></tr></table></figure>
<p>FileJournal的<code>do_sync_cond</code>也指向FileStore的sync_cond：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> FileStore::open_journal()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">        journal = <span class="keyword">new</span> FileJournal(fsid, &amp;finisher, &amp;sync_cond, journalpath.c_str(),</span><br><span class="line">                                  m_journal_dio, m_journal_aio, m_journal_force_aio);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FileJournal.Writer.entry()</span><br><span class="line">-&gt; FileJournal::write_thread_entry()</span><br><span class="line">-&gt; FileJournal::prepare_multi_write()</span><br><span class="line">-&gt; FileJournal::prepare_single_write()</span><br><span class="line">-&gt; FileJournal::check_for_full()</span><br><span class="line">&#123;</span><br><span class="line">     <span class="comment">// passing half full mark, triggering commit</span></span><br><span class="line">     do_sync_cond-&gt;SloppySignal();  <span class="comment">// initiate a real commit so we can trim</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ceph/" rel="tag">#ceph</a>
          
            <a href="/tags/filestore/" rel="tag">#filestore</a>
          
            <a href="/tags/osd/" rel="tag">#osd</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/08/06/2015-08-06-ceph-osd-write-op-tracker-analysis/" rel="prev">Ceph osd write op tracker analysis</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/06/12/2015-06-12-rgw-perf-with-memstore-cachetiering/" rel="next">RGW performance with MemStore and CacheTiering</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div>
      
        <style type="text/css">

    .donate_bar {
        text-align: center;
        margin-top : 5%;
    }

    .donate_bar.hidden {
        display:none;
    }
/*
    .donate_bar a.btn_donate {
        display: inline-block;
        width: 82px;
        height: 82px;
        margin-left:auto;
        margin-right:auto;

        background: url("http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif") no-repeat;
        _background: url("http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif") no-repeat; 

        -webkit-transition: background 0s;
        -moz-transition: background 0s;
        -o-transition: background 0s;
        -ms-transition: background 0s;
        transition: background 0s;
    }
*/
    .donate_bar a.btn_donate:hover { 
        // background-position: 0px -82px;
        color: #87daff;
    }

    .donate_bar .donate_txt {
        display: block;
        color: #9d9d9d;
        font: 14px/2 "Microsoft Yahei";
    }

    .bold { 
        font-weight: bold; 
    }

    .post-donate a {
        border-bottom: 0px;
    }

    #donate_guide table {
        border: none;
    }

    #donate_guide td {
        border-bottom: none;
        border-right: none;
        // background: #333333;
        valign: top;
    }

</style>



    

    <div class ="post-donate">
        <div id="donate_board" class="donate_bar center">
              <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏">赏</a>
              <span id="donate_txt" class="donate_txt">
                   
                        仅仅是一个功能
                   
              </span>
            <br>
        </div>  
  
        <div id="donate_guide" class="donate_bar center hidden">
            <!--
            
                <a href="http://o7keinrz4.bkt.clouddn.com/alipay.jpg" title="支付宝打赏" class="fancybox" rel="article0" 
                    style="float:left;margin-left:25%;margin-right:10px;">
                    <img src="http://o7keinrz4.bkt.clouddn.com/alipay.jpg" title="" height="164px" width="164px">
                </a> 
              

            
                <a href="http://o7keinrz4.bkt.clouddn.com/wechat.jpg" title="微信打赏" class="fancybox" rel="article0"
                    style="margin-right:30%">
                    <img src="http://o7keinrz4.bkt.clouddn.com/wechat.jpg" title="" height="164px" width="164px">
                </a>
            
            -->
            <table>
                <tr>
                    <td>
                        
                            <a href="http://o7keinrz4.bkt.clouddn.com/alipay.jpg" title="支付宝打赏" class="fancybox" rel="article0" 
                                style="float:left;margin-left:25%;margin-right:10px;">
                                <img src="http://o7keinrz4.bkt.clouddn.com/alipay.jpg" title="" height="164px" width="164px">
                            </a> 
                         
                    </td>
                    <td>
                        
                            <a href="http://o7keinrz4.bkt.clouddn.com/wechat.jpg" title="微信打赏" class="fancybox" rel="article0"
                                style="margin-right:30%">
                                <img src="http://o7keinrz4.bkt.clouddn.com/wechat.jpg" title="" height="164px" width="164px">
                            </a>
                        
                    </td>
                </tr>
            </table>

        </div>

        <script type="text/javascript">
            document.getElementById('btn_donate').onclick = function() {
                $('#donate_board').addClass('hidden');
                // $('#donate_guide').removeClass('hidden');
                $('#donate_guide').show(2000);
            }

        </script>
    </div>

    


      
    </div>

    <div class="post-spread">
      
        <div class="bdsharebuttonbox">
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
	<a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
	<a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a>
	<a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

      
    </div>
  </div>

 </div>

        

        
          <div class="comments" id="comments">
            
          </div>
        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table Of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="ictfox" itemprop="image"/>
          <p class="site-author-name" itemprop="name">ictfox</p>
        </div>
        <p class="site-description motion-element" itemprop="description">学无止境</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">71</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">10</span>
              <span class="site-state-item-name">categories</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">48</span>
              <span class="site-state-item-name">tags</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        <div class="links-of-friendly motion-element">
          
        </div>

        
        

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#OSD-Message示例分析"><span class="nav-number">1.</span> <span class="nav-text">OSD Message示例分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OSD-Message处理流程"><span class="nav-number">2.</span> <span class="nav-text">OSD Message处理流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Message在Primary-OSD的处理流程"><span class="nav-number">2.1.</span> <span class="nav-text">Message在Primary OSD的处理流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异步journal写数据"><span class="nav-number">2.2.</span> <span class="nav-text">异步journal写数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Message在Replica-OSD的处理流程"><span class="nav-number">2.3.</span> <span class="nav-text">Message在Replica OSD的处理流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#回调函数"><span class="nav-number">3.</span> <span class="nav-text">回调函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Primary-OSD"><span class="nav-number">3.1.</span> <span class="nav-text">Primary OSD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Replica-OSD"><span class="nav-number">3.2.</span> <span class="nav-text">Replica OSD</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Finisher类"><span class="nav-number">4.</span> <span class="nav-text">Finisher类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IO相关finisher"><span class="nav-number">4.1.</span> <span class="nav-text">IO相关finisher</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#写数据到FileStore和IO回调"><span class="nav-number">5.</span> <span class="nav-text">写数据到FileStore和IO回调</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Primary-OSD-1"><span class="nav-number">5.1.</span> <span class="nav-text">Primary OSD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Replica-OSD-1"><span class="nav-number">5.2.</span> <span class="nav-text">Replica OSD</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sync数据到disk"><span class="nav-number">6.</span> <span class="nav-text">sync数据到disk</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2018
  </span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ictfox
  </span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme by <a class="theme-link" href="http://blog.idhyt.com">idhyt</a>.<a class="theme-link" href="https://github.com/idhyt/hexo-theme-next/tree/magiclamp">Mala</a>
</div>

<!-- busuanzi -->



 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    
    

  


  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.1" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
