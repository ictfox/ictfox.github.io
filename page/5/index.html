<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="学无止境">
<meta property="og:type" content="website">
<meta property="og:title" content="ictfox blog">
<meta property="og:url" content="http://www.yangguanjun.com/page/5/index.html">
<meta property="og:site_name" content="ictfox blog">
<meta property="og:description" content="学无止境">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ictfox blog">
<meta name="twitter:description" content="学无止境">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.yangguanjun.com/page/5/"/>





  <title>ictfox blog</title>
  








  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-7472013512056838",
    enable_page_level_ads: true
  });
</script>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ictfox blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">ForTech</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yangguanjun.com/2017/05/15/Ceph-configuration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/15/Ceph-configuration/" itemprop="url">Ceph配置参数详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-15T19:31:17+08:00">
                2017-05-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ceph/" itemprop="url" rel="index">
                    <span itemprop="name">ceph</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/15/Ceph-configuration/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/05/15/Ceph-configuration/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Ceph的配置参数很多，从网上也能搜索到一大批的调优参数，但这些参数为什么这么设置？设置为这样是否合理？解释的并不多<br>本文从当前我们的ceph.conf文件入手，解释其中的每一项配置，做为以后参数调优和新人学习的依据；</p>
<h2 id="参数详解"><a href="#参数详解" class="headerlink" title="参数详解"></a>参数详解</h2><h3 id="1，一些固定配置参数"><a href="#1，一些固定配置参数" class="headerlink" title="1，一些固定配置参数"></a>1，一些固定配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fsid = 6d529c3d-5745-4fa5-be5f-3962a8e8687c</span><br><span class="line">mon_initial_members = mon1, mon2, mon3</span><br><span class="line">mon_host = 10.10.40.67,10.10.40.68,10.10.40.69</span><br></pre></td></tr></table></figure>
<p>以上通常是通过ceph-deploy生成的，都是ceph monitor相关的参数，不用修改；</p>
<h3 id="2，网络配置参数"><a href="#2，网络配置参数" class="headerlink" title="2，网络配置参数"></a>2，网络配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public_network = 10.10.40.0/24    默认值 <span class="string">""</span></span><br><span class="line">cluster_network = 10.10.41.0/24  默认值 <span class="string">""</span></span><br></pre></td></tr></table></figure>
<p>public network：monitor与osd，client与monitor，client与osd通信的网络，最好配置为带宽较高的万兆网络；<br>cluster network：OSD之间通信的网络，一般配置为带宽较高的万兆网络；</p>
<p><strong>参考：</strong><br><a href="http://docs.ceph.com/docs/master/rados/configuration/network-config-ref/" target="_blank" rel="noopener">http://docs.ceph.com/docs/master/rados/configuration/network-config-ref/</a></p>
<h3 id="3，pool-size配置参数"><a href="#3，pool-size配置参数" class="headerlink" title="3，pool size配置参数"></a>3，pool size配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">osd_pool_default_size = 3       默认值 3</span><br><span class="line">osd_pool_default_min_size = 1  默认值 0 // 0 means no specific default; ceph will use size-size/2</span><br></pre></td></tr></table></figure>
<p>这两个是创建ceph pool的时候的默认size参数，一般配置为3和1，3副本能足够保证数据的可靠性；</p>
<h3 id="4，认证配置参数"><a href="#4，认证配置参数" class="headerlink" title="4，认证配置参数"></a>4，认证配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">auth_service_required = none    默认值 <span class="string">"cephx"</span></span><br><span class="line">auth_client_required = none     默认值 <span class="string">"cephx, none"</span></span><br><span class="line">auth_cluster_required = none   默认值 <span class="string">"cephx"</span></span><br></pre></td></tr></table></figure>
<p>以上是Ceph authentication的配置参数，默认值为开启ceph认证；<br>在内部使用的ceph集群中一般配置为none，即不使用认证，这样能适当加快ceph集群访问速度；</p>
<h3 id="5，osd-down-out配置参数"><a href="#5，osd-down-out配置参数" class="headerlink" title="5，osd down out配置参数"></a>5，osd down out配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mon_osd_down_out_interval = 864000  默认值 300 // seconds</span><br><span class="line">mon_osd_min_down_reporters = 2      默认值 2</span><br><span class="line">mon_osd_report_timeout = 900        默认值 900</span><br><span class="line">osd_heartbeat_interval = 15         默认值 6</span><br><span class="line">osd_heartbeat_grace = 60            默认值 20</span><br></pre></td></tr></table></figure>
<p><code>mon_osd_down_out_interval</code>：ceph标记一个osd为down and out的最大时间间隔<br><code>mon_osd_min_down_reporters</code>：mon标记一个osd为down的最小reporters个数（报告该osd为down的其他osd为一个reporter）<br><code>mon_osd_report_timeout</code>：mon标记一个osd为down的最长等待时间<br><code>osd_heartbeat_interval</code>：osd发送heartbeat给其他osd的间隔时间（同一PG之间的osd才会有heartbeat）<br><code>osd_heartbeat_grace</code>：osd报告其他osd为down的最大时间间隔，grace调大，也有副作用，如果某个osd异常退出，等待其他osd上报的时间必须为grace，在这段时间段内，这个osd负责的pg的io会hang住，所以尽量不要将grace调的太大。</p>
<p>基于实际情况合理配置上述参数，能减少或及时发现osd变为down（降低IO hang住的时间和概率），延长osd变为down and out的时间（防止网络抖动造成的数据recovery）；</p>
<p><strong>参考：</strong><br><a href="http://docs.ceph.com/docs/master/rados/configuration/mon-osd-interaction/" target="_blank" rel="noopener">http://docs.ceph.com/docs/master/rados/configuration/mon-osd-interaction/</a><br><a href="http://blog.wjin.org/posts/ceph-osd-heartbeat.html" target="_blank" rel="noopener">http://blog.wjin.org/posts/ceph-osd-heartbeat.html</a></p>
<h3 id="6，objecter配置参数"><a href="#6，objecter配置参数" class="headerlink" title="6，objecter配置参数"></a>6，objecter配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objecter_inflight_ops = 10240               默认值 1024</span><br><span class="line">objecter_inflight_op_bytes = 1048576000     默认值 100M</span><br></pre></td></tr></table></figure>
<p>osd client端objecter的throttle配置，它的配置会影响librbd，RGW端的性能；</p>
<p><strong>配置建议：</strong><br>调大这两个值</p>
<h3 id="7，ceph-rgw配置参数"><a href="#7，ceph-rgw配置参数" class="headerlink" title="7，ceph rgw配置参数"></a>7，ceph rgw配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rgw_frontends = <span class="string">"civetweb port=10080 num_threads=2000"</span>  默认值 <span class="string">"fastcgi, civetweb port=7480"</span></span><br><span class="line">rgw_thread_pool_size = 512                              默认值 100</span><br><span class="line">rgw_override_bucket_index_max_shards = 20               默认值 0</span><br><span class="line"> </span><br><span class="line">rgw_max_chunk_size = 1048576                            默认值 512 * 1024</span><br><span class="line">rgw_cache_lru_size = 1000000                            默认值 10000 // num of entries <span class="keyword">in</span> rgw cache</span><br><span class="line">rgw_bucket_default_quota_max_objects = 10000000         默认值 -1 // number of objects allowed</span><br><span class="line">  </span><br><span class="line">rgw_dns_name = object-storage.ffan.com                  默认值</span><br><span class="line">rgw_swift_url = http://object-storage.ffan.com          默认值</span><br></pre></td></tr></table></figure>
<p><code>rgw_frontends</code>：rgw的前端配置，一般配置为使用轻量级的civetweb；prot为访问rgw的端口，根据实际情况配置；num_threads为civetweb的线程数；<br><code>rgw_thread_pool_size</code>：rgw前端web的线程数，与rgw_frontends中的num_threads含义一致，但num_threads 优于<code>rgw_thread_pool_size</code>的配置，两个只需要配置一个即可；<br><code>rgw_override_bucket_index_max_shards</code>：rgw bucket index object的最大shards数，增大这个值能减少bucket index object的访问时间，但也会加大bucket的ls时间；<br><code>rgw_max_chunk_size</code>：rgw最大chunk size，针对大文件的对象存储场景可以把这个值调大；<br><code>rgw_cache_lru_size</code>：rgw的lru cache size，对于读较多的应用场景，调大这个值能加快rgw的响应速度；<br><code>rgw_bucket_default_quota_max_objects</code>：配合该参数限制一个bucket的最大objects个数；</p>
<p><strong>参考：</strong><br><a href="http://docs.ceph.com/docs/jewel/install/install-ceph-gateway/" target="_blank" rel="noopener">http://docs.ceph.com/docs/jewel/install/install-ceph-gateway/</a><br><a href="http://ceph-users.ceph.narkive.com/mdB90g7R/rgw-increase-the-first-chunk-size" target="_blank" rel="noopener">http://ceph-users.ceph.narkive.com/mdB90g7R/rgw-increase-the-first-chunk-size</a><br><a href="https://access.redhat.com/solutions/2122231" target="_blank" rel="noopener">https://access.redhat.com/solutions/2122231</a></p>
<h3 id="8，debug配置参数"><a href="#8，debug配置参数" class="headerlink" title="8，debug配置参数"></a>8，debug配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">debug_lockdep = 0/0</span><br><span class="line">debug_context = 0/0</span><br><span class="line">debug_crush = 0/0</span><br><span class="line">debug_buffer = 0/0</span><br><span class="line">debug_timer = 0/0</span><br><span class="line">debug_filer = 0/0</span><br><span class="line">debug_objecter = 0/0</span><br><span class="line">debug_rados = 0/0</span><br><span class="line">debug_rbd = 0/0</span><br><span class="line">debug_journaler = 0/0</span><br><span class="line">debug_objectcatcher = 0/0</span><br><span class="line">debug_client = 0/0</span><br><span class="line">debug_osd = 0/0</span><br><span class="line">debug_optracker = 0/0</span><br><span class="line">debug_objclass = 0/0</span><br><span class="line">debug_filestore = 0/0</span><br><span class="line">debug_journal = 0/0</span><br><span class="line">debug_ms = 0/0</span><br><span class="line">debug_mon = 0/0</span><br><span class="line">debug_monc = 0/0</span><br><span class="line">debug_tp = 0/0</span><br><span class="line">debug_auth = 0/0</span><br><span class="line">debug_finisher = 0/0</span><br><span class="line">debug_heartbeatmap = 0/0</span><br><span class="line">debug_perfcounter = 0/0</span><br><span class="line">debug_asok = 0/0</span><br><span class="line">debug_throttle = 0/0</span><br><span class="line">debug_paxos = 0/0</span><br><span class="line">debug_rgw = 0/0</span><br></pre></td></tr></table></figure>
<p>关闭了所有的debug信息，能一定程度加快ceph集群速度，但也会丢失一些关键log，出问题的时候不好分析；</p>
<p><strong>参考：</strong><br><a href="http://www.10tiao.com/html/362/201609/2654062487/1.html" target="_blank" rel="noopener">http://www.10tiao.com/html/362/201609/2654062487/1.html</a></p>
<h3 id="9，osd-op配置参数"><a href="#9，osd-op配置参数" class="headerlink" title="9，osd op配置参数"></a>9，osd op配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">osd_enable_op_tracker = <span class="literal">false</span>       默认值 <span class="literal">true</span></span><br><span class="line">osd_num_op_tracker_shard = 32       默认值 32</span><br><span class="line">osd_op_threads = 10                 默认值 2</span><br><span class="line">osd_disk_threads = 1                默认值 1</span><br><span class="line">osd_op_num_shards = 32                 默认值 5</span><br><span class="line">osd_op_num_threads_per_shard = 2    默认值 2</span><br></pre></td></tr></table></figure>
<p><code>osd_enable_op_tracker</code>：追踪osd op状态的配置参数，默认为true；不建议关闭，关闭后osd的 slow_request，ops_in_flight，historic_ops 无法正常统计；</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ceph daemon /var/run/ceph/ceph-osd.0.asok dump_ops_in_flight</span></span><br><span class="line">op_tracker tracking is not enabled now, so no ops are tracked currently, even those get stuck.  Please <span class="built_in">enable</span> <span class="string">"osd_enable_op_tracker"</span>, and the tracker will start to track new ops received afterwards.</span><br><span class="line"><span class="comment"># ceph daemon /var/run/ceph/ceph-osd.0.asok dump_historic_ops</span></span><br><span class="line">op_tracker tracking is not enabled now, so no ops are tracked currently, even those get stuck.  Please <span class="built_in">enable</span> <span class="string">"osd_enable_op_tracker"</span>, and the tracker will start to track new ops received afterwards.</span><br></pre></td></tr></table></figure>
<p>打开op tracker后，若集群iops很高，<code>osd_num_op_tracker_shard</code>可以适当调大，因为每个shard都有个独立的mutex锁；</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OpTracker</span> &#123;</span></span><br><span class="line">...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ShardedTrackingData</span> &#123;</span></span><br><span class="line">        Mutex ops_in_flight_lock_sharded;</span><br><span class="line">        xlist&lt;TrackedOp *&gt; ops_in_flight_sharded;</span><br><span class="line">        explicit ShardedTrackingData(string lock_name):</span><br><span class="line">            ops_in_flight_lock_sharded(lock_name.c_str()) &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">vector</span>&lt;ShardedTrackingData*&gt; sharded_in_flight_list;</span><br><span class="line">    <span class="keyword">uint32_t</span> num_optracker_shards;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>osd_op_threads</code>：对应的work queue有<code>peering_wq</code>（osd peering请求），<code>recovery_gen_wq</code>（PG recovery请求）；<br><code>osd_disk_threads</code>：对应的work queue为 <code>remove_wq</code>（PG remove请求）；<br><code>osd_op_num_shards</code>和<code>osd_op_num_threads_per_shard</code>：对应的thread pool为<code>osd_op_tp</code>，work queue为<code>op_shardedwq</code>；</p>
<p>处理的请求包括：</p>
<ol>
<li><code>OpRequestRef</code></li>
<li><code>PGSnapTrim</code></li>
<li><code>PGScrub</code></li>
</ol>
<p>调大<code>osd_op_num_shards</code>可以增大osd ops的处理线程数，增大并发性，提升OSD性能；</p>
<h3 id="10，osd-client-message配置参数"><a href="#10，osd-client-message配置参数" class="headerlink" title="10，osd client message配置参数"></a>10，osd client message配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">osd_client_message_size_cap = 1048576000    默认值 500*1024L*1024L     // client data allowed <span class="keyword">in</span>-memory (<span class="keyword">in</span> bytes)</span><br><span class="line">osd_client_message_cap = 10000              默认值 100     // num client messages allowed <span class="keyword">in</span>-memory</span><br></pre></td></tr></table></figure>
<p>这个是osd端收到client messages的capacity配置，配置大的话能提升osd的处理能力，但会占用较多的系统内存；</p>
<p><strong>配置建议：</strong><br>服务器内存足够大的时候，适当增大这两个值</p>
<h3 id="11，osd-scrub配置参数"><a href="#11，osd-scrub配置参数" class="headerlink" title="11，osd scrub配置参数"></a>11，osd scrub配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">osd_scrub_begin_hour = 2                默认值 0</span><br><span class="line">osd_scrub_end_hour = 6                   默认值 24</span><br><span class="line"> </span><br><span class="line">// The time <span class="keyword">in</span> seconds that scrubbing sleeps between two consecutive scrubs</span><br><span class="line">osd_scrub_sleep = 2                       默认值 0        // sleep between [deep]scrub ops</span><br><span class="line"> </span><br><span class="line">osd_scrub_load_threshold = 5            默认值 0.5</span><br><span class="line">  </span><br><span class="line">// chunky scrub配置的最小/最大objects数，以下是默认值</span><br><span class="line">osd_scrub_chunk_min = 5</span><br><span class="line">osd_scrub_chunk_max = 25</span><br></pre></td></tr></table></figure>
<p>Ceph osd scrub是保证ceph数据一致性的机制，scrub以PG为单位，但每次scrub回获取PG lock，所以它可能会影响PG正常的IO；</p>
<p>Ceph后来引入了chunky的scrub模式，每次scrub只会选取PG的一部分objects，完成后释放PG lock，并把下一次的PG scrub加入队列；这样能很好的减少PG scrub时候占用PG lock的时间，避免过多影响PG正常的IO；</p>
<p>同理，引入的<code>osd_scrub_sleep</code>参数会让线程在每次scrub前释放PG lock，然后睡眠一段时间，也能很好的减少scrub对PG正常IO的影响；</p>
<p><strong>配置建议：</strong></p>
<ul>
<li><code>osd_scrub_begin_hour</code>和<code>osd_scrub_end_hour</code>：OSD Scrub的开始结束时间，根据具体业务指定；</li>
<li><code>osd_scrub_sleep</code>：osd在每次执行scrub时的睡眠时间；有个bug跟这个配置有关，建议关闭； </li>
<li><code>osd_scrub_load_threshold</code>：osd开启scrub的系统load阈值，根据系统的load average值配置该参数；</li>
<li><code>osd_scrub_chunk_min</code>和<code>osd_scrub_chunk_max</code>：根据PG中object的个数配置；针对RGW全是小文件的情况，这两个值需要调大；</li>
</ul>
<p><strong>参考：</strong><br><a href="http://www.jianshu.com/p/ea2296e1555c" target="_blank" rel="noopener">http://www.jianshu.com/p/ea2296e1555c</a><br><a href="http://tracker.ceph.com/issues/19497" target="_blank" rel="noopener">http://tracker.ceph.com/issues/19497</a></p>
<h3 id="12，osd-thread-timeout配置参数"><a href="#12，osd-thread-timeout配置参数" class="headerlink" title="12，osd thread timeout配置参数"></a>12，osd thread timeout配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">osd_op_thread_timeout = 580               默认值 15</span><br><span class="line">osd_op_thread_suicide_timeout = 600         默认值 150</span><br><span class="line"> </span><br><span class="line">osd_recovery_thread_timeout = 580           默认值 30</span><br><span class="line">osd_recovery_thread_suicide_timeout = 600   默认值 300</span><br></pre></td></tr></table></figure>
<p><code>osd_op_thread_timeout</code>和<code>osd_op_thread_suicide_timeout</code>关联的work queue为：</p>
<ul>
<li><code>op_shardedwq</code> - 关联的请求为：<code>OpRequestRef</code>，<code>PGSnapTrim</code>，<code>PGScrub</code></li>
<li><code>peering_wq</code> - 关联的请求为：osd peering</li>
</ul>
<p><code>osd_recovery_thread_timeout</code>和<code>osd_recovery_thread_suicide_timeout</code>关联的work queue为：</p>
<ul>
<li><code>recovery_wq</code> - 关联的请求为：PG recovery</li>
</ul>
<p>Ceph的work queue都有个基类<code>WorkQueue_</code>，定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Pool of threads that share work submitted to multiple work queues.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadPool</span> :</span> <span class="keyword">public</span> <span class="keyword">md_config_obs_t</span> &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="comment">/// Basic interface to a work queue used by the worker threads.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">WorkQueue_</span> &#123;</span></span><br><span class="line">        <span class="built_in">string</span> name;</span><br><span class="line">        <span class="keyword">time_t</span> timeout_interval, suicide_interval;</span><br><span class="line">        WorkQueue_(<span class="built_in">string</span> n, <span class="keyword">time_t</span> ti, <span class="keyword">time_t</span> sti)</span><br><span class="line">            : name(n), timeout_interval(ti), suicide_interval(sti)</span><br><span class="line">        &#123; &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这里的<code>timeout_interval</code>和<code>suicide_interval</code>分别对应上面所述的配置<code>timeout</code>和<code>suicide_timeout</code>；<br>当thread处理work queue中的一个请求时，会受到这两个timeout时间的限制：</p>
<ul>
<li><code>timeout_interval</code> - 到时间后设置<code>m_unhealthy_workers+1</code></li>
<li><code>suicide_interval</code> - 到时间后调用assert，OSD进程crush</li>
</ul>
<p>对应的处理函数为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> HeartbeatMap::_check(<span class="keyword">const</span> heartbeat_handle_d *h, <span class="keyword">const</span> <span class="keyword">char</span> *who, <span class="keyword">time_t</span> now)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">bool</span> healthy = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">time_t</span> was;</span><br><span class="line">    was = h-&gt;timeout.read();</span><br><span class="line">    <span class="keyword">if</span> (was &amp;&amp; was &lt; now) &#123;</span><br><span class="line">        ldout(m_cct, <span class="number">1</span>) &lt;&lt; who &lt;&lt; <span class="string">" '"</span> &lt;&lt; h-&gt;name &lt;&lt; <span class="string">"'"</span></span><br><span class="line">                        &lt;&lt; <span class="string">" had timed out after "</span> &lt;&lt; h-&gt;grace &lt;&lt; dendl;</span><br><span class="line">        healthy = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    was = h-&gt;suicide_timeout.read();</span><br><span class="line">    <span class="keyword">if</span> (was &amp;&amp; was &lt; now) &#123;</span><br><span class="line">        ldout(m_cct, <span class="number">1</span>) &lt;&lt; who &lt;&lt; <span class="string">" '"</span> &lt;&lt; h-&gt;name &lt;&lt; <span class="string">"'"</span></span><br><span class="line">                        &lt;&lt; <span class="string">" had suicide timed out after "</span> &lt;&lt; h-&gt;suicide_grace &lt;&lt; dendl;</span><br><span class="line">        assert(<span class="number">0</span> == <span class="string">"hit suicide timeout"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> healthy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当前仅有RGW添加了worker的perfcounter，所以也只有RGW可以通过perf dump查看total/unhealthy的worker信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ yangguanjun]<span class="comment"># ceph daemon /var/run/ceph/ceph-client.rgw.rgwdaemon.asok perf dump | grep worker</span></span><br><span class="line">        <span class="string">"total_workers"</span>: 32,</span><br><span class="line">        <span class="string">"unhealthy_workers"</span>: 0</span><br></pre></td></tr></table></figure>
<p>对应的配置项为：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">OPTION(rgw_num_async_rados_threads, OPT_INT, 32) // num of threads to use <span class="keyword">for</span> async rados operations</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">**配置建议：**</span><br><span class="line"></span><br><span class="line">- `*_thread_timeout`：这个值配置越小越能及时发现处理慢的请求，所以不建议配置很大；特别是针对速度快的设备，建议调小该值；</span><br><span class="line">- `*_thread_suicide_timeout`：这个值配置小了会导致超时后的OSD crush，所以建议调大；特别是在对应的throttle调大后，更应该调大该值；</span><br><span class="line"></span><br><span class="line"><span class="comment">### 13，fielstore op thread配置参数</span></span><br><span class="line">```sh</span><br><span class="line">filestore_op_threads = 10                   默认值 2</span><br><span class="line">filestore_op_thread_timeout = 580           默认值 60</span><br><span class="line">filestore_op_thread_suicide_timeout = 600   默认值 180</span><br></pre></td></tr></table></figure>
<p><code>filestore_op_threads</code>：对应的thread pool为<code>op_tp</code>，对应的work queue为<code>op_wq</code>；filestore的所有请求都经过op_wq处理；<br>增大该参数能提升filestore的处理能力，提升filestore的性能；配合filestore的throttle一起调整； </p>
<p><code>filestore_op_thread_timeout</code>和<code>filestore_op_thread_suicide_timeout</code>关联的work queue为：<code>op_wq</code></p>
<p>配置的含义与上一节中的<code>thread_timeout/thread_suicide_timeout</code>保持一致；</p>
<h3 id="13，filestore-merge-split配置参数"><a href="#13，filestore-merge-split配置参数" class="headerlink" title="13，filestore merge/split配置参数"></a>13，filestore merge/split配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filestore_merge_threshold = -1       默认值 10</span><br><span class="line">filestore_split_multiple = 16000      默认值 2</span><br></pre></td></tr></table></figure>
<p>这两个参数是管理filestore的目录分裂/合并的，filestore的每个目录允许的最大文件数为：<br><code>filestore_split_multiple * abs(filestore_merge_threshold) * 16</code></p>
<p>在RGW的小文件应用场景，会很容易达到默认配置的文件数（320），若在写的过程中触发了filestore的分裂，则会非常影响filestore的性能；</p>
<p>每次filestore的目录分裂，会依据如下规则分裂为多层目录，最底层16个子目录：<br>例如PG 31.4C0,   hash结尾是4C0，若该目录分裂，会分裂为 <code>DIR_0/DIR_C/DIR_4/{DIR_0, DIR_F}</code>；</p>
<p>原始目录下的object会根据规则放到不同的子目录里，object的名称格式为: <code>*__head_xxxxX4C0_*</code>，分裂时候X是几，就放进子目录DIR_X里。比如object：<code>*__head_xxxxA4C0_*</code>,  就放进子目录 <code>DIR_0/DIR_C/DIR_4/DIR_A</code> 里；</p>
<p><strong>解决办法：</strong></p>
<ol>
<li>增大merge/split配置参数的值，使单个目录容纳更多的文件；</li>
<li><code>filestore_merge_threshold</code>配置为负数；这样会提前触发目录的预分裂，避免目录在某一时间段的集中分裂，详细机制没有调研；</li>
<li>创建pool时指定<code>expected-num-objects</code>；这样会依据目录分裂规则，在创建pool的时候就创建分裂的子目录，避免了目录分裂对filestore性能的影响；</li>
</ol>
<p><strong>参考：</strong><br><a href="http://docs.ceph.com/docs/master/rados/configuration/filestore-config-ref/" target="_blank" rel="noopener">http://docs.ceph.com/docs/master/rados/configuration/filestore-config-ref/</a><br><a href="http://docs.ceph.com/docs/jewel/rados/operations/pools/#create-a-pool" target="_blank" rel="noopener">http://docs.ceph.com/docs/jewel/rados/operations/pools/#create-a-pool</a><br><a href="http://blog.csdn.net/for_tech/article/details/51251936" target="_blank" rel="noopener">http://blog.csdn.net/for_tech/article/details/51251936</a><br><a href="http://ivanjobs.github.io/page3/" target="_blank" rel="noopener">http://ivanjobs.github.io/page3/</a></p>
<h3 id="14，filestore-fd-cache配置参数"><a href="#14，filestore-fd-cache配置参数" class="headerlink" title="14，filestore fd cache配置参数"></a>14，filestore fd cache配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filestore_fd_cache_shards =  32     默认值 16     // FD number of shards</span><br><span class="line">filestore_fd_cache_size = 32768     默认值 128  // FD lru size</span><br></pre></td></tr></table></figure>
<p>filestore的fd cache是加速访问filestore里的file的，在非一次性写入的应用场景，增大配置可以很明显的提升filestore的性能；</p>
<h3 id="15，filestore-sync配置参数"><a href="#15，filestore-sync配置参数" class="headerlink" title="15，filestore sync配置参数"></a>15，filestore sync配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">filestore_wbthrottle_enable = <span class="literal">false</span>    默认值 <span class="literal">true</span>        SSD的时候建议关闭</span><br><span class="line">filestore_min_sync_interval = 5           默认值 0.01 s     最小同步间隔秒数，sync fs的数据到disk，FileStore::sync_entry()</span><br><span class="line">filestore_max_sync_interval = 10         默认值 5 s       最大同步间隔秒数，sync fs的数据到disk，FileStore::sync_entry()</span><br><span class="line">filestore_commit_timeout = 3000         默认值 600 s       FileStore::sync_entry() 里 new SyncEntryTimeout(m_filestore_commit_timeout)</span><br></pre></td></tr></table></figure>
<p><code>filestore_wbthrottle_enable</code>的配置是关于filestore writeback throttle的，即我们说的filestore处理workqueue <code>op_wq</code>的数据量阈值；默认值是true，开启后XFS相关的配置参数有：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">OPTION(filestore_wbthrottle_xfs_bytes_start_flusher, OPT_U64, <span class="number">41943040</span>)</span><br><span class="line">OPTION(filestore_wbthrottle_xfs_bytes_hard_limit, OPT_U64, <span class="number">419430400</span>)</span><br><span class="line">OPTION(filestore_wbthrottle_xfs_ios_start_flusher, OPT_U64, <span class="number">500</span>)</span><br><span class="line">OPTION(filestore_wbthrottle_xfs_ios_hard_limit, OPT_U64, <span class="number">5000</span>)</span><br><span class="line">OPTION(filestore_wbthrottle_xfs_inodes_start_flusher, OPT_U64, <span class="number">500</span>)</span><br><span class="line">OPTION(filestore_wbthrottle_xfs_inodes_hard_limit, OPT_U64, <span class="number">5000</span>)</span><br></pre></td></tr></table></figure>
<p>若使用普通HDD，可以保持其为true；针对SSD，建议将其关闭，不开启writeback throttle；</p>
<p><code>filestore_min_sync_interval</code>和<code>filestore_max_sync_interval</code>是配置filestore flush outstanding IO到disk的时间间隔的；增大配置可以让系统做尽可能多的IO merge，减少filestore写磁盘的压力，但也会增大page cache占用内存的开销，增大数据丢失的可能性；</p>
<p><code>filestore_commit_timeout</code>是配置filestore sync entry到disk的超时时间，在filestore压力很大时，调大这个值能尽量避免IO超时导致OSD crush；</p>
<h3 id="16，filestore-throttle配置参数"><a href="#16，filestore-throttle配置参数" class="headerlink" title="16，filestore throttle配置参数"></a>16，filestore throttle配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">filestore_expected_throughput_bytes =  536870912       默认值 200MB    /// Expected filestore throughput <span class="keyword">in</span> B/s</span><br><span class="line">filestore_expected_throughput_ops = 2500                默认值 200      /// Expected filestore throughput <span class="keyword">in</span> ops/s</span><br><span class="line">filestore_queue_max_bytes= 1048576000                   默认值 100MB</span><br><span class="line">filestore_queue_max_ops = 5000                          默认值 50</span><br><span class="line"> </span><br><span class="line">/// Use above to inject delays intended to keep the op queue between low and high</span><br><span class="line">filestore_queue_low_threshhold = 0.6                    默认值 0.3</span><br><span class="line">filestore_queue_high_threshhold = 0.9                   默认值 0.9</span><br><span class="line"> </span><br><span class="line">filestore_queue_high_delay_multiple = 2                    默认值 0    /// Filestore high delay multiple.  Defaults to 0 (disabled)</span><br><span class="line">filestore_queue_max_delay_multiple = 10                 默认值 0    /// Filestore max delay multiple.  Defaults to 0 (disabled)</span><br></pre></td></tr></table></figure>
<p>在jewel版本里，引入了dynamic throttle，来平滑普通throttle带来的长尾效应问题；</p>
<p>一般在使用普通磁盘时，之前的throttle机制即可很好的工作，所以这里默认<code>filestore_queue_high_delay_multiple</code>和<code>filestore_queue_max_delay_multiple</code>都为0；</p>
<p>针对高速磁盘，需要在部署之前，通过小工具<code>ceph_smalliobenchfs</code>来测试下，获取合适的配置参数；</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">BackoffThrottle的介绍如下：</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* BackoffThrottle</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Creates a throttle which gradually induces delays when get() is called</span></span><br><span class="line"><span class="comment">* based on params low_threshhold, high_threshhold, expected_throughput,</span></span><br><span class="line"><span class="comment">* high_multiple, and max_multiple.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* In [0, low_threshhold), we want no delay.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* In [low_threshhold, high_threshhold), delays should be injected based</span></span><br><span class="line"><span class="comment">* on a line from 0 at low_threshhold to</span></span><br><span class="line"><span class="comment">* high_multiple * (1/expected_throughput) at high_threshhold.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* In [high_threshhold, 1), we want delays injected based on a line from</span></span><br><span class="line"><span class="comment">* (high_multiple * (1/expected_throughput)) at high_threshhold to</span></span><br><span class="line"><span class="comment">* (high_multiple * (1/expected_throughput)) +</span></span><br><span class="line"><span class="comment">* (max_multiple * (1/expected_throughput)) at 1.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Let the current throttle ratio (current/max) be r, low_threshhold be l,</span></span><br><span class="line"><span class="comment">* high_threshhold be h, high_delay (high_multiple / expected_throughput) be e,</span></span><br><span class="line"><span class="comment">* and max_delay (max_muliple / expected_throughput) be m.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* delay = 0, r \in [0, l)</span></span><br><span class="line"><span class="comment">* delay = (r - l) * (e / (h - l)), r \in [l, h)</span></span><br><span class="line"><span class="comment">* delay = h + (r - h)((m - e)/(1 - h))</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p><strong>参考：</strong><br><a href="http://docs.ceph.com/docs/jewel/dev/osd_internals/osd_throttles/" target="_blank" rel="noopener">http://docs.ceph.com/docs/jewel/dev/osd_internals/osd_throttles/</a><br><a href="http://blog.wjin.org/posts/ceph-dynamic-throttle.html" target="_blank" rel="noopener">http://blog.wjin.org/posts/ceph-dynamic-throttle.html</a><br><a href="https://github.com/ceph/ceph/blob/master/src/doc/dynamic-throttle.txt" target="_blank" rel="noopener">https://github.com/ceph/ceph/blob/master/src/doc/dynamic-throttle.txt</a><br><a href="Ceph-BackoffThrottle.md">Ceph BackoffThrottle分析</a></p>
<h3 id="17，filestore-finisher-threads配置参数"><a href="#17，filestore-finisher-threads配置参数" class="headerlink" title="17，filestore finisher threads配置参数"></a>17，filestore finisher threads配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filestore_ondisk_finisher_threads = 2   默认值 1</span><br><span class="line">filestore_apply_finisher_threads = 2   默认值 1</span><br></pre></td></tr></table></figure>
<p>这两个参数定义filestore commit/apply的finisher处理线程数，默认都为1，任何IO commit/apply完成后，都需要经过对应的ondisk/apply finisher thread处理；</p>
<p>在使用普通HDD时，磁盘性能是瓶颈，单个finisher thread就能处理好；<br>但在使用高速磁盘的时候，IO完成比较快，单个finisher thread不能处理这么多的IO commit/apply reply，它会成为瓶颈；所以在jewel版本里引入了finisher thread pool的配置，这里一般配置为2即可；</p>
<h3 id="18，journal配置参数"><a href="#18，journal配置参数" class="headerlink" title="18，journal配置参数"></a>18，journal配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">journal_max_write_bytes=1048576000          默认值 10M    </span><br><span class="line">journal_max_write_entries=5000                默认值 100</span><br><span class="line"> </span><br><span class="line">journal_throttle_high_multiple = 2          默认值 0    /// Multiple over expected at high_threshhold. Defaults to 0 (disabled).</span><br><span class="line">journal_throttle_max_multiple = 10          默认值 0    /// Multiple over expected at max.  Defaults to 0 (disabled).</span><br><span class="line"></span><br><span class="line">/// Target range <span class="keyword">for</span> journal fullness</span><br><span class="line">OPTION(journal_throttle_low_threshhold, OPT_DOUBLE, 0.6)</span><br><span class="line">OPTION(journal_throttle_high_threshhold, OPT_DOUBLE, 0.9)</span><br></pre></td></tr></table></figure>
<p><code>journal_max_write_bytes</code>和<code>journal_max_write_entries</code>是journal一次write的数据量和entries限制；<br>针对SSD分区做journal的情况，这两个值要增大，这样能增大journal的吞吐量；</p>
<p><code>journal_throttle_high_multiple</code>和<code>journal_throttle_max_multiple</code>是<code>JournalThrottle</code>的配置参数，<code>JournalThrottle</code>是<code>BackoffThrottle</code>的封装类，所以<code>JournalThrottle</code>与我们在filestore throttle介绍的dynamic throttle工作原理一样；</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> FileJournal::set_throttle_params()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">stringstream</span> ss;</span><br><span class="line">    <span class="keyword">bool</span> valid = throttle.set_params(</span><br><span class="line">                     g_conf-&gt;journal_throttle_low_threshhold,</span><br><span class="line">                     g_conf-&gt;journal_throttle_high_threshhold,</span><br><span class="line">                     g_conf-&gt;filestore_expected_throughput_bytes,</span><br><span class="line">                     g_conf-&gt;journal_throttle_high_multiple,</span><br><span class="line">                     g_conf-&gt;journal_throttle_max_multiple,</span><br><span class="line">                     header.max_size - get_top(),</span><br><span class="line">                     &amp;ss);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上述代码中看出相关的配置参数有：</p>
<ul>
<li><code>journal_throttle_low_threshhold</code></li>
<li><code>journal_throttle_high_threshhold</code></li>
<li><code>filestore_expected_throughput_bytes</code></li>
</ul>
<h3 id="19，rbd-cache配置参数"><a href="#19，rbd-cache配置参数" class="headerlink" title="19，rbd cache配置参数"></a>19，rbd cache配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">rbd_cache_size = 134217728                  默认值 32M // cache size <span class="keyword">in</span> bytes</span><br><span class="line">rbd_cache_max_dirty = 100663296             默认值 24M // dirty <span class="built_in">limit</span> <span class="keyword">in</span> bytes - <span class="built_in">set</span> to 0 <span class="keyword">for</span> write-through caching</span><br><span class="line">rbd_cache_target_dirty = 67108864           默认值 16M // target dirty <span class="built_in">limit</span> <span class="keyword">in</span> bytes</span><br><span class="line">rbd_cache_writethrough_until_flush = <span class="literal">true</span>   默认值 <span class="literal">true</span>    // whether to make writeback caching writethrough until flush is called, to be sure the user of librbd will send flushs so that writeback is safe</span><br><span class="line">rbd_cache_max_dirty_age = 5                 默认值 1.0     // seconds <span class="keyword">in</span> cache before writeback starts</span><br></pre></td></tr></table></figure>
<p><code>rbd_cache_size</code>：client端每个rbd image的cache size，不需要太大，可以调整为64M，不然会比较占client端内存；<br>参照默认值，根据<code>rbd_cache_size</code>的大小调整<code>rbd_cache_max_dirty</code>和<code>rbd_cache_target_dirty</code>；</p>
<ul>
<li><code>rbd_cache_max_dirty</code>：在writeback模式下cache的最大bytes数，默认是24MB；当该值为0时，表示使用writethrough模式；</li>
<li><code>rbd_cache_target_dirty</code>：在writeback模式下cache向ceph集群写入的bytes阀值，默认16MB；注意该值一定要小于<code>rbd_cache_max_dirty</code>值</li>
</ul>
<p><code>rbd_cache_writethrough_until_flush</code>：在内核触发flush cache到ceph集群前rbd cache一直是writethrough模式，直到flush后rbd cache变成writeback模式；<br><code>rbd_cache_max_dirty_age</code>：标记OSDC端ObjectCacher中entry在cache中的最长时间；</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://my.oschina.net/linuxhunter/blog/541997" target="_blank" rel="noopener">https://my.oschina.net/linuxhunter/blog/541997</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yangguanjun.com/2017/05/09/rgw-multi-region/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/09/rgw-multi-region/" itemprop="url">对象存储跨机房容灾调研</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-09T15:31:37+08:00">
                2017-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ceph/" itemprop="url" rel="index">
                    <span itemprop="name">ceph</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/09/rgw-multi-region/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/05/09/rgw-multi-region/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>随着机房的增加和客户对可靠性的要求提高，我们需要提供数据的跨机房容灾，本文档结合Ceph Radosgw的实现描述对象存储的跨机房容灾。</p>
<h2 id="当前状况"><a href="#当前状况" class="headerlink" title="当前状况"></a>当前状况</h2><p>当前应用中，每个机房的Ceph都是独立的cluster，彼此之间没有任何关系。</p>
<p>多个机房都独立的提供对象存储功能，每个Ceph Radosgw都有自己独立的命名空间和存储空间。</p>
<h3 id="这样带来两个问题："><a href="#这样带来两个问题：" class="headerlink" title="这样带来两个问题："></a>这样带来两个问题：</h3><p>1，针对Radosgw来说，我们的业务没法提供统一的命名空间；</p>
<p>2，没有机房级别的容灾，若一个机房Radosgw无法访问，则机房提供的对象存储瘫痪；</p>
<h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><p>针对上述中的情况和需求，Ceph的Radosgw原生支持的联合架构，支持Region，Zone级别的备份同步，能很好的解决这个问题。</p>
<h3 id="Ceph要求"><a href="#Ceph要求" class="headerlink" title="Ceph要求"></a>Ceph要求</h3><ul>
<li>版本Ceph version 0.67以后即可，我们当前使用的0.94.5支持该feature</li>
<li>每个Ceph cluster必须配置启动RADOSGW</li>
</ul>
<h3 id="概念解释"><a href="#概念解释" class="headerlink" title="概念解释"></a>概念解释</h3><ul>
<li>Region: A region represents a logical geographic area and contains one or more zones. A cluster with multiple regions must specify a master region.</li>
<li>Zone: A zone is a logical grouping of one or more Ceph Object Gateway instance(s). A region has a master zone that processes client requests.<br>注：Only write objects to the master zone in a region. You may read objects from secondary zones. Currently, the Gateway does not prevent you from writing to a secondary zone, but DON’T DO IT.</li>
</ul>
<h3 id="应用模式1"><a href="#应用模式1" class="headerlink" title="应用模式1"></a>应用模式1</h3><p>同一Region内的不同Zones之间数据同步，如下图所示：</p>
<p><img src="/images/rgw-multi-region1.jpg" alt="rgw-multi-region1"></p>
<p><strong>特点：</strong></p>
<ul>
<li>主zone支持读写操作</li>
<li>从zone支持读操作</li>
<li>主从zone之间同步数据</li>
</ul>
<p><strong>用途：</strong></p>
<ul>
<li>主从zone之间数据备份，提供跨机房容灾</li>
<li>从zone分担主zone的读数据压力，提高集群扩展性</li>
</ul>
<h3 id="应用模式2"><a href="#应用模式2" class="headerlink" title="应用模式2"></a>应用模式2</h3><p>不同Regions之间的数据同步，如下图所示：</p>
<p><img src="/images/rgw-multi-region2.jpg" alt="rgw-multi-region2"></p>
<p><strong>特点：</strong></p>
<ul>
<li>主从Region都支持读写操作</li>
<li>主从Region之间只同步元数据信息</li>
<li>主从Region之间数据是独立的</li>
</ul>
<p><strong>用途：</strong></p>
<ul>
<li>多个Regions一起来提供统一命名空间</li>
<li>不同Region服务不同地区的客户，提高集群扩展性</li>
</ul>
<h3 id="展望"><a href="#展望" class="headerlink" title="展望"></a>展望</h3><p>在10.2 jewel版本中，radosgw增加了一个新特性，也就是多中心同步。 </p>
<p>所谓多中心同步，也就是不同radosgw实例之间可以自动进行同步的特性。</p>
<p>为了便于管理，又进行了逻辑上的组织，也即realm、zonegroup、zone和radosgw。这是个从上至下的组织结构，也就是realm包括若干个zonegroup，其中一个是master，其它是secondary。每个zonegroup下包括一个master zone，其它都是secondary zone。</p>
<p>zone可以认为是一个实际上的集群，由至少一个radosgw实例提供服务，但是对外服务地址是一致的。 </p>
<p>同步分两种，也就是元数据同步和数据同步。zonegroup之间只会同步元数据，而同一个zonegroup下的zone之间是同步元数据和数据。这里的元数据是指用户和桶，数据是用户的对象数据。</p>
<h4 id="概念："><a href="#概念：" class="headerlink" title="概念："></a>概念：</h4><ul>
<li>Zone: A zone is logical grouping of one or more Ceph Object Gateway instances. There will be one Zone that should be designated as the master zone in a zonegroup, which will handle all bucket and user creation.</li>
<li>Zonegroup: A zonegroup consists of multiple zones, this approximately corresponds to what used to be called as a region in pre Jewel releases for federated deployments. There should be a master zonegroup that will handle changes to the system configuration.</li>
<li>Zonegroup map: A zonegroup map is a configuration structure that holds the map of the entire system, ie. which zonegroup is the master, relationships between different zonegroups and certain configurables like storage policies.</li>
<li>Realm: A realm is a container for zonegroups, this allows for separation of zonegroups themselves between clusters. It is possible to create multiple realms, making it easier to run completely different configurations in the same cluster.</li>
<li>Period: A period holds the configuration structure for the current state of the realm. Every period contains a unique id and an epoch. A period’s epoch is incremented on every commit operation. Every realm has an associated current period, holding the current state of configuration of the zonegroups and storage policies. Any configuration change for a non master zone will increment the period’s epoch. Changing the master zone to a different zone will trigger the following changes: - A new period is generated with a new period id and epoch of 1 - Realm’s current period is updated to point to the newly generated period id - Realm’s epoch is incremented</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://docs.ceph.com/docs/master/radosgw/federated-config/" target="_blank" rel="noopener">http://docs.ceph.com/docs/master/radosgw/federated-config/</a></p>
<p><a href="http://qinghua.github.io/ceph-radosgw-replication/" target="_blank" rel="noopener">http://qinghua.github.io/ceph-radosgw-replication/</a></p>
<p><a href="http://www.cnphp6.com/archives/79981" target="_blank" rel="noopener">http://www.cnphp6.com/archives/79981</a></p>
<p><a href="http://lyang.top/2016/01/18/Radosgw-%E5%A4%9A-zone-%E9%83%A8%E7%BD%B2%E4%BB%A5%E5%8F%8A-radosgw_agent-%E5%90%8C%E6%AD%A5/" target="_blank" rel="noopener">http://lyang.top/2016/01/18/Radosgw-%E5%A4%9A-zone-%E9%83%A8%E7%BD%B2%E4%BB%A5%E5%8F%8A-radosgw_agent-%E5%90%8C%E6%AD%A5/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yangguanjun.com/2017/05/08/rgw-user-config-datapool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/08/rgw-user-config-datapool/" itemprop="url">radosgw配置user使用指定data pool</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-08T15:31:37+08:00">
                2017-05-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ceph/" itemprop="url" rel="index">
                    <span itemprop="name">ceph</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/08/rgw-user-config-datapool/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/05/08/rgw-user-config-datapool/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在使用radosgw提供s3服务的时候，有时候我们会需要指定user使用不同的data pool，或者不同的data index pool；</p>
<p>在Jewel版本里，我们可以通过配置placement target来实现；</p>
<p>首先介绍下Jewel版本里radosgw的几个概念：</p>
<table>
<thead>
<tr>
<th>缩略语</th>
<th>全称</th>
</tr>
</thead>
<tbody>
<tr>
<td>Realm</td>
<td>域，同一域内的账户在其下属的zone上是通用的。一个域下只能有一个主zonegroup，从的zonegroup可以是0或多个。</td>
</tr>
<tr>
<td>Period</td>
<td>表示域的有效期，在域的结构发生变化时，其Period会相应变化。</td>
</tr>
<tr>
<td>Zonegroup</td>
<td>Zone的集合，等价于之前的Region。一个Zonegroup下只能有一个主Zone。主Zone和从Zone可以部署在同一集群上，也可以部署在不同的集群上。</td>
</tr>
<tr>
<td>Zone</td>
<td>表示独立的一个对象存储区域。</td>
</tr>
</tbody>
</table>
<h2 id="代码解析"><a href="#代码解析" class="headerlink" title="代码解析"></a>代码解析</h2><h3 id="zone-placement"><a href="#zone-placement" class="headerlink" title="zone placement"></a>zone placement</h3><p>Radosgw里的user bucket数据存放哪里，是有user里的placement确定的，每个placement info可以指定三个pool，如下所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RGWZonePlacementInfo</span> &#123;</span></span><br><span class="line">    <span class="built_in">string</span> index_pool;</span><br><span class="line">    <span class="built_in">string</span> data_pool;</span><br><span class="line">    <span class="built_in">string</span> data_extra_pool; <span class="comment">/* if not set we should use data_pool */</span></span><br><span class="line">    RGWBucketIndexType index_type;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每个zone里可以用多个placement，定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RGWZoneParams</span> :</span> RGWSystemMetaObj &#123;</span><br><span class="line">    rgw_bucket domain_root;</span><br><span class="line">    rgw_bucket metadata_heap;</span><br><span class="line">    rgw_bucket control_pool;        <span class="comment">// 每个zone里的下面一些pool是只能配置一个的</span></span><br><span class="line">    rgw_bucket gc_pool;</span><br><span class="line">    rgw_bucket log_pool;</span><br><span class="line">    rgw_bucket intent_log_pool;</span><br><span class="line">    rgw_bucket usage_log_pool;</span><br><span class="line">    rgw_bucket user_keys_pool;</span><br><span class="line">    rgw_bucket user_email_pool;</span><br><span class="line">    rgw_bucket user_swift_pool;</span><br><span class="line">    rgw_bucket user_uid_pool;</span><br><span class="line">    RGWAccessKey system_key;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="built_in">string</span>, RGWZonePlacementInfo&gt; placement_pools;    <span class="comment">// zone里支持配置多个placement</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="zonegroup-placement"><a href="#zonegroup-placement" class="headerlink" title="zonegroup placement"></a>zonegroup placement</h3><p>zonegroup里的placement target的定义如下，每个zonegroup可以配置多个placement targets，每个placement targets有name，tags（对应user info里的配置）标识；</p>
<p>这里的placement target name都对应着zone placement_pools里的string 关键字；</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RGWZoneGroupPlacementTarget</span> &#123;</span></span><br><span class="line">    <span class="built_in">string</span> name;</span><br><span class="line">    <span class="built_in">set</span>&lt;<span class="built_in">string</span>&gt; tags; <span class="comment">// 可以有多个tags，对应RGWUserInfo里的placement_tags</span></span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RGWZoneGroup</span> :</span> <span class="keyword">public</span> RGWSystemMetaObj &#123;</span><br><span class="line">    <span class="built_in">string</span> api_name;</span><br><span class="line">    <span class="built_in">list</span>&lt;<span class="built_in">string</span>&gt; endpoints;</span><br><span class="line">    <span class="keyword">bool</span> is_master;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">string</span> master_zone;</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="built_in">string</span>, RGWZone&gt; zones;       <span class="comment">// 配置多个zones</span></span><br><span class="line"> </span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="built_in">string</span>, RGWZoneGroupPlacementTarget&gt; placement_targets;       <span class="comment">// zonegroup支持配置多个placement targets</span></span><br><span class="line">    <span class="built_in">string</span> default_placement;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="user-info"><a href="#user-info" class="headerlink" title="user info"></a>user info</h3><p>在每个user里，可以配置default placement，也支持配置多个placement tags；</p>
<p>user支持在创建bucket的时候指定placement；</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RGWUserInfo</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> auid;</span><br><span class="line">    rgw_user user_id;</span><br><span class="line">...</span><br><span class="line">    <span class="built_in">string</span> default_placement;       <span class="comment">// 指定默认的placement</span></span><br><span class="line">    <span class="built_in">list</span>&lt;<span class="built_in">string</span>&gt; placement_tags;  <span class="comment">// tags里的值需配置为placement target里tags集合里的值</span></span><br><span class="line">...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h2><p>下面通过增加一个test的placement target，让rgw user miketest使用pool default.rgw.buckets.data.tst 作为其bucket的data pool；</p>
<h3 id="创建pool"><a href="#创建pool" class="headerlink" title="创建pool"></a>创建pool</h3><p>根据需要通过ceph osd pool 命令创建要使用的pool，例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ceph osd pool create default.rgw.buckets.data.tst 1024 1024</span></span><br><span class="line"><span class="comment"># ceph osd pool set &lt;poolname&gt; crush_ruleset 2    // 根据需要配置pool的crush rule</span></span><br></pre></td></tr></table></figure>
<h3 id="添加zone的placement"><a href="#添加zone的placement" class="headerlink" title="添加zone的placement"></a>添加zone的placement</h3><p>可以先list下当前的zone的placement</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># radosgw-admin zone placement list  --rgw-zone=default</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"key"</span>: <span class="string">"default-placement"</span>,</span><br><span class="line">        <span class="string">"val"</span>: &#123;</span><br><span class="line">            <span class="string">"index_pool"</span>: <span class="string">"default.rgw.buckets.index"</span>,</span><br><span class="line">            <span class="string">"data_pool"</span>: <span class="string">"default.rgw.buckets.data"</span>,</span><br><span class="line">            <span class="string">"data_extra_pool"</span>: <span class="string">"default.rgw.buckets.non-ec"</span>,</span><br><span class="line">            <span class="string">"index_type"</span>: 0</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>zone添加placement的命令如下（指定zone placement的各个pool）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># radosgw-admin zone placement add --rgw-zone=default --placement-id=test --index_pool=default.rgw.buckets.index --data_pool=default.rgw.buckets.data.tst --data_extra_pool=default.rgw.buckets.non-ec</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"key"</span>: <span class="string">"default-placement"</span>,</span><br><span class="line">        <span class="string">"val"</span>: &#123;</span><br><span class="line">            <span class="string">"index_pool"</span>: <span class="string">"default.rgw.buckets.index"</span>,</span><br><span class="line">            <span class="string">"data_pool"</span>: <span class="string">"default.rgw.buckets.data"</span>,</span><br><span class="line">            <span class="string">"data_extra_pool"</span>: <span class="string">"default.rgw.buckets.non-ec"</span>,</span><br><span class="line">            <span class="string">"index_type"</span>: 0</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"key"</span>: <span class="string">"test"</span>,</span><br><span class="line">        <span class="string">"val"</span>: &#123;</span><br><span class="line">            <span class="string">"index_pool"</span>: <span class="string">"default.rgw.buckets.index"</span>,</span><br><span class="line">            <span class="string">"data_pool"</span>: <span class="string">"default.rgw.buckets.data.tst"</span>,    // 这里仅仅指定了data_pool为新的pool</span><br><span class="line">            <span class="string">"data_extra_pool"</span>: <span class="string">"default.rgw.buckets.non-ec"</span>,</span><br><span class="line">            <span class="string">"index_type"</span>: 0</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>也可以通过如下命令来添加zone的placement：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># radosgw-admin zone get --rgw-zone=default &gt; zone.info</span></span><br><span class="line"><span class="comment"># vim zone.info     // 添加 key为test的placement</span></span><br><span class="line"><span class="comment"># radosgw-admin zone set --rgw-zone=default &lt; zone.info</span></span><br></pre></td></tr></table></figure>
<h3 id="添加zonegroup的placement"><a href="#添加zonegroup的placement" class="headerlink" title="添加zonegroup的placement"></a>添加zonegroup的placement</h3><p>查看当前的zonegroup的placement</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># radosgw-admin zonegroup placement list</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"key"</span>: <span class="string">"default-placement"</span>,</span><br><span class="line">        <span class="string">"val"</span>: &#123;</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"default-placement"</span>,</span><br><span class="line">            <span class="string">"tags"</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>zonegroup添加新的placement</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># radosgw-admin zonegroup placement add --rgw-zonegroup=default --placement-id=test</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"key"</span>: <span class="string">"default-placement"</span>,</span><br><span class="line">        <span class="string">"val"</span>: &#123;</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"default-placement"</span>,</span><br><span class="line">            <span class="string">"tags"</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"key"</span>: <span class="string">"test"</span>,</span><br><span class="line">        <span class="string">"val"</span>: &#123;</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"test"</span>,</span><br><span class="line">            <span class="string">"tags"</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="更新user-info"><a href="#更新user-info" class="headerlink" title="更新user info"></a>更新user info</h3><p>查看user的信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># radosgw-admin user info --uid=miketest</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"user_id"</span>: <span class="string">"miketest"</span>,</span><br><span class="line">    <span class="string">"display_name"</span>: <span class="string">"miketest"</span>,</span><br><span class="line">    <span class="string">"email"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"suspended"</span>: 0,</span><br><span class="line">    <span class="string">"max_buckets"</span>: 1000,</span><br><span class="line">    <span class="string">"auid"</span>: 0,</span><br><span class="line">    <span class="string">"subusers"</span>: [],</span><br><span class="line">    <span class="string">"keys"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"user"</span>: <span class="string">"miketest"</span>,</span><br><span class="line">            <span class="string">"access_key"</span>: <span class="string">"7J82YY2ODPQ22337N392"</span>,</span><br><span class="line">            <span class="string">"secret_key"</span>: <span class="string">"IgRmuo11OrxRlWa7TEicHSbbUFNYP2MDwZ8St2PS"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"swift_keys"</span>: [],</span><br><span class="line">    <span class="string">"caps"</span>: [],</span><br><span class="line">    <span class="string">"op_mask"</span>: <span class="string">"read, write, delete"</span>,</span><br><span class="line">    <span class="string">"default_placement"</span>: <span class="string">"default-placement"</span>,</span><br><span class="line">    <span class="string">"placement_tags"</span>: [</span><br><span class="line">        <span class="string">"default-placement"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"bucket_quota"</span>: &#123;</span><br><span class="line">        <span class="string">"enabled"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"max_size_kb"</span>: -1,</span><br><span class="line">        <span class="string">"max_objects"</span>: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"user_quota"</span>: &#123;</span><br><span class="line">        <span class="string">"enabled"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"max_size_kb"</span>: -1,</span><br><span class="line">        <span class="string">"max_objects"</span>: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"temp_url_keys"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>导出user info，修改后导入新的信息，添加新的placement_tags：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># radosgw-admin metadata get user:miketest &gt; miketest.userinfo</span></span><br><span class="line"><span class="comment"># vim miketest.userinfo</span></span><br><span class="line"><span class="comment"># radosgw-admin metadata put user:miketest &lt; miketest.userinfo</span></span><br><span class="line"><span class="comment"># radosgw-admin user info --uid=miketest</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"user_id"</span>: <span class="string">"miketest"</span>,</span><br><span class="line">    <span class="string">"display_name"</span>: <span class="string">"miketest"</span>,</span><br><span class="line">    <span class="string">"email"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"suspended"</span>: 0,</span><br><span class="line">    <span class="string">"max_buckets"</span>: 1000,</span><br><span class="line">    <span class="string">"auid"</span>: 0,</span><br><span class="line">    <span class="string">"subusers"</span>: [],</span><br><span class="line">    <span class="string">"keys"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"user"</span>: <span class="string">"miketest"</span>,</span><br><span class="line">            <span class="string">"access_key"</span>: <span class="string">"7J82YY2ODPQ22337N392"</span>,</span><br><span class="line">            <span class="string">"secret_key"</span>: <span class="string">"IgRmuo11OrxRlWa7TEicHSbbUFNYP2MDwZ8St2PS"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"swift_keys"</span>: [],</span><br><span class="line">    <span class="string">"caps"</span>: [],</span><br><span class="line">    <span class="string">"op_mask"</span>: <span class="string">"read, write, delete"</span>,</span><br><span class="line">    <span class="string">"default_placement"</span>: <span class="string">"default-placement"</span>,   // 这里也可以配置default为 <span class="built_in">test</span> placement</span><br><span class="line">    <span class="string">"placement_tags"</span>: [</span><br><span class="line">        <span class="string">"default-placement"</span>,</span><br><span class="line">        <span class="string">"test"</span>          // 添加了名为<span class="built_in">test</span>的placement</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"bucket_quota"</span>: &#123;</span><br><span class="line">        <span class="string">"enabled"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"max_size_kb"</span>: -1,</span><br><span class="line">        <span class="string">"max_objects"</span>: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"user_quota"</span>: &#123;</span><br><span class="line">        <span class="string">"enabled"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"max_size_kb"</span>: -1,</span><br><span class="line">        <span class="string">"max_objects"</span>: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"temp_url_keys"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="更新zonegroup-map"><a href="#更新zonegroup-map" class="headerlink" title="更新zonegroup map"></a>更新zonegroup map</h3><p>更新完zonegroup的placement后，虽说也可以查看到新的placement，但这些并没有更新到zonegroup map里；</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># radosgw-admin zonegroup placement list</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"key"</span>: <span class="string">"default-placement"</span>,</span><br><span class="line">        <span class="string">"val"</span>: &#123;</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"default-placement"</span>,</span><br><span class="line">            <span class="string">"tags"</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"key"</span>: <span class="string">"test"</span>,</span><br><span class="line">        <span class="string">"val"</span>: &#123;</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"test"</span>,</span><br><span class="line">            <span class="string">"tags"</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">  </span><br><span class="line"><span class="comment"># radosgw-admin zonegroup-map get</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"zonegroups"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"key"</span>: <span class="string">"342414eb-ee98-40b9-b9d5-971ad14d2dd0"</span>,</span><br><span class="line">            <span class="string">"val"</span>: &#123;</span><br><span class="line">                <span class="string">"id"</span>: <span class="string">"342414eb-ee98-40b9-b9d5-971ad14d2dd0"</span>,</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"default"</span>,</span><br><span class="line">                <span class="string">"api_name"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="string">"is_master"</span>: <span class="string">"true"</span>,</span><br><span class="line">                <span class="string">"endpoints"</span>: [],</span><br><span class="line">                <span class="string">"hostnames"</span>: [],</span><br><span class="line">                <span class="string">"hostnames_s3website"</span>: [],</span><br><span class="line">                <span class="string">"master_zone"</span>: <span class="string">"f31f020f-aaa2-4570-b6f7-19258064e5b5"</span>,</span><br><span class="line">                <span class="string">"zones"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"id"</span>: <span class="string">"f31f020f-aaa2-4570-b6f7-19258064e5b5"</span>,</span><br><span class="line">                        <span class="string">"name"</span>: <span class="string">"default"</span>,</span><br><span class="line">                        <span class="string">"endpoints"</span>: [],</span><br><span class="line">                        <span class="string">"log_meta"</span>: <span class="string">"false"</span>,</span><br><span class="line">                        <span class="string">"log_data"</span>: <span class="string">"false"</span>,</span><br><span class="line">                        <span class="string">"bucket_index_max_shards"</span>: 0,</span><br><span class="line">                        <span class="string">"read_only"</span>: <span class="string">"false"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">"placement_targets"</span>: [  // 看到这里并没有新加的<span class="built_in">test</span> placement</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"name"</span>: <span class="string">"default-placement"</span>,</span><br><span class="line">                        <span class="string">"tags"</span>: []</span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">"default_placement"</span>: <span class="string">"default-placement"</span>,</span><br><span class="line">                <span class="string">"realm_id"</span>: <span class="string">"7eeb01eb-3774-4abe-ba93-c205cc3c83af"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"master_zonegroup"</span>: <span class="string">"342414eb-ee98-40b9-b9d5-971ad14d2dd0"</span>,</span><br><span class="line">    <span class="string">"bucket_quota"</span>: &#123;</span><br><span class="line">        <span class="string">"enabled"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"max_size_kb"</span>: -1,</span><br><span class="line">        <span class="string">"max_objects"</span>: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"user_quota"</span>: &#123;</span><br><span class="line">        <span class="string">"enabled"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"max_size_kb"</span>: -1,</span><br><span class="line">        <span class="string">"max_objects"</span>: -1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行zonegroup map更新：<code>radosgw-admin period update --commit</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># radosgw-admin period update --commit</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"id"</span>: <span class="string">"bd50c829-f7eb-4aa9-ad0a-efa814dfc3cc"</span>,</span><br><span class="line">    <span class="string">"epoch"</span>: 2,</span><br><span class="line">    <span class="string">"predecessor_uuid"</span>: <span class="string">"da2e2b0d-a17a-46fb-8369-6cb373ffd08d"</span>,</span><br><span class="line">    <span class="string">"sync_status"</span>: [</span><br><span class="line">...</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"period_map"</span>: &#123;</span><br><span class="line">        <span class="string">"id"</span>: <span class="string">"bd50c829-f7eb-4aa9-ad0a-efa814dfc3cc"</span>,</span><br><span class="line">        <span class="string">"zonegroups"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"id"</span>: <span class="string">"342414eb-ee98-40b9-b9d5-971ad14d2dd0"</span>,</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"default"</span>,</span><br><span class="line">                <span class="string">"api_name"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="string">"is_master"</span>: <span class="string">"true"</span>,</span><br><span class="line">                <span class="string">"endpoints"</span>: [],</span><br><span class="line">                <span class="string">"hostnames"</span>: [],</span><br><span class="line">                <span class="string">"hostnames_s3website"</span>: [],</span><br><span class="line">                <span class="string">"master_zone"</span>: <span class="string">"f31f020f-aaa2-4570-b6f7-19258064e5b5"</span>,</span><br><span class="line">                <span class="string">"zones"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"id"</span>: <span class="string">"f31f020f-aaa2-4570-b6f7-19258064e5b5"</span>,</span><br><span class="line">                        <span class="string">"name"</span>: <span class="string">"default"</span>,</span><br><span class="line">                        <span class="string">"endpoints"</span>: [],</span><br><span class="line">                        <span class="string">"log_meta"</span>: <span class="string">"true"</span>,</span><br><span class="line">                        <span class="string">"log_data"</span>: <span class="string">"false"</span>,</span><br><span class="line">                        <span class="string">"bucket_index_max_shards"</span>: 0,</span><br><span class="line">                        <span class="string">"read_only"</span>: <span class="string">"false"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">"placement_targets"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"name"</span>: <span class="string">"default-placement"</span>,</span><br><span class="line">                        <span class="string">"tags"</span>: []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"name"</span>: <span class="string">"test"</span>, // 更新后有 <span class="built_in">test</span> placement</span><br><span class="line">                        <span class="string">"tags"</span>: []</span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">"default_placement"</span>: <span class="string">"default-placement"</span>,</span><br><span class="line">                <span class="string">"realm_id"</span>: <span class="string">"7eeb01eb-3774-4abe-ba93-c205cc3c83af"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"short_zone_ids"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"key"</span>: <span class="string">"f31f020f-aaa2-4570-b6f7-19258064e5b5"</span>,</span><br><span class="line">                <span class="string">"val"</span>: 568702538</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"master_zonegroup"</span>: <span class="string">"342414eb-ee98-40b9-b9d5-971ad14d2dd0"</span>,</span><br><span class="line">    <span class="string">"master_zone"</span>: <span class="string">"f31f020f-aaa2-4570-b6f7-19258064e5b5"</span>,</span><br><span class="line">    <span class="string">"period_config"</span>: &#123;</span><br><span class="line">        <span class="string">"bucket_quota"</span>: &#123;</span><br><span class="line">            <span class="string">"enabled"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">"max_size_kb"</span>: -1,</span><br><span class="line">            <span class="string">"max_objects"</span>: -1</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"user_quota"</span>: &#123;</span><br><span class="line">            <span class="string">"enabled"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">"max_size_kb"</span>: -1,</span><br><span class="line">            <span class="string">"max_objects"</span>: -1</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"realm_id"</span>: <span class="string">"7eeb01eb-3774-4abe-ba93-c205cc3c83af"</span>,</span><br><span class="line">    <span class="string">"realm_name"</span>: <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"realm_epoch"</span>: 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="重启radosgw服务"><a href="#重启radosgw服务" class="headerlink" title="重启radosgw服务"></a>重启radosgw服务</h3><p>重启radosgw服务，Centos里的命令为：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl restart ceph-radosgw.target</span></span><br></pre></td></tr></table></figure>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>通过s3cmd就可以测试，命令如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">✗ s3cmd mb s3://foxtst --bucket-location=:<span class="built_in">test</span></span><br><span class="line">Bucket <span class="string">'s3://foxtst/'</span> created</span><br><span class="line">✗ s3cmd put pg_by_osd.sh s3://foxtst</span><br></pre></td></tr></table></figure>
<p>在ceph集群里，可以查看到上传的文件<code>pg_by_osd.sh</code>在指定的pool里：<code>default.rgw.buckets.data.tst</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rados ls -p default.rgw.buckets.data.tst</span></span><br><span class="line">f31f020f-aaa2-4570-b6f7-19258064e5b5.1224751.1_pg_by_osd.sh</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://docs.ceph.com/docs/jewel/radosgw/multisite/" target="_blank" rel="noopener">http://docs.ceph.com/docs/jewel/radosgw/multisite/</a><br><a href="http://www.jianshu.com/p/31a6f8df9a8f" target="_blank" rel="noopener">http://www.jianshu.com/p/31a6f8df9a8f</a><br><a href="http://ceph.org.cn/2017/03/24/ceph-rgwj%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%E7%9A%84%E7%94%A8%E6%88%B7placement%E8%AE%BE%E7%BD%AE-by_%E7%A7%A6%E7%89%A7%E7%BE%8A/" target="_blank" rel="noopener">http://ceph.org.cn/2017/03/24/ceph-rgwj%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%E7%9A%84%E7%94%A8%E6%88%B7placement%E8%AE%BE%E7%BD%AE-by_%E7%A7%A6%E7%89%A7%E7%BE%8A/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yangguanjun.com/2017/05/02/Ceph-OSD-op_shardedwq/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/02/Ceph-OSD-op_shardedwq/" itemprop="url">Ceph OSD op_shardedwq分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-02T11:31:17+08:00">
                2017-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ceph/" itemprop="url" rel="index">
                    <span itemprop="name">ceph</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/02/Ceph-OSD-op_shardedwq/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/05/02/Ceph-OSD-op_shardedwq/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Ceph OSD处理OP，snap trim，scrub的是相同的work queue - <code>osd::op_shardedwq</code></p>
<p>研究该shardedwq，有利于我们对snap trim和scrub的配置参数调整；</p>
<h2 id="相关数据结构"><a href="#相关数据结构" class="headerlink" title="相关数据结构"></a>相关数据结构</h2><p>这里主要涉及到两个数据结构：</p>
<ol>
<li><code>class PGQueueable</code></li>
<li><code>class ShardedOpWQ</code></li>
</ol>
<h3 id="class-PGQueueable"><a href="#class-PGQueueable" class="headerlink" title="class PGQueueable"></a>class PGQueueable</h3><p>这个是封装PG一些请求的class，相关的操作有：</p>
<ol>
<li><code>OpRequestRef</code></li>
<li><code>PGSnapTrim</code></li>
<li><code>PGScrub</code></li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PGQueueable</span> &#123;</span></span><br><span class="line">    <span class="keyword">typedef</span> boost::variant&lt;</span><br><span class="line">    OpRequestRef,</span><br><span class="line">    PGSnapTrim,</span><br><span class="line">    PGScrub</span><br><span class="line">    &gt; QVariant;   <span class="comment">// 定义队列处理的三种请求</span></span><br><span class="line">    </span><br><span class="line">    QVariant qvariant;</span><br><span class="line">    <span class="keyword">int</span> cost;</span><br><span class="line">    <span class="keyword">unsigned</span> priority;</span><br><span class="line">    <span class="keyword">utime_t</span> start_time;</span><br><span class="line">    <span class="keyword">entity_inst_t</span> owner;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">RunVis</span> :</span> <span class="keyword">public</span> boost::static_visitor&lt;&gt; &#123;</span><br><span class="line">        OSD *osd;</span><br><span class="line">        PGRef &amp;pg;</span><br><span class="line">        ThreadPool::TPHandle &amp;handle;</span><br><span class="line">        RunVis(OSD *osd, PGRef &amp;pg, ThreadPool::TPHandle &amp;handle)</span><br><span class="line">            : osd(osd), pg(pg), handle(handle) &#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(OpRequestRef &amp;op)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(PGSnapTrim &amp;op)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(PGScrub &amp;op)</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// cppcheck-suppress noExplicitConstructor</span></span><br><span class="line">    PGQueueable(OpRequestRef op)    <span class="comment">// 处理OpRequest</span></span><br><span class="line">        : qvariant(op), cost(op-&gt;get_req()-&gt;get_cost()),</span><br><span class="line">          priority(op-&gt;get_req()-&gt;get_priority()),</span><br><span class="line">          start_time(op-&gt;get_req()-&gt;get_recv_stamp()),</span><br><span class="line">          owner(op-&gt;get_req()-&gt;get_source_inst())</span><br><span class="line">    &#123;&#125;</span><br><span class="line">    PGQueueable(       <span class="comment">// 处理PGSnapTrim</span></span><br><span class="line">        <span class="keyword">const</span> PGSnapTrim &amp;op, <span class="keyword">int</span> cost, <span class="keyword">unsigned</span> priority, <span class="keyword">utime_t</span> start_time,</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">entity_inst_t</span> &amp;owner)</span><br><span class="line">        : qvariant(op), cost(cost), priority(priority), start_time(start_time),</span><br><span class="line">          owner(owner) &#123;&#125;</span><br><span class="line">    PGQueueable(       <span class="comment">// 处理PGScrub</span></span><br><span class="line">        <span class="keyword">const</span> PGScrub &amp;op, <span class="keyword">int</span> cost, <span class="keyword">unsigned</span> priority, <span class="keyword">utime_t</span> start_time,</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">entity_inst_t</span> &amp;owner)</span><br><span class="line">        : qvariant(op), cost(cost), priority(priority), start_time(start_time),</span><br><span class="line">          owner(owner) &#123;&#125;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(OSD *osd, PGRef &amp;pg, ThreadPool::TPHandle &amp;handle)</span> </span>&#123;</span><br><span class="line">        <span class="function">RunVis <span class="title">v</span><span class="params">(osd, pg, handle)</span></span>;</span><br><span class="line">        boost::apply_visitor(v, qvariant);</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="class-ShardedOpWQ"><a href="#class-ShardedOpWQ" class="headerlink" title="class ShardedOpWQ"></a>class ShardedOpWQ</h3><p>这个是OSD中shard相关线程的work queue类，用来处理<code>PGQueueable</code>封装的三类PG操作；</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OSD</span> :</span> <span class="keyword">public</span> Dispatcher, <span class="keyword">public</span> <span class="keyword">md_config_obs_t</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">PGQueueable</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ShardedOpWQ</span>:</span> <span class="keyword">public</span> ShardedThreadPool::ShardedWQ &lt; pair &lt;PGRef, PGQueueable&gt; &gt; &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ShardData</span> &#123;</span></span><br><span class="line">            Mutex sdata_lock;</span><br><span class="line">            Cond sdata_cond;</span><br><span class="line">            Mutex sdata_op_ordering_lock;</span><br><span class="line">            <span class="built_in">map</span>&lt;PG*, <span class="built_in">list</span>&lt;PGQueueable&gt; &gt; pg_for_processing;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;OpQueue&lt; pair&lt;PGRef, PGQueueable&gt;, <span class="keyword">entity_inst_t</span>&gt;&gt; pqueue;</span><br><span class="line">            ShardData(</span><br><span class="line">                <span class="built_in">string</span> lock_name, <span class="built_in">string</span> ordering_lock,</span><br><span class="line">                <span class="keyword">uint64_t</span> max_tok_per_prio, <span class="keyword">uint64_t</span> min_cost, CephContext *cct,</span><br><span class="line">                io_queue opqueue)</span><br><span class="line">                : sdata_lock(lock_name.c_str(), <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">false</span>, cct),</span><br><span class="line">                  sdata_op_ordering_lock(ordering_lock.c_str(), <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">false</span>, cct) &#123;</span><br><span class="line">                <span class="keyword">if</span> (opqueue == weightedpriority) &#123;</span><br><span class="line">                    pqueue = <span class="built_in">std</span>::<span class="built_in">unique_ptr</span></span><br><span class="line">                             &lt;WeightedPriorityQueue&lt; pair&lt;PGRef, PGQueueable&gt;, <span class="keyword">entity_inst_t</span>&gt;&gt;(</span><br><span class="line">                                 <span class="keyword">new</span> WeightedPriorityQueue&lt; pair&lt;PGRef, PGQueueable&gt;, <span class="keyword">entity_inst_t</span>&gt;(</span><br><span class="line">                                     max_tok_per_prio, min_cost));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opqueue == prioritized) &#123;</span><br><span class="line">                    pqueue = <span class="built_in">std</span>::<span class="built_in">unique_ptr</span></span><br><span class="line">                             &lt;PrioritizedQueue&lt; pair&lt;PGRef, PGQueueable&gt;, <span class="keyword">entity_inst_t</span>&gt;&gt;(</span><br><span class="line">                                 <span class="keyword">new</span> PrioritizedQueue&lt; pair&lt;PGRef, PGQueueable&gt;, <span class="keyword">entity_inst_t</span>&gt;(</span><br><span class="line">                                     max_tok_per_prio, min_cost));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"> </span><br><span class="line">        <span class="built_in">vector</span>&lt;ShardData*&gt; shard_list;</span><br><span class="line">        OSD *osd;</span><br><span class="line">        <span class="keyword">uint32_t</span> num_shards;   <span class="comment">// 值为cct-&gt;_conf-&gt;osd_op_num_shards</span></span><br><span class="line">...</span><br><span class="line">        <span class="keyword">void</span> _process(<span class="keyword">uint32_t</span> thread_index, heartbeat_handle_d *hb);</span><br><span class="line">        <span class="keyword">void</span> _enqueue(pair &lt;PGRef, PGQueueable&gt; item);</span><br><span class="line">        <span class="keyword">void</span> _enqueue_front(pair &lt;PGRef, PGQueueable&gt; item);</span><br><span class="line">...</span><br><span class="line">    &#125; op_shardedwq;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>op_shardedwq</code>对应的thread pool为：<code>osd_op_tp</code></p>
<p><code>osd_op_tp</code>的初始化在OSD的初始化类中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">osd_op_tp(cct, <span class="string">"OSD::osd_op_tp"</span>, <span class="string">"tp_osd_tp"</span>,</span><br><span class="line">          cct-&gt;_conf-&gt;osd_op_num_threads_per_shard * cct-&gt;_conf-&gt;osd_op_num_shards),</span><br></pre></td></tr></table></figure>
<p>这里相关的配置参数有：</p>
<ol>
<li><code>osd_op_num_threads_per_shard</code>，默认值为 2</li>
<li><code>osd_op_num_shards</code>，默认值为 5</li>
</ol>
<p>PG会根据一定的映射模式映射到不同的shard上，然后由该shard对应的thread处理请求；</p>
<h2 id="ShardedOpWQ的处理函数"><a href="#ShardedOpWQ的处理函数" class="headerlink" title="ShardedOpWQ的处理函数"></a>ShardedOpWQ的处理函数</h2><p>该sharded的work queue的process函数如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> OSD::ShardedOpWQ::_process(<span class="keyword">uint32_t</span> thread_index, heartbeat_handle_d *hb ) </span><br><span class="line">&#123;</span><br><span class="line">    pair&lt;PGRef, PGQueueable&gt; item = sdata-&gt;pqueue-&gt;dequeue();</span><br><span class="line"> </span><br><span class="line">    boost::optional&lt;PGQueueable&gt; op;</span><br><span class="line">    (item.first)-&gt;lock_suspend_timeout(tp_handle);    <span class="comment">// 获取pg lock</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    op-&gt;run(osd, item.first, tp_handle);    <span class="comment">// 根据不同类型操作调用不同函数</span></span><br><span class="line">...</span><br><span class="line">    (item.first)-&gt;unlock();    <span class="comment">// 释放pg lock</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面可以看出在调用实际的处理函数前，就先获取了PG lock；处理返回后释放PG lock；</p>
<p><code>osd::opshardedwq</code>的_process()函数会根据request的类型，调用不同的函数处理：</p>
<ol>
<li><code>OSD::dequeue_op()</code></li>
<li><code>ReplicatedPG::snap_trimmer()</code></li>
<li><code>PG::scrub()</code></li>
</ol>
<p>在文件osd/OSD.cc中有这三类操作的不同处理函数定义：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> PGQueueable::RunVis::<span class="keyword">operator</span>()(OpRequestRef &amp;op) &#123;</span><br><span class="line">    <span class="keyword">return</span> osd-&gt;dequeue_op(pg, op, handle);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">void</span> PGQueueable::RunVis::<span class="keyword">operator</span>()(PGSnapTrim &amp;op) &#123;</span><br><span class="line">    <span class="keyword">return</span> pg-&gt;snap_trimmer(op.epoch_queued);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">void</span> PGQueueable::RunVis::<span class="keyword">operator</span>()(PGScrub &amp;op) &#123;</span><br><span class="line">    <span class="keyword">return</span> pg-&gt;scrub(op.epoch_queued, handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="OSD操作的处理函数"><a href="#OSD操作的处理函数" class="headerlink" title="OSD操作的处理函数"></a>OSD操作的处理函数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* <span class="doctag">NOTE:</span> dequeue called in worker thread, with pg lock</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> OSD::dequeue_op(</span><br><span class="line">    PGRef pg, OpRequestRef op,</span><br><span class="line">    ThreadPool::TPHandle &amp;handle)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    op-&gt;mark_reached_pg();</span><br><span class="line">    pg-&gt;do_request(op, handle); <span class="comment">// PG op处理函数</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">##<span class="meta"># snap trim的处理函数</span></span><br><span class="line"></span><br><span class="line">```c++</span><br><span class="line"><span class="keyword">void</span> ReplicatedPG::snap_trimmer(<span class="keyword">epoch_t</span> queued)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_conf-&gt;osd_snap_trim_sleep &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        unlock(); <span class="comment">// 释放pg lock</span></span><br><span class="line">        <span class="keyword">utime_t</span> t;</span><br><span class="line">        t.set_from_double(g_conf-&gt;osd_snap_trim_sleep);</span><br><span class="line">        t.sleep();   <span class="comment">// sleep osd_snap_trim_sleep 秒</span></span><br><span class="line">        lock();      <span class="comment">// 获取pg lock</span></span><br><span class="line">        dout(<span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">" slept for "</span> &lt;&lt; t &lt;&lt; dendl;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">if</span> (is_primary()) &#123;</span><br><span class="line">...</span><br><span class="line">        snap_trimmer_machine.process_event(SnapTrim());</span><br><span class="line">...</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_active() &amp;&amp;</span><br><span class="line">               last_complete_ondisk.epoch &gt; info.history.last_epoch_started) &#123;</span><br><span class="line">        <span class="comment">// replica collection trimming</span></span><br><span class="line">        snap_trimmer_machine.process_event(SnapTrim());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PG-scrub的处理函数"><a href="#PG-scrub的处理函数" class="headerlink" title="PG scrub的处理函数"></a>PG scrub的处理函数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Scrub:</span></span><br><span class="line"><span class="comment">* PG_STATE_SCRUBBING is set when the scrub is queued</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* scrub will be chunky if all OSDs in PG support chunky scrub</span></span><br><span class="line"><span class="comment">* scrub will fail if OSDs are too old.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> PG::scrub(<span class="keyword">epoch_t</span> queued, ThreadPool::TPHandle &amp;handle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_conf-&gt;osd_scrub_sleep &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">            (scrubber.state == PG::Scrubber::NEW_CHUNK ||</span><br><span class="line">             scrubber.state == PG::Scrubber::INACTIVE)) &#123;</span><br><span class="line">        dout(<span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">" state is INACTIVE|NEW_CHUNK, sleeping"</span> &lt;&lt; dendl;</span><br><span class="line">        unlock();        <span class="comment">// 释放pg lock</span></span><br><span class="line">        <span class="keyword">utime_t</span> t;</span><br><span class="line">        t.set_from_double(g_conf-&gt;osd_scrub_sleep);</span><br><span class="line">        handle.suspend_tp_timeout();</span><br><span class="line">        t.sleep();       <span class="comment">// sleep osd_scrub_sleep 秒</span></span><br><span class="line">        handle.reset_tp_timeout();</span><br><span class="line">        lock();      <span class="comment">// 获取pg lock</span></span><br><span class="line">        dout(<span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">" slept for "</span> &lt;&lt; t &lt;&lt; dendl;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line">    chunky_scrub(handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="Ceph-PG-lock的粒度"><a href="#Ceph-PG-lock的粒度" class="headerlink" title="Ceph PG lock的粒度"></a>Ceph PG lock的粒度</h3><p>从函数<code>OSD::ShardedOpWQ::_process()</code>中看出，thread在区分具体的PG请求前就获取了PG lock，在return前释放PG lock；这个PG lock的粒度还是挺大的，若snap trim和scrub占用了PG lock太久，会影响到OSD PG正常的IO操作；</p>
<p>OSD PG相关的OP类型有（<code>OSD::dequeue_op()</code>函数处理）：</p>
<ul>
<li><code>CEPH_MSG_OSD_OP</code></li>
<li><code>MSG_OSD_SUBOP</code></li>
<li><code>MSG_OSD_SUBOPREPLY</code></li>
<li><code>MSG_OSD_PG_BACKFILL</code></li>
<li><code>MSG_OSD_REP_SCRUB</code></li>
<li><code>MSG_OSD_PG_UPDATE_LOG_MISSING</code></li>
<li><code>MSG_OSD_PG_UPDATE_LOG_MISSING_REPLY</code></li>
</ul>
<h3 id="osd-snap-trim-sleep和osd-scrub-sleep配置"><a href="#osd-snap-trim-sleep和osd-scrub-sleep配置" class="headerlink" title="osd_snap_trim_sleep和osd_scrub_sleep配置"></a><code>osd_snap_trim_sleep</code>和<code>osd_scrub_sleep</code>配置</h3><p>从上面看<code>g_conf-&gt;osd_snap_trim_sleep</code>和<code>g_conf-&gt;osd_scrub_sleep</code>配置为非0后，能让snap trim和scrub在每次执行前睡眠一段时间（不是random时间），这样能一定程度上降低这两个操作对PG IO ops的影响（获取PG lock）；</p>
<p>如果设置了<code>osd_snap_trim_sleep</code>或<code>osd_scrub_sleep</code>为非0，处理的线程会sleep，这样虽说释放了PG lock，但是占用了一个PG的一个处理线程，所以才有贴出来的ceph bug - <a href="http://tracker.ceph.com/issues/19497" target="_blank" rel="noopener">http://tracker.ceph.com/issues/19497</a></p>
<p>现在我们配置的是：</p>
<ol>
<li><code>osd_op_num_shards = 30</code></li>
<li><code>osd_op_num_threads_per_shard = 2</code>    //默认值</li>
</ol>
<p>所以一旦某个shard对应的一个thread被占用了，对应处理该shard的只有一个thread了，这样就有可能影响映射到该shard上的PG的正常IO了。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://blog.wjin.org/posts/ceph-scrub-mechanism.html" target="_blank" rel="noopener">http://blog.wjin.org/posts/ceph-scrub-mechanism.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yangguanjun.com/2017/04/16/ceph-monitor-with-grafana/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/16/ceph-monitor-with-grafana/" itemprop="url">Diamond+Graphite+Grafana部署Ceph监控</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-16T11:11:17+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ceph/" itemprop="url" rel="index">
                    <span itemprop="name">ceph</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/16/ceph-monitor-with-grafana/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/04/16/ceph-monitor-with-grafana/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Ceph的监控有很多，基于实际需求和调研，我们决定使用Diamond+Graphite+Grafana部署Ceph的监控，它可以很直观的看到Ceph的信息，便于做Ceph系统的性能分析；</p>
<ul>
<li><p>Diamond<br>  基于python开发的收集系统metrics的工具，包含cpu，disk，network等系统基本信息，也可以定制化开发收集特定的metrics； <a href="https://github.com/python-diamond/Diamond" target="_blank" rel="noopener">https://github.com/python-diamond/Diamond</a></p>
</li>
<li><p>Graphite<br>  一个Python编写的企业级开源监控工具，它本身不负责收集数据； <a href="http://graphite.readthedocs.io/en/latest/overview.html" target="_blank" rel="noopener">http://graphite.readthedocs.io/en/latest/overview.html</a></p>
</li>
<li><p>Grafana<br>  一款采用go 语言编写的开源应用，主要用于大规模指标数据的可视化展现，基于商业友好的Apache License 2.0 开源协议；界面和定制化较Graphite强很多，支持Graphite作为其数据源； <a href="https://github.com/grafana/grafana" target="_blank" rel="noopener">https://github.com/grafana/grafana</a></p>
</li>
</ul>
<h2 id="定制化"><a href="#定制化" class="headerlink" title="定制化"></a>定制化</h2><p>针对需求，我们可以disable/enable dimaond的一些监控项，也可以写python代码定制化自己的监控项。</p>
<p>我们的修改如下：</p>
<ol>
<li>编写了Diamond，Graphite，Grafana的部署脚本</li>
<li>定制化了Diamond的Ceph系统监控</li>
<li>配置了cpu，disk，network的监控项</li>
</ol>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>部署一个Ceph监控系统，需要两类节点：</p>
<ol>
<li>Diamond运行的节点：收集metrics</li>
<li>Graphite+Grafana运行的节点：存储各个Diamond节点收集的metrics，提供可视化指标数据的展示</li>
</ol>
<h2 id="展示"><a href="#展示" class="headerlink" title="展示"></a>展示</h2><p>Grafana上可以根据需求定制化模板，我们定制后的Ceph集群监控界面如下图：</p>
<p><img src="/images/grafana-show.jpg" alt="grafana show"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yangguanjun.com/2017/03/10/redis-cluster-trove/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/10/redis-cluster-trove/" itemprop="url">Redis集群方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-10T20:31:17+08:00">
                2017-03-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/trove/" itemprop="url" rel="index">
                    <span itemprop="name">trove</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/10/redis-cluster-trove/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/03/10/redis-cluster-trove/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Redis 3.0版本中加入集群的功能，但3.0版本一直在2015年才发布正式版。各大企业在3.0版本还没发布前为了解决Redis的存储瓶颈，纷纷推出了各自的Redis集群方案。</p>
<p>这些方案的核心思想是把数据分片（sharding）存储在多个Redis实例中，每一片就是一个Redis实例。下面介绍Redis的集群方案。</p>
<h2 id="集群方案"><a href="#集群方案" class="headerlink" title="集群方案"></a>集群方案</h2><h3 id="客户端分片"><a href="#客户端分片" class="headerlink" title="客户端分片"></a>客户端分片</h3><p>客户端分片是把分片的逻辑放在Redis客户端实现，通过Redis客户端预先定义好的路由规则，把对Key的访问转发到不同的Redis实例中，最后把返回结果汇集。</p>
<p>这种方案的模式如下图所示：</p>
<p><img src="/images/redis-cluster-trove1.jpg" alt="image1"></p>
<p>客户端分片的优点：</p>
<ul>
<li>所有的逻辑都是可控的，不依赖于第三方分布式中间件</li>
<li><p>开发人员清楚怎么实现分片、路由的规则，不用担心踩坑<br>客户端分片的缺点：</p>
</li>
<li><p>这是一种静态的分片方案，需要增加或者减少Redis实例的数量，需要手工调整分片的程序。</p>
</li>
<li>可运维性差，集群的数据出了任何问题都需要运维人员和开发人员一起合作，减缓了解决问题的速度，增加了跨部门沟通的成本。</li>
<li>在不同的客户端程序中，维护相同的分片逻辑成本巨大。</li>
</ul>
<h3 id="Twemproxy"><a href="#Twemproxy" class="headerlink" title="Twemproxy"></a>Twemproxy</h3><p>Twemproxy是由Twitter开源的Redis代理，其基本原理是：Redis客户端把请求发送到Twemproxy，Twemproxy根据路由规则发送到正确的Redis实例，最后Twemproxy把结果汇集返回给客户端。</p>
<p>Twemproxy通过引入一个代理层，将多个Redis实例进行统一管理，使Redis客户端只需要在Twemproxy上进行操作，而不需要关心后面有多少个Redis实例，从而实现了Redis集群。</p>
<p>Twemproxy集群架构如下图所示：</p>
<p><img src="/images/redis-cluster-trove2.jpg" alt="twemproxy"></p>
<p>Twemproxy的优点：</p>
<ul>
<li>客户端像连接Redis实例一样连接Twemproxy，不需要改任何的代码逻辑</li>
<li>支持无效Redis实例的自动删除</li>
<li><p>Twemproxy与Redis实例保持连接，减少了客户端与Redis实例的连接数<br>Twemproxy的缺点：</p>
</li>
<li><p>由于Redis客户端的每个请求都经过Twemproxy代理才能到达Redis服务器，这个过程中会产生性能损失</p>
</li>
<li>没有友好的监控管理后台界面，不利于运维监控</li>
<li>最大的问题是Twemproxy无法平滑地增加Redis实例，对于运维人员来说，当因为业务需要增加Redis实例时工作量非常大<br>Twemproxy作为最被广泛使用、最久经考验、稳定性最高的Redis代理，在业界被广泛使用。</li>
</ul>
<h3 id="Codis"><a href="#Codis" class="headerlink" title="Codis"></a>Codis</h3><p>Twemproxy不能平滑增加Redis实例的问题带来了很大的不便，于是豌豆荚自主研发了Codis，一个支持平滑增加Redis实例的Redis代理软件，其基于Go和C语言开发，并于2014年11月在GitHub上开源。</p>
<p>Codis包含下面4个部分：</p>
<ul>
<li>Codis Proxy：<br>  Redis客户端连接到Redis实例的代理，实现了Redis的协议，Redis客户端连接到Codis Proxy进行各种操作。Codis Proxy是无状态的，可以用Keepalived等负载均衡软件部署多个Codis Proxy实现高可用。</li>
<li>Codis Redis：<br>  Codis项目维护的Redis分支，添加了slot和原子的数据迁移命令。Codis上层的 Codis Proxy和Codisconfig只有与这个版本的Redis通信才能正常运行。</li>
<li>Codisconfig：<br>  Codis管理工具。可以执行添加删除CodisRedis节点、添加删除Codis Proxy、数据迁移等操作。另外，Codisconfig自带了HTTP server，里面集成了一个管理界面，方便运维人员观察Codis集群的状态和进行相关的操作，极大提高了运维的方便性，弥补了Twemproxy的缺点。</li>
<li>ZooKeeper：<br>  分布式的、开源的应用程序协调服务，是Hadoop和Hbase的重要组件，其为分布式应用提供一致性服务，提供的功能包括：配置维护、名字服务、分布式同步、组服务等。Codis依赖于ZooKeeper存储数据路由表的信息和Codis Proxy节点的元信息。另外，Codisconfig发起的命令都会通过ZooKeeper同步到Codis Proxy的节点。</li>
</ul>
<p>Codis的架构如下图所示：</p>
<p><img src="/images/redis-cluster-trove3.jpg" alt="codis"></p>
<h3 id="Redis-Cluster"><a href="#Redis-Cluster" class="headerlink" title="Redis Cluster"></a>Redis Cluster</h3><p>Redis Cluster在Redis 3.0开始支持，采用无中心的方式，为了维护集群状态统一，节点之间需要互相交换消息，Redis采用交换消息的方式被称为 Gossip ，基本思想是节点之间互相交换信息最终所有节点达到一致，更多关于 Gossip 可参考 <a href="https://en.wikipedia.org/wiki/Gossip_protocol" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Gossip_protocol</a></p>
<p>Redis 集群是一个提供在多个Redis间节点间共享数据的程序集。</p>
<p>Redis 集群并不支持处理多个keys的命令，因为这需要在不同的节点间移动数据，从而达不到像Redis那样的性能，在高负载的情况下可能会导致不可预料的错误.</p>
<h4 id="Redis-集群特点"><a href="#Redis-集群特点" class="headerlink" title="Redis 集群特点"></a>Redis 集群特点</h4><ul>
<li>自动分割数据到不同的节点上。</li>
<li>整个集群的部分节点失败或者不可达的情况下能够继续处理命令。</li>
<li>可线性扩展到上千个节点</li>
<li>可使数据自动路由到多个节点</li>
<li>实现了多个节点间的数据共享</li>
<li>可支持动态增加或删除节点</li>
<li>可保证某些节点无法提供服务时不影响整个集群的操作</li>
<li>不保证数据的强一致性</li>
<li>支持Redis所有处理单个数据库键的命令</li>
<li>不支持对多个数据库键的操作，比如MSET、SUNION</li>
<li>不能使用 SELECT 命令，集群只使用默认的0号数据库</li>
</ul>
<h4 id="Redis-集群数据共享"><a href="#Redis-集群数据共享" class="headerlink" title="Redis 集群数据共享"></a>Redis 集群数据共享</h4><p>Redis 集群使用数据分片（sharding）而非一致性哈希（consistency hashing）来实现： 一个 Redis 集群包含 16384 个哈希槽（hash slot）， 数据库中的每个键都属于这 16384 个哈希槽的其中一个， 集群使用公式 CRC16(key) % 16384 来计算键 key 属于哪个槽， 其中 CRC16(key) 语句用于计算键 key 的 CRC16 校验和 。</p>
<p>集群中的每个节点负责处理一部分哈希槽。 举个例子， 一个集群可以有三个节点， 其中：</p>
<ul>
<li>节点 A 负责处理 0 号至 5500 号哈希槽。</li>
<li>节点 B 负责处理 5501 号至 11000 号哈希槽。</li>
<li>节点 C 负责处理 11001 号至 16384 号哈希槽。</li>
</ul>
<p>这种将哈希槽分布到不同节点的做法使得用户可以很容易地向集群中添加或者删除节点。 比如说：</p>
<ul>
<li>如果用户将新节点 D 添加到集群中， 那么集群只需要将节点 A 、B 、 C 中的某些槽移动到节点 D 就可以了。</li>
<li>与此类似， 如果用户要从集群中移除节点 A ， 那么集群只需要将节点 A 中的所有哈希槽移动到节点 B 和节点 C ， 然后再移除空白（不包含任何哈希槽）的节点 A 就可以了。<br>因为将一个哈希槽从一个节点移动到另一个节点不会造成节点阻塞， 所以无论是添加新节点还是移除已存在节点， 又或者改变某个节点包含的哈希槽数量， 都不会造成集群下线。</li>
</ul>
<h4 id="Redis-集群中的主从复制"><a href="#Redis-集群中的主从复制" class="headerlink" title="Redis 集群中的主从复制"></a>Redis 集群中的主从复制</h4><p>为了使得集群在一部分节点下线或者无法与集群的大多数（majority）节点进行通讯的情况下， 仍然可以正常运作， Redis 集群对节点使用了主从复制功能： 集群中的每个节点都有 1 个至 N 个复制品（replica）， 其中一个复制品为主节点（master）， 而其余的 N-1 个复制品为从节点（slave）。</p>
<p>在之前列举的节点 A 、B 、C 的例子中， 如果节点 B 下线了， 那么集群将无法正常运行， 因为集群找不到节点来处理 5501 号至 11000号的哈希槽。</p>
<p>另一方面， 假如在创建集群的时候（或者至少在节点 B 下线之前）， 我们为主节点 B 添加了从节点 B1 ， 那么当主节点 B 下线的时候， 集群就会将 B1 设置为新的主节点， 并让它代替下线的主节点 B ， 继续处理 5501 号至 11000 号的哈希槽， 这样集群就不会因为主节点 B 的下线而无法正常运作了。</p>
<p>不过如果节点 B 和 B1 都下线的话， Redis 集群还是会停止运作。</p>
<h4 id="Redis-集群的一致性保证（guarantee）"><a href="#Redis-集群的一致性保证（guarantee）" class="headerlink" title="Redis 集群的一致性保证（guarantee）"></a>Redis 集群的一致性保证（guarantee）</h4><p>Redis 集群不保证数据的强一致性（strong consistency）： 在特定条件下， Redis 集群可能会丢失已经被执行过的写命令。</p>
<p>使用异步复制（asynchronous replication）是 Redis 集群可能会丢失写命令的其中一个原因。 考虑以下这个写命令的例子：</p>
<ul>
<li>客户端向主节点 B 发送一条写命令。</li>
<li>主节点 B 执行写命令，并向客户端返回命令回复。</li>
<li>主节点 B 将刚刚执行的写命令复制给它的从节点 B1 、 B2 和 B3 。</li>
</ul>
<p>如你所见， 主节点对命令的复制工作发生在返回命令回复之后， 因为如果每次处理命令请求都需要等待复制操作完成的话， 那么主节点处理命令请求的速度将极大地降低 —— 我们必须在性能和一致性之间做出权衡。</p>
<p>如果真的有必要的话， Redis 集群可能会在将来提供同步地（synchronou）执行写命令的方法。</p>
<p>Redis 集群另外一种可能会丢失命令的情况是， 集群出现网络分裂（network partition）， 并且一个客户端与至少包括一个主节点在内的少数（minority）实例被孤立。</p>
<p>举个例子， 假设集群包含 A 、 B 、 C 、 A1 、 B1 、 C1 六个节点， 其中 A 、B 、C 为主节点， 而 A1 、B1 、C1 分别为三个主节点的从节点， 另外还有一个客户端 Z1 。</p>
<p>假设集群中发生网络分裂， 那么集群可能会分裂为两方， 大多数（majority）的一方包含节点 A 、C 、A1 、B1 和 C1 ， 而少数（minority）的一方则包含节点 B 和客户端 Z1 。</p>
<p>在网络分裂期间， 主节点 B 仍然会接受 Z1 发送的写命令：</p>
<ul>
<li>如果网络分裂出现的时间很短， 那么集群会继续正常运行；</li>
<li><p>但是， 如果网络分裂出现的时间足够长， 使得大多数一方将从节点 B1 设置为新的主节点， 并使用 B1 来代替原来的主节点 B ， 那么 Z1 发送给主节点 B 的写命令将丢失。<br>注意， 在网络分裂出现期间， 客户端 Z1 可以向主节点 B 发送写命令的最大时间是有限制的， 这一时间限制称为节点超时时间（node timeout）， 是 Redis 集群的一个重要的配置选项：</p>
</li>
<li><p>对于大多数一方来说， 如果一个主节点未能在节点超时时间所设定的时限内重新联系上集群， 那么集群会将这个主节点视为下线， 并使用从节点来代替这个主节点继续工作。</p>
</li>
<li>对于少数一方， 如果一个主节点未能在节点超时时间所设定的时限内重新联系上集群， 那么它将停止处理写命令， 并向客户端报告错误。</li>
</ul>
<h4 id="Redis-集群的工作流程"><a href="#Redis-集群的工作流程" class="headerlink" title="Redis 集群的工作流程"></a>Redis 集群的工作流程</h4><p>Redis把所有的Key分成了16384个slot，每个Redis实例负责其中一部分slot。集群中的所有信息（节点、端口、slot等），都通过节点之间定期的数据交换而更新。</p>
<p>Redis客户端在任意一个Redis实例发出请求，如果所需数据不在该实例中，通过重定向命令引导客户端访问所需的实例。</p>
<p><img src="/images/redis-cluster-trove4.jpg" alt="redis cluster"></p>
<p>如上图所示，Redis集群内的机器定期交换数据，工作流程如下：</p>
<ol>
<li>Redis客户端在Redis2实例上访问某个数据。</li>
<li>在Redis2内发现这个数据是在Redis1这个实例中，给Redis客户端发送一个重定向的命令。</li>
<li>Redis客户端收到重定向命令后，访问Redis1实例获取所需的数据。 </li>
</ol>
<h2 id="Trove支持的Redis集群"><a href="#Trove支持的Redis集群" class="headerlink" title="Trove支持的Redis集群"></a>Trove支持的Redis集群</h2><p>Trove在Liberty里引入Redis Cluster支持，用户可以创建一个Redis Cluster，但每个Redis实例都不是高可用的。</p>
<p>通过Trove，可以创建Redis集群的方案：</p>
<h3 id="1，主从Redis实例"><a href="#1，主从Redis实例" class="headerlink" title="1，主从Redis实例"></a>1，主从Redis实例</h3><p>可以通过Keepalived实现高可用方案，如下图所示：</p>
<p><img src="/images/redis-cluster-trove5.jpg" alt="redis-cluster-keepalived"></p>
<h3 id="2，Redis-Cluster"><a href="#2，Redis-Cluster" class="headerlink" title="2，Redis Cluster"></a>2，Redis Cluster</h3><p>Redis 3.0后的版本支持，通过Trove可以创建Redis Cluster，添加Redis Nodes，删除Redis Nodes；</p>
<p>但每个Redis节点没有高可用，任何一个Redis节点挂掉，Redis Cluster就会有数据丢失；</p>
<p>Redis Cluster如下图所示：</p>
<p><img src="/images/redis-cluster-trove6.jpg" alt="redis-cluster"></p>
<h3 id="3，Redis-Cluster主从模式"><a href="#3，Redis-Cluster主从模式" class="headerlink" title="3，Redis Cluster主从模式"></a>3，Redis Cluster主从模式</h3><p>Redis Cluster 为了保证数据的高可用性，加入了主从模式，一个主节点对应一个或多个从节点，主节点提供数据存取，从节点则是从主节点拉取数据备份，当这个主节点挂掉后，就会有这个从节点选取一个来充当主节点，从而保证集群不会挂掉。</p>
<p>Trove里不支持该模式，需要修改Trove代码实现</p>
<p>主从Redis节点的灾备模式如下图所示：</p>
<p><img src="/images/redis-cluster-trove7.jpg" alt="redis-cluster-master-slave"></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://www.zybuluo.com/phper/note/195558" target="_blank" rel="noopener">https://www.zybuluo.com/phper/note/195558</a><br><a href="http://redisdoc.com/topic/cluster-tutorial.html" target="_blank" rel="noopener">http://redisdoc.com/topic/cluster-tutorial.html</a><br><a href="http://redisdoc.com/topic/cluster-spec.html" target="_blank" rel="noopener">http://redisdoc.com/topic/cluster-spec.html</a><br><a href="http://redis.io/topics/cluster-tutorial" target="_blank" rel="noopener">http://redis.io/topics/cluster-tutorial</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yangguanjun.com/2017/03/01/redis-service-invest/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/01/redis-service-invest/" itemprop="url">Redis服务调研</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-01T11:31:17+08:00">
                2017-03-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/trove/" itemprop="url" rel="index">
                    <span itemprop="name">trove</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/01/redis-service-invest/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/03/01/redis-service-invest/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis持久化</h2><p>Redis支持两种数据持久化方式：RDB方式和AOF方式。前者会根据配置的规则定时将内存中的数据持久化到硬盘上，后者则是在每次执行写命令之后将命令记录下来。两种持久化方式可以单独使用，但是通常会将两者结合使用。</p>
<h3 id="RDB方式"><a href="#RDB方式" class="headerlink" title="RDB方式"></a>RDB方式</h3><p>RDB方式的持久化是通过快照的方式完成的。当符合某种规则时，会将内存中的数据全量生成一份副本存储到硬盘上，这个过程称作”快照”，Redis会在以下几种情况下对数据进行快照：</p>
<ul>
<li>根据配置规则进行自动快照</li>
<li>用户执行SAVE, BGSAVE命令</li>
<li>执行FLUSHALL命令</li>
<li>执行复制（replication）时</li>
</ul>
<p>Redis允许用户自定义快照条件，当满足条件时自动执行快照，快照规则的配置方式如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure>
<p>每个快照条件独占一行，他们之间是或（||）关系，只要满足任何一个就进行快照。上面配置save后的第一个参数T是时间，单位是秒，第二个参数M是更改的键的个数，含义是：当时间T内被更改的键的个数大于M时，自动进行快照。比如save 900 1的含义是15分钟内(900s)被更改的键的个数大于1时，自动进行快照操作。 </p>
<h4 id="执行SAVE或BGSAVE命令"><a href="#执行SAVE或BGSAVE命令" class="headerlink" title="执行SAVE或BGSAVE命令"></a>执行SAVE或BGSAVE命令</h4><p>除了让Redis自动进行快照外，当我们需要重启，迁移，备份Redis时，我们也可以手动执行SAVE或BGSAVE命令主动进行快照操作。</p>
<ul>
<li>SAVE命令<br>  当执行SAVE命令时，Redis同步进行快照操作，期间会阻塞所有来自客户端的请求，所以放数据库数据较多时，应该避免使用该命令。</li>
<li>BGSAVE命令<br>  从命令名字就能看出来，这个命令与SAVE命令的区别就在于该命令的快照操作是在后台异步进行的，进行快照操作的同时还能处理来自客户端的请求。执行BGSAVE命令后Redis会马上返回OK表示开始进行快照操作，如果想知道快照操作是否已经完成，可以使用LASTSAVE命令返回最近一次成功执行快照的时间，返回结果是一个Unix时间戳。</li>
</ul>
<h4 id="快照原理"><a href="#快照原理" class="headerlink" title="快照原理"></a>快照原理</h4><p>Redis默认会将快照文件存储在Redis当前进程的工作目录的dump.rdb文件中，可以通过配置文件中的dir和dbfilename两个参数分别指定快照文件的存储路径和文件名，例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /opt/soft/redis-3.0.4/cache</span><br></pre></td></tr></table></figure>
<p>快照执行的过程如下：</p>
<ol>
<li>Redis使用fork函数复制一份当前进程（父进程）的副本（子进程）；</li>
<li>父进程继续处理来自客户端的请求，子进程开始将内存中的数据写入硬盘中的临时文件；</li>
<li>当子进程写完所有的数据后，用该临时文件替换旧的RDB文件，至此，一次快照操作完成。</li>
</ol>
<h3 id="AOF方式"><a href="#AOF方式" class="headerlink" title="AOF方式"></a>AOF方式</h3><p>在使用Redis存储非临时数据时，一般都需要打开AOF持久化来降低进程终止导致的数据丢失，AOF可以将Redis执行的每一条写命令追加到硬盘文件中，这一过程显然会降低Redis的性能，但是大部分情况下这个影响是可以接受的，另外，使用较快的硬盘能提高AOF的性能。</p>
<h4 id="开启AOF"><a href="#开启AOF" class="headerlink" title="开启AOF"></a>开启AOF</h4><p>默认情况下，Redis没有开启AOF（append only file）持久化功能，可以通过在配置文件中作如下配置启用：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appendonly yes</span><br></pre></td></tr></table></figure>
<p>开启之后，Redis每执行一条写命令就会将该命令写入硬盘中的AOF文件。AOF文件保存路径和RDB文件路径是一致的，都是通过dir参数配置，默认文件名是：appendonly.aof，可以通过配置appendonlyfilename参数修改，例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appendonlyfilename appendonly.aof</span><br></pre></td></tr></table></figure>
<h4 id="同步硬盘数据"><a href="#同步硬盘数据" class="headerlink" title="同步硬盘数据"></a>同步硬盘数据</h4><p>虽然每次执行更改数据库的内容时，AOF都会记录执行的命令，但是由于操作系统本身的硬盘缓存的缘故，AOF文件的内容并没有真正地写入硬盘，在默认情况下，操作系统会每隔30s将硬盘缓存中的数据同步到硬盘，但是为了防止系统异常退出而导致丢数据的情况发生，我们还可以在Redis的配置文件中配置这个同步的频率：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># appendfsync always</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="comment"># appendfsync no</span></span><br></pre></td></tr></table></figure>
<p>第一行表示每次AOF写入一个命令都会执行同步操作，这是最安全也是最慢的方式；<br>第二行表示每秒钟进行一次同步操作，一般来说使用这种方式已经足够；<br>第三行表示不主动进行同步操作，这是最不安全的方式。 </p>
<h2 id="Redis-Info信息"><a href="#Redis-Info信息" class="headerlink" title="Redis Info信息"></a>Redis Info信息</h2><p>INFO命令以一种易于理解和阅读的格式，返回关于Redis服务器的各种信息和统计数值。</p>
<p>通过给定可选的参数 section ，可以让命令只返回某一部分的信息:</p>
<ul>
<li>server: Redis服务器的一般信息</li>
<li>clients: 客户端的连接部分</li>
<li>memory: 内存消耗相关信息</li>
<li>persistence: RDB和AOF相关信息</li>
<li>stats: 一般统计</li>
<li>replication: 主/从复制信息</li>
<li>cpu: 统计CPU的消耗</li>
<li>commandstats: Redis命令统计</li>
<li>cluster: Redis集群信息</li>
<li>keyspace: 数据库的相关统计</li>
</ul>
<p>它也可以采取以下值:</p>
<ul>
<li>all: 返回所有信息</li>
<li>default: 返回默认设置的信息<br>如果没有使用任何参数时，默认为default。 </li>
</ul>
<h2 id="Redis的configuration-group"><a href="#Redis的configuration-group" class="headerlink" title="Redis的configuration group"></a>Redis的configuration group</h2><p>可以配置Redis支持的配置参数，参考文件：<code>trove/trove/templates/redis/validation-rules.json</code></p>
<p>里面可配置的参数很多，我们可以选择部分支持的参数提供给用户配置。</p>
<p>阿里提供的配置参数有：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>maxmemory-policy</td>
<td>volatile-lru</td>
</tr>
<tr>
<td>hash-max-ziplist-entries</td>
<td>512</td>
</tr>
<tr>
<td>hash-max-ziplist-value</td>
<td>64</td>
</tr>
<tr>
<td>list-max-ziplist-entries</td>
<td>512</td>
</tr>
<tr>
<td>list-max-ziplist-value</td>
<td>64</td>
</tr>
<tr>
<td>set-max-intset-entries</td>
<td>512</td>
</tr>
<tr>
<td>zset-max-ziplist-entries</td>
<td>128</td>
</tr>
<tr>
<td>zset-max-ziplist-value</td>
<td>64</td>
</tr>
<tr>
<td>notify-keyspace-events</td>
</tr>
</tbody>
</table>
<p>注释：上表中红色的部分是我们提供的redis 3.2.5版本中没有的，在新版本中的配置参数为：list-max-ziplist-size</p>
<p>青云支持的Redis配置参数更多：<br><img src="/images/redis-intro-config1.jpg" alt="redis-qingcloud"></p>
<p>配置redis, 3.2.5版本的config parameters：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove-manage --config-file /opt/etc/trove/trove.conf db_load_datastore_config_parameters redis 3.2.5 /opt/openstack/trove/trove/templates/redis/validation-rules.json</span></span><br></pre></td></tr></table></figure>
<p>创建Redis对应的configuration group：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove configuration-create redisCGroup '&#123;"requirepass": "mypass", "hll-sparse-max-bytes": 200&#125;'  --datastore redis --datastore_version 3.2.5</span></span><br></pre></td></tr></table></figure>
<p>Attach configuration group到实例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove configuration-attach &lt;instance&gt; &lt;configuration&gt;</span></span><br></pre></td></tr></table></figure>
<p>Detach configuration group到实例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove configuration-detach &lt;instance&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="Redis的备份和恢复"><a href="#Redis的备份和恢复" class="headerlink" title="Redis的备份和恢复"></a>Redis的备份和恢复</h2><h3 id="Redis的备份"><a href="#Redis的备份" class="headerlink" title="Redis的备份"></a>Redis的备份</h3><p>查看Trove代码，Redis备份的是RDB的dbfile，执行备份的步骤如下：</p>
<ol>
<li>保存当前数据到dbfile：执行 redis-cli BGSAVE命令</li>
<li>等待BGSAVE完成，通过redis-cli LASTSAVE获取dbfile的最新保存时间，变化的话即代表第1步BGSAVE完成</li>
<li>获取dbfile文件，通过cat <dbfile> | zip | encrypt，把文件上传到对象存储S3中</dbfile></li>
</ol>
<h3 id="Redis的恢复"><a href="#Redis的恢复" class="headerlink" title="Redis的恢复"></a>Redis的恢复</h3><p>Reids是通过之前备份的dbfile恢复数据的，执行恢复的步骤如下：</p>
<ol>
<li>若redis配置文件中aof为开启状态，则关闭aof：overrides = {‘appendonly’: ‘no’}</li>
<li>停止redis服务</li>
<li>删除当前的dbfile</li>
<li>根据当前的配置创建dbfile的目录（按实际需要）</li>
<li>从对象存储S3中拉取备份文件后，通过 decrypt | unzip到配置的dbfile</li>
<li>启动redis服务</li>
<li>若redis之前的配置中aof为关闭状态，则恢复完成，否则执行后续步骤；</li>
<li>通过redis-cli info persistence 获取redis的恢复状态：loading 0</li>
<li>重写aof文件：redis-cli BGREWRITEAOF</li>
<li>通过redis-cli info persistence 获取aof重写状态：aof_rewrite_in_progress 0</li>
<li>修改redis的配置文件，开启aof：overrides = {‘appendonly’: ‘yes’}</li>
<li>重启redis服务</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yangguanjun.com/2017/02/22/rbd-data-replication/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/22/rbd-data-replication/" itemprop="url">ceph块存储跨机房灾备调研</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-22T10:31:17+08:00">
                2017-02-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ceph/" itemprop="url" rel="index">
                    <span itemprop="name">ceph</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/22/rbd-data-replication/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/02/22/rbd-data-replication/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>随着提供云服务的机房的增多，为了提供更高的可靠性，满足高可用客户的需求，跨机房灾备必须实现，本文档重点调研Ceph RBD的跨机房容灾方案。</p>
<h2 id="当前状况"><a href="#当前状况" class="headerlink" title="当前状况"></a>当前状况</h2><p>当前应用中，每个机房的Ceph都是独立的cluster，彼此之间没有任何关系。</p>
<p>比如我们在机房A和机房B上部署了两套<code>Openstack+Ceph</code>的环境，底层的Ceph就是<code>ClusterA</code>和<code>ClusterB</code>。每个Cluster独立提供自己的块存储RBD服务。</p>
<p><img src="/images/rbd-data-replication1.jpg" alt="rbd-data-rep1"></p>
<h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><h3 id="方案1-Snapshot"><a href="#方案1-Snapshot" class="headerlink" title="方案1 - Snapshot"></a>方案1 - Snapshot</h3><h4 id="Ceph版本要求"><a href="#Ceph版本要求" class="headerlink" title="* Ceph版本要求"></a>* Ceph版本要求</h4><p>当前我们使用的Hammer 0.94.5版本即可</p>
<h4 id="原理"><a href="#原理" class="headerlink" title="* 原理"></a>* 原理</h4><p>异步备份，基于RBD的<code>snapshot</code>机制</p>
<h4 id="介绍"><a href="#介绍" class="headerlink" title="* 介绍"></a>* 介绍</h4><p>Cluster A &amp; B仍然是独立的Ceph集群，通过RBD的snapshot机制，在Cluster A端，针对image定期通过rbd创建image的snap，然后通过<code>rbd export-diff</code>, <code>rbd import-diff</code>命令来完成image备份到Cluster B。</p>
<h4 id="命令和步骤"><a href="#命令和步骤" class="headerlink" title="* 命令和步骤"></a>* 命令和步骤</h4><p>把 Cluster A 的 pool rbd 下面 image testimage 异步备份到 Cluster B 的 pool rbd 下的相同image上；</p>
<ol>
<li><p>在Cluster A/B上创建rbd/testimage<br><code>rbd create -p rbd --size 10240 testimage</code></p>
</li>
<li><p>在准备备份image前，暂停Cluster A端对testimage的IO操作，然后创建个snapshot<br><code>rbd snap create &lt;snap-name&gt;</code></p>
</li>
<li><p>导出Cluster A端的testimage数据，不指定from-snap<br><code>rbd export-diff &lt;image-name&gt; &lt;path&gt;</code></p>
</li>
<li><p>copy上一步中导出的文件到Cluster B，并导入数据到testimage<br><code>rbd import-diff &lt;path&gt; &lt;image-name&gt;</code></p>
</li>
</ol>
<p>后续需周期性的暂停Cluster A端的testimage的IO，然后创建snapshot，通过 <code>rbd export-diff &lt;image-name&gt; [--from-snap &lt;snap-name&gt;] &lt;path&gt;</code>命令导出incremental diff，之后把差异数据文件copy到Cluster B上，然后通过命令<code>rbd import-diff &lt;path&gt; &lt;image-name&gt;</code>导入。</p>
<p>【注】：也可不暂停Cluster A端的IO，直接take snapshot；这样并不会引起image的数据不一致，只是有可能会使<code>rbd export-diff</code>时导出的数据在take snapshot之后</p>
<h4 id="优缺点"><a href="#优缺点" class="headerlink" title="* 优缺点"></a>* 优缺点</h4><p><strong>优点：</strong></p>
<ol>
<li>当前Ceph版本就支持rbd snapshot的功能</li>
<li>命令简介方便，通过定制执行脚本就能实现rbd块设备的跨区备份</li>
</ol>
<p><strong>缺点：</strong></p>
<ol>
<li>每次同步前都需要在源端take snapshot</li>
<li>持续的snapshots可能导致image的读写性能下降</li>
<li>还要考虑后续删除不用的snapshots</li>
<li>snapshot只能保证IO的一致性，并不能保证使用rbd块设备上的系统一致性；</li>
</ol>
<p>【可以每次暂停image的IO，sync IO数据来保证rbd块设备上的系统一致性，但需要虚拟机支持qemu-guest-agent】</p>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="* 参考资料"></a>* 参考资料</h4><p><a href="https://ceph.com/dev-notes/incremental-snapshots-with-rbd/" target="_blank" rel="noopener">https://ceph.com/dev-notes/incremental-snapshots-with-rbd/</a><br><a href="https://www.rapide.nl/blog/item/ceph_-_rbd_replication.html" target="_blank" rel="noopener">https://www.rapide.nl/blog/item/ceph_-_rbd_replication.html</a><br><a href="http://wiki.libvirt.org/page/Qemu_guest_agent" target="_blank" rel="noopener">http://wiki.libvirt.org/page/Qemu_guest_agent</a></p>
<h3 id="方案2-One-Ceph-Cluster"><a href="#方案2-One-Ceph-Cluster" class="headerlink" title="方案2 - One Ceph Cluster"></a>方案2 - One Ceph Cluster</h3><h4 id="Ceph版本要求-1"><a href="#Ceph版本要求-1" class="headerlink" title="* Ceph版本要求"></a>* Ceph版本要求</h4><p>当前我们使用的Hammer 0.94.5版本即可</p>
<h4 id="原理-1"><a href="#原理-1" class="headerlink" title="* 原理"></a>* 原理</h4><p>同步备份，跨机房的Ceph集群，底层存储的跨机房容灾</p>
<h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="* 介绍"></a>* 介绍</h4><p>把两个机房的物理机搭建为一个Ceph Cluster，通过Ceph本身的写多份容灾</p>
<h4 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="* 优缺点"></a>* 优缺点</h4><p><strong>优点：</strong></p>
<ol>
<li>一个Ceph集群，能保证实时的跨机房容灾</li>
<li>不需要额外开发</li>
</ol>
<p><strong>缺点：</strong></p>
<ol>
<li>部署相对麻烦</li>
<li>跨机房的时延较大，影响Ceph集群性能</li>
</ol>
<h4 id="步骤和参考资料"><a href="#步骤和参考资料" class="headerlink" title="* 步骤和参考资料"></a>* 步骤和参考资料</h4><p><a href="http://www.sebastien-han.fr/blog/2013/01/28/ceph-geo-replication-sort-of/" target="_blank" rel="noopener">http://www.sebastien-han.fr/blog/2013/01/28/ceph-geo-replication-sort-of/</a></p>
<h3 id="方案3-RBD-Mirroring"><a href="#方案3-RBD-Mirroring" class="headerlink" title="方案3 - RBD Mirroring"></a>方案3 - RBD Mirroring</h3><h4 id="Ceph版本要求-2"><a href="#Ceph版本要求-2" class="headerlink" title="* Ceph版本要求"></a>* Ceph版本要求</h4><p>Jewel版本，最好是最新的10.2.2</p>
<h4 id="原理-2"><a href="#原理-2" class="headerlink" title="* 原理"></a>* 原理</h4><p>异步备份，Ceph新的rbd mirror功能</p>
<h4 id="介绍-2"><a href="#介绍-2" class="headerlink" title="* 介绍"></a>* 介绍</h4><p>Ceph新的rbd mirror功能支持配置两个Ceph Cluster之间的rbd同步</p>
<p><img src="/images/rbd-data-replication2.jpg" alt="rbd-data-rep1"></p>
<h4 id="优缺点-2"><a href="#优缺点-2" class="headerlink" title="* 优缺点"></a>* 优缺点</h4><p><strong>优点：</strong></p>
<ol>
<li>Ceph新的功能，不需要额外开发</li>
<li>同步的粒度比较小，为一个块设备的transaction</li>
<li>保证了Crash consistency</li>
<li>可配置pool的备份，也可单独指定image备份</li>
</ol>
<p><strong>缺点：</strong></p>
<ol>
<li>需要升级线上Ceph到Jewel 10.2.2版本</li>
<li>不确定升级的影响和工作量</li>
</ol>
<h4 id="步骤和参考资料-1"><a href="#步骤和参考资料-1" class="headerlink" title="* 步骤和参考资料"></a>* 步骤和参考资料</h4><p><a href="http://docs.ceph.com/docs/jewel/rbd/rbd-mirroring/" target="_blank" rel="noopener">http://docs.ceph.com/docs/jewel/rbd/rbd-mirroring/</a><br><a href="https://www.sebastien-han.fr/blog/2016/03/28/ceph-jewel-preview-ceph-rbd-mirroring/" target="_blank" rel="noopener">https://www.sebastien-han.fr/blog/2016/03/28/ceph-jewel-preview-ceph-rbd-mirroring/</a><br><a href="http://www.sebastien-han.fr/blog/2016/04/27/OpenStack-Summit-Austin-protecting-the-galaxy-Multi-Region-Disaster-Recovery-with-OpenStack-and-Ceph/" target="_blank" rel="noopener">http://www.sebastien-han.fr/blog/2016/04/27/OpenStack-Summit-Austin-protecting-the-galaxy-Multi-Region-Disaster-Recovery-with-OpenStack-and-Ceph/</a><br><a href="http://www.spinics.net/lists/ceph-devel/msg24169.html" target="_blank" rel="noopener">http://www.spinics.net/lists/ceph-devel/msg24169.html</a><br><a href="https://www.zybuluo.com/zphj1987/note/328708" target="_blank" rel="noopener">https://www.zybuluo.com/zphj1987/note/328708</a>  </p>
<h2 id="推荐方案"><a href="#推荐方案" class="headerlink" title="推荐方案"></a>推荐方案</h2><p>综合上面的描述和优缺点分析，方案3 - RBD Mirroring 会是一个比较好的选择。</p>
<p>这样我们不仅能跟随Ceph社区的节奏，也能很好的解决我们跨机房同步的需求，后续RBD Mirroring功能的升级，我们也能应用上。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yangguanjun.com/2016/12/15/rgw-functions-tst/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/15/rgw-functions-tst/" itemprop="url">对象存储OSS功能测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-15T15:11:17+08:00">
                2016-12-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ceph/" itemprop="url" rel="index">
                    <span itemprop="name">ceph</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/12/15/rgw-functions-tst/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/12/15/rgw-functions-tst/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文针对对象存储OSS的基本功能，提供能测试的方法和脚本<br>一些基于boto3API的简单操作示例：boto3API.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"><span class="comment"># creating a client</span></span><br><span class="line">s3client = boto3.client(<span class="string">'s3'</span>,</span><br><span class="line">                        aws_secret_access_key = <span class="string">'ZSU2I***8aNgGyMHBFhqwWnRzKz1fO'</span>,</span><br><span class="line">                        aws_access_key_id = <span class="string">'C6Y1E0C3EB***W8YIKEW'</span>,</span><br><span class="line">                        endpoint_url = <span class="string">'http://10.1.0.29'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># creating a bucket</span></span><br><span class="line">bucket_name = <span class="string">'ictfox'</span></span><br><span class="line">response = s3client.create_bucket(Bucket = bucket_name)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Creating bucket &#123;0&#125; returns =&gt; &#123;1&#125;\n"</span>.format(bucket_name, response)</span><br><span class="line"></span><br><span class="line"><span class="comment"># listing owned buckets</span></span><br><span class="line">response = s3client.list_buckets()</span><br><span class="line"><span class="keyword">for</span> bucket <span class="keyword">in</span> response[<span class="string">'Buckets'</span>]:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Listing owned buckets returns =&gt; &#123;0&#125; was created on &#123;1&#125;\n"</span>.format(bucket[<span class="string">'Name'</span>], bucket[<span class="string">'CreationDate'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># creating an object</span></span><br><span class="line">object_key = <span class="string">'hello.txt'</span></span><br><span class="line">response = s3client.put_object(Bucket = bucket_name, Key = object_key, Body = <span class="string">'Hello World!'</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Creating object &#123;0&#125; returns =&gt; &#123;1&#125;\n"</span>.format(object_key, response)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Listing a bucket's content</span></span><br><span class="line">response = s3client.list_objects(Bucket = bucket_name)</span><br><span class="line"><span class="keyword">for</span> obj <span class="keyword">in</span> response[<span class="string">'Contents'</span>]:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Listing a bucket's content returns =&gt; &#123;0&#125;\t&#123;1&#125;\t&#123;2&#125;\n"</span>.format(obj[<span class="string">'Key'</span>], obj[<span class="string">'Size'</span>], obj[<span class="string">'LastModified'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Changing an object's metadata(head object)</span></span><br><span class="line">metadata = &#123;<span class="string">'x-amz-meta-datastore'</span>: <span class="string">'qr'</span>, <span class="string">'x-amz-meta-datastore-version'</span>: <span class="string">'1.0.1'</span>&#125;</span><br><span class="line">copySrc = <span class="string">'&#123;0&#125;/&#123;1&#125;'</span>.format(bucket_name, object_key)</span><br><span class="line">response = s3client.copy_object(Bucket = bucket_name, CopySource = copySrc, Key = object_key, Metadata = metadata, MetadataDirective = <span class="string">'REPLACE'</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Changing metadata of object &#123;0&#125; returns =&gt; &#123;1&#125;\n"</span>.format(object_key, response)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Deleting an object</span></span><br><span class="line">response = s3client.delete_object(Bucket = bucket_name, Key = object_key)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Deleting object &#123;0&#125; returns =&gt; &#123;1&#125;\n"</span>.format(object_key, response)</span><br><span class="line"></span><br><span class="line"><span class="comment"># deleting a bucket</span></span><br><span class="line">response = s3client.delete_bucket(Bucket = bucket_name)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Deleting bucket &#123;0&#125; returns =&gt; &#123;1&#125;\n"</span>.format(bucket_name, response)</span><br></pre></td></tr></table></figure>
<h2 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h2><p>用户的管理是通过Admin Ops API提供；这里我们通过之前创建好的管理账户来执行Admin Ops API，具体可以参考：<a href="http://docs.ceph.com/docs/master/radosgw/adminops/" target="_blank" rel="noopener">http://docs.ceph.com/docs/master/radosgw/adminops/</a></p>
<h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ cat usercreate.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">token=5L65QDE4df8JJ8RM7MN5 <span class="comment">## USER_TOKEN</span></span><br><span class="line">secret=Y9HPiBCwLDeSMSaiQhmPT2h7NgNUndvLERhktnIZ <span class="comment">## USER_SECRET</span></span><br><span class="line">query=<span class="variable">$1</span></span><br><span class="line">name=<span class="variable">$2</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$query</span>, <span class="variable">$name</span></span><br><span class="line">query3=<span class="string">"&amp;uid="</span></span><br><span class="line">query2=admin/user</span><br><span class="line">date=$(<span class="keyword">for</span> i <span class="keyword">in</span> $(date <span class="string">"+%H"</span>) ; <span class="keyword">do</span> date <span class="string">"+%a, %d %b %Y <span class="variable">$(( 10#$i-8 )</span>):%M:%S +0000"</span> ; <span class="keyword">done</span>)</span><br><span class="line">header=<span class="string">"PUT\n\n\n<span class="variable">$&#123;date&#125;</span>\n/<span class="variable">$&#123;query2&#125;</span>"</span></span><br><span class="line">sig=$(<span class="built_in">echo</span> -en <span class="variable">$&#123;header&#125;</span> | openssl sha1 -hmac <span class="variable">$&#123;secret&#125;</span> -binary | base64)</span><br><span class="line">curl -v -H <span class="string">"Date: <span class="variable">$&#123;date&#125;</span>"</span> -H <span class="string">"Authorization: AWS <span class="variable">$&#123;token&#125;</span>:<span class="variable">$&#123;sig&#125;</span>"</span> -L -X PUT <span class="string">"http://&lt;your-host-ip&gt;/<span class="variable">$&#123;query2&#125;</span>?format=json<span class="variable">$&#123;query3&#125;</span><span class="variable">$&#123;query&#125;</span>&amp;display-name=<span class="variable">$&#123;name&#125;</span>"</span> -H <span class="string">"Host: &lt;your-host-ip&gt;"</span></span><br></pre></td></tr></table></figure>
<h3 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ cat userdelete.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">token=5L65QDE4238JJ8RM7MN5 <span class="comment">## USER_TOKEN</span></span><br><span class="line">secret=Y9HPiBCwLDeSMSaiQhmPT2h7NgNUnqVLERhktnIZ <span class="comment">## USER_SECRET</span></span><br><span class="line">query=<span class="variable">$1</span></span><br><span class="line">query3=<span class="string">"&amp;uid="</span></span><br><span class="line">query2=admin/user</span><br><span class="line">date=$(<span class="keyword">for</span> i <span class="keyword">in</span> $(date <span class="string">"+%H"</span>) ; <span class="keyword">do</span> date <span class="string">"+%a, %d %b %Y <span class="variable">$(( 10#$i-8 )</span>):%M:%S +0000"</span> ; <span class="keyword">done</span>)</span><br><span class="line">header=<span class="string">"DELETE\n\n\n<span class="variable">$&#123;date&#125;</span>\n/<span class="variable">$&#123;query2&#125;</span>"</span></span><br><span class="line">sig=$(<span class="built_in">echo</span> -en <span class="variable">$&#123;header&#125;</span> | openssl sha1 -hmac <span class="variable">$&#123;secret&#125;</span> -binary | base64)</span><br><span class="line">curl -v -H <span class="string">"Date: <span class="variable">$&#123;date&#125;</span>"</span> -H <span class="string">"Authorization: AWS <span class="variable">$&#123;token&#125;</span>:<span class="variable">$&#123;sig&#125;</span>"</span> -L -X DELETE <span class="string">"http://&lt;your-host-ip&gt;/<span class="variable">$&#123;query2&#125;</span>?format=json<span class="variable">$&#123;query3&#125;</span><span class="variable">$&#123;query&#125;</span>"</span> -H <span class="string">"Host: &lt;your-host-ip&gt;"</span></span><br></pre></td></tr></table></figure>
<h2 id="User-keys"><a href="#User-keys" class="headerlink" title="User keys"></a>User keys</h2><p>管理User的keys也是通过admin Ops API操作的，同样需要通过管理账户来执行；</p>
<h3 id="创建user-key"><a href="#创建user-key" class="headerlink" title="创建user key"></a>创建user key</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cat</span> createKey.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">token=5L65QDE4238JJ8RM7MN5 <span class="comment">## USER_TOKEN</span></span><br><span class="line">secret=Y9HPiBCwLDeSMSaiQhmPT2h7NgNUnqVLERhktnIZ <span class="comment">## USER_SECRET</span></span><br><span class="line">operate=<span class="string">"PUT"</span></span><br><span class="line">user=<span class="variable">$1</span></span><br><span class="line">query=<span class="string">"admin/user"</span></span><br><span class="line">date=$(<span class="keyword">for</span> i <span class="keyword">in</span> $(date <span class="string">"+%H"</span>) ; <span class="keyword">do</span> date <span class="string">"+%a, %d %b %Y <span class="variable">$(( 10#$i-8 )</span>):%M:%S +0000"</span> ; <span class="keyword">done</span>)</span><br><span class="line">header=<span class="string">"<span class="variable">$&#123;operate&#125;</span>\n\n\n<span class="variable">$&#123;date&#125;</span>\n/<span class="variable">$&#123;query&#125;</span>"</span></span><br><span class="line">sig=$(<span class="built_in">echo</span> -en <span class="variable">$&#123;header&#125;</span> | openssl sha1 -hmac <span class="variable">$&#123;secret&#125;</span> -binary | base64)</span><br><span class="line">curl -v -L -X <span class="variable">$&#123;operate&#125;</span> <span class="string">"http://&lt;your-host-ip&gt;/<span class="variable">$&#123;query&#125;</span>?key&amp;format=json&amp;uid=<span class="variable">$&#123;user&#125;</span>&amp;generate-key=True"</span> \</span><br><span class="line"> -H <span class="string">"Date: <span class="variable">$&#123;date&#125;</span>"</span> \</span><br><span class="line"> -H <span class="string">"Authorization: AWS <span class="variable">$&#123;token&#125;</span>:<span class="variable">$&#123;sig&#125;</span>"</span> \</span><br><span class="line"> -H <span class="string">"Host: &lt;your-host-ip&gt;"</span></span><br></pre></td></tr></table></figure>
<h3 id="删除user-key"><a href="#删除user-key" class="headerlink" title="删除user key"></a>删除user key</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat removeKey.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">token=5L65QDE4238JJ8RM7MN5 <span class="comment">## USER_TOKEN</span></span><br><span class="line">secret=Y9HPiBCwLDeSMSaiQhmPT2h7NgNUnqVLERhktnIZ <span class="comment">## USER_SECRET</span></span><br><span class="line">operate=<span class="string">"DELETE"</span></span><br><span class="line">key=<span class="variable">$1</span></span><br><span class="line">query=<span class="string">"admin/user"</span></span><br><span class="line">date=$(<span class="keyword">for</span> i <span class="keyword">in</span> $(date <span class="string">"+%H"</span>) ; <span class="keyword">do</span> date <span class="string">"+%a, %d %b %Y <span class="variable">$(( 10#$i-8 )</span>):%M:%S +0000"</span> ; <span class="keyword">done</span>)</span><br><span class="line">header=<span class="string">"<span class="variable">$&#123;operate&#125;</span>\n\n\n<span class="variable">$&#123;date&#125;</span>\n/<span class="variable">$&#123;query&#125;</span>"</span></span><br><span class="line">sig=$(<span class="built_in">echo</span> -en <span class="variable">$&#123;header&#125;</span> | openssl sha1 -hmac <span class="variable">$&#123;secret&#125;</span> -binary | base64)</span><br><span class="line">curl -v -L -X <span class="variable">$&#123;operate&#125;</span> <span class="string">"http://&lt;your-host-ip&gt;/<span class="variable">$&#123;query&#125;</span>?key&amp;format=json&amp;access-key=<span class="variable">$&#123;key&#125;</span>"</span> \</span><br><span class="line">           -H <span class="string">"Date: <span class="variable">$&#123;date&#125;</span>"</span> \</span><br><span class="line">           -H <span class="string">"Authorization: AWS <span class="variable">$&#123;token&#125;</span>:<span class="variable">$&#123;sig&#125;</span>"</span> \</span><br><span class="line">           -H <span class="string">"Host: &lt;your-host-ip&gt;"</span></span><br></pre></td></tr></table></figure>
<h3 id="列出user-keys"><a href="#列出user-keys" class="headerlink" title="列出user keys"></a>列出user keys</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat getUserInfo.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">token=5L65QDE4238JJ8RM7MN5 <span class="comment">## USER_TOKEN</span></span><br><span class="line">secret=Y9HPiBCwLDeSMSaiQhmPT2h7NgNUnqVLERhktnIZ <span class="comment">## USER_SECRET</span></span><br><span class="line">user=<span class="variable">$1</span></span><br><span class="line">query=admin/user</span><br><span class="line">date=$(<span class="keyword">for</span> i <span class="keyword">in</span> $(date <span class="string">"+%H"</span>) ; <span class="keyword">do</span> date <span class="string">"+%a, %d %b %Y <span class="variable">$(( 10#$i-8 )</span>):%M:%S +0000"</span> ; <span class="keyword">done</span>)</span><br><span class="line">header=<span class="string">"GET\n\n\n<span class="variable">$&#123;date&#125;</span>\n/<span class="variable">$&#123;query&#125;</span>"</span></span><br><span class="line">sig=$(<span class="built_in">echo</span> -en <span class="variable">$&#123;header&#125;</span> | openssl sha1 -hmac <span class="variable">$&#123;secret&#125;</span> -binary | base64)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$sig</span></span><br><span class="line">curl -v -L -X GET <span class="string">"http://&lt;your-host-ip&gt;/<span class="variable">$&#123;query&#125;</span>?format=json&amp;uid=<span class="variable">$&#123;user&#125;</span>"</span> \</span><br><span class="line">           -H <span class="string">"Date: <span class="variable">$&#123;date&#125;</span>"</span> \</span><br><span class="line">           -H <span class="string">"Authorization: AWS <span class="variable">$&#123;token&#125;</span>:<span class="variable">$&#123;sig&#125;</span>"</span> \</span><br><span class="line">           -H <span class="string">"Host: &lt;your-host-ip&gt;"</span></span><br></pre></td></tr></table></figure>
<h2 id="权限管理"><a href="#权限管理" class="headerlink" title="权限管理"></a>权限管理</h2><p>开源的比较常用的s3的SDK有boto3，我们在RDS的备份中已经使用过<br>参考：<a href="http://boto3.readthedocs.io/en/latest/reference/services/s3.html#s3" target="_blank" rel="noopener">http://boto3.readthedocs.io/en/latest/reference/services/s3.html#s3</a></p>
<p><strong>下面的操作都简要列出了调用的api和说明；</strong></p>
<h3 id="获取Bucket权限"><a href="#获取Bucket权限" class="headerlink" title="获取Bucket权限"></a>获取Bucket权限</h3><p>get_bucket_acl(**kwargs)  </p>
<ul>
<li>Gets the access control policy for the bucket.</li>
</ul>
<h3 id="设置Bucket权限"><a href="#设置Bucket权限" class="headerlink" title="设置Bucket权限"></a>设置Bucket权限</h3><p>put_bucket_acl(**kwargs)  </p>
<ul>
<li>Sets the permissions on a bucket using access control lists (ACL).</li>
</ul>
<h2 id="Bucket操作"><a href="#Bucket操作" class="headerlink" title="Bucket操作"></a>Bucket操作</h2><p>同权限管理，下面的操作基于boto3，都简要列出了调用的api和说明；</p>
<h3 id="列出Buckets"><a href="#列出Buckets" class="headerlink" title="列出Buckets"></a>列出Buckets</h3><p>list_buckets()  </p>
<ul>
<li>Returns a list of all buckets owned by the authenticated sender of the request.</li>
</ul>
<h3 id="创建Bucket"><a href="#创建Bucket" class="headerlink" title="创建Bucket"></a>创建Bucket</h3><p>create_bucket(**kwargs)  </p>
<ul>
<li>Creates a new bucket.</li>
</ul>
<h3 id="删除Bucket"><a href="#删除Bucket" class="headerlink" title="删除Bucket"></a>删除Bucket</h3><p>delete_bucket(**kwargs)  </p>
<ul>
<li>Deletes the bucket. All objects (including all object versions and Delete Markers) in the bucket must be deleted before the bucket itself can be deleted.</li>
</ul>
<h3 id="列出Bucket-Objects"><a href="#列出Bucket-Objects" class="headerlink" title="列出Bucket Objects"></a>列出Bucket Objects</h3><ol>
<li><p>list_objects(**kwargs)<br> Returns some or all (up to 1000) of the objects in a bucket. You can use the request parameters as selection criteria to return a subset of the objects in a bucket.</p>
</li>
<li><p>list_objects_v2(**kwargs)<br> Returns some or all (up to 1000) of the objects in a bucket. You can use the request parameters as selection criteria to return a subset of the objects in a bucket. Note: ListObjectsV2 is the revised List Objects API and we recommend you use this revised API for new application development.</p>
</li>
</ol>
<h3 id="获取Bucket-ACL"><a href="#获取Bucket-ACL" class="headerlink" title="获取Bucket ACL"></a>获取Bucket ACL</h3><p>get_bucket_acl(**kwargs)  </p>
<ul>
<li>Gets the access control policy for the bucket.</li>
</ul>
<h3 id="设置Bucket-ACL"><a href="#设置Bucket-ACL" class="headerlink" title="设置Bucket ACL"></a>设置Bucket ACL</h3><p>put_bucket_acl(**kwargs)  </p>
<ul>
<li>Sets the permissions on a bucket using access control lists (ACL).</li>
</ul>
<h3 id="获取Bucket-Info"><a href="#获取Bucket-Info" class="headerlink" title="获取Bucket Info"></a>获取Bucket Info</h3><p>head_bucket(**kwargs)  </p>
<ul>
<li>This operation is useful to determine if a bucket exists and you have permission to access it.</li>
</ul>
<h3 id="枚举Bucket分块上传"><a href="#枚举Bucket分块上传" class="headerlink" title="枚举Bucket分块上传"></a>枚举Bucket分块上传</h3><p>list_multipart_uploads(**kwargs)  </p>
<ul>
<li>This operation lists in-progress multipart uploads.</li>
</ul>
<h2 id="Object操作"><a href="#Object操作" class="headerlink" title="Object操作"></a>Object操作</h2><h3 id="上传Object"><a href="#上传Object" class="headerlink" title="上传Object"></a>上传Object</h3><ol>
<li><p>put_object(**kwargs)<br> Adds an object to a bucket.</p>
</li>
<li><p>upload_file(Filename, Bucket, Key, ExtraArgs=None, Callback=None, Config=None)<br> Upload a file to an S3 object.</p>
</li>
<li><p>upload_fileobj(Fileobj, Bucket, Key, ExtraArgs=None, Callback=None, Config=None)<br> Upload a file-like object to S3.<br> The file-like object must be in binary mode.<br> This is a managed transfer which will perform a multipart upload in multiple threads if necessary.</p>
</li>
</ol>
<h3 id="复制Object"><a href="#复制Object" class="headerlink" title="复制Object"></a>复制Object</h3><p>copy_object(**kwargs)  </p>
<ul>
<li>Creates a copy of an object that is already stored in Amazon S3.</li>
</ul>
<h3 id="删除Object"><a href="#删除Object" class="headerlink" title="删除Object"></a>删除Object</h3><ol>
<li><p>delete_object(**kwargs)<br> Removes the null version (if there is one) of an object and inserts a delete marker, which becomes the latest version of the object. If there isn’t a null version, Amazon S3 does not remove any objects.</p>
</li>
<li><p>delete_objects(**kwargs)<br> This operation enables you to delete multiple objects from a bucket using a single HTTP request. You may specify up to 1000 keys.</p>
</li>
</ol>
<h3 id="下载Object"><a href="#下载Object" class="headerlink" title="下载Object"></a>下载Object</h3><ol>
<li><p>get_object(**kwargs)<br> Retrieves objects from Amazon S3.</p>
</li>
<li><p>download_file(Bucket, Key, Filename, ExtraArgs=None, Callback=None, Config=None)<br> Download an S3 object to a file.</p>
</li>
<li><p>download_fileobj(Bucket, Key, Fileobj, ExtraArgs=None, Callback=None, Config=None)<br> Download an object from S3 to a file-like object.<br> The file-like object must be in binary mode.<br> This is a managed transfer which will perform a multipart download in multiple threads if necessary.</p>
</li>
</ol>
<h3 id="获取Object-ACL"><a href="#获取Object-ACL" class="headerlink" title="获取Object ACL"></a>获取Object ACL</h3><p>get_object_acl(**kwargs)  </p>
<ul>
<li>Returns the access control list (ACL) of an object.</li>
</ul>
<h3 id="设置Object-ACL"><a href="#设置Object-ACL" class="headerlink" title="设置Object ACL"></a>设置Object ACL</h3><p>put_object_acl(**kwargs)  </p>
<ul>
<li>uses the acl subresource to set the access control list (ACL) permissions for an object that already exists in a bucket</li>
</ul>
<h3 id="获取Object-Info"><a href="#获取Object-Info" class="headerlink" title="获取Object Info"></a>获取Object Info</h3><p>head_object(**kwargs)  </p>
<ul>
<li>The HEAD operation retrieves metadata from an object without returning the object itself. This operation is useful if you’re only interested in an object’s metadata. To use HEAD, you must have READ access to the object.</li>
</ul>
<h3 id="支持Object-Multipart"><a href="#支持Object-Multipart" class="headerlink" title="支持Object Multipart"></a>支持Object Multipart</h3><ol>
<li><p>create_multipart_upload(**kwargs)<br> Initiates a multipart upload and returns an upload ID.</p>
</li>
<li><p>complete_multipart_upload(**kwargs)<br> Completes a multipart upload by assembling previously uploaded parts.</p>
</li>
<li><p>abort_multipart_upload(**kwargs)<br> Aborts a multipart upload.<br> To verify that all parts have been removed, so you don’t get charged for the part storage, you should call the List Parts operation and ensure the parts list is empty.</p>
</li>
<li><p>upload_part(**kwargs)<br> Uploads a part in a multipart upload.</p>
</li>
</ol>
<h2 id="其他操作"><a href="#其他操作" class="headerlink" title="其他操作"></a>其他操作</h2><h3 id="获取RGW-User统计信息"><a href="#获取RGW-User统计信息" class="headerlink" title="获取RGW User统计信息"></a>获取RGW User统计信息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ cat getUsage.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">token=5L65QDE4238JJ8RM7MN5 <span class="comment">## USER_TOKEN</span></span><br><span class="line">secret=Y9HPiBCwLDeSMSaiQhmPT2h7NgNUnqVLERhktnIZ <span class="comment">## USER_SECRET</span></span><br><span class="line">operate=<span class="string">"GET"</span></span><br><span class="line">user=<span class="variable">$1</span></span><br><span class="line">query=<span class="string">"admin/usage"</span></span><br><span class="line">date=$(<span class="keyword">for</span> i <span class="keyword">in</span> $(date <span class="string">"+%H"</span>) ; <span class="keyword">do</span> date <span class="string">"+%a, %d %b %Y <span class="variable">$(( 10#$i-8 )</span>):%M:%S +0000"</span> ; <span class="keyword">done</span>)</span><br><span class="line">header=<span class="string">"<span class="variable">$&#123;operate&#125;</span>\n\n\n<span class="variable">$&#123;date&#125;</span>\n/<span class="variable">$&#123;query&#125;</span>"</span></span><br><span class="line">sig=$(<span class="built_in">echo</span> -en <span class="variable">$&#123;header&#125;</span> | openssl sha1 -hmac <span class="variable">$&#123;secret&#125;</span> -binary | base64)</span><br><span class="line">curl -v -L -X <span class="variable">$&#123;operate&#125;</span> <span class="string">"http://&lt;your-host-ip&gt;/<span class="variable">$&#123;query&#125;</span>?format=json&amp;uid=<span class="variable">$&#123;user&#125;</span>"</span> \</span><br><span class="line">           -H <span class="string">"Date: <span class="variable">$&#123;date&#125;</span>"</span> \</span><br><span class="line">           -H <span class="string">"Authorization: AWS <span class="variable">$&#123;token&#125;</span>:<span class="variable">$&#123;sig&#125;</span>"</span> \</span><br><span class="line">           -H <span class="string">"Host: &lt;your-host-ip&gt;"</span></span><br></pre></td></tr></table></figure>
<h3 id="删除RGW-User统计信息"><a href="#删除RGW-User统计信息" class="headerlink" title="删除RGW User统计信息"></a>删除RGW User统计信息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ cat trimeUsage.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">token=5L65QDE4238JJ8RM7MN5 <span class="comment">## USER_TOKEN</span></span><br><span class="line">secret=Y9HPiBCwLDeSMSaiQhmPT2h7NgNUnqVLERhktnIZ <span class="comment">## USER_SECRET</span></span><br><span class="line">operate=<span class="string">"DELETE"</span></span><br><span class="line">user=<span class="variable">$1</span></span><br><span class="line">stime=<span class="variable">$2</span> <span class="comment">#start time</span></span><br><span class="line">etime=<span class="variable">$3</span> <span class="comment">#end time</span></span><br><span class="line">query=<span class="string">"admin/usage"</span></span><br><span class="line">date=$(<span class="keyword">for</span> i <span class="keyword">in</span> $(date <span class="string">"+%H"</span>) ; <span class="keyword">do</span> date <span class="string">"+%a, %d %b %Y <span class="variable">$(( 10#$i-8 )</span>):%M:%S +0000"</span> ; <span class="keyword">done</span>)</span><br><span class="line">header=<span class="string">"<span class="variable">$&#123;operate&#125;</span>\n\n\n<span class="variable">$&#123;date&#125;</span>\n/<span class="variable">$&#123;query&#125;</span>"</span></span><br><span class="line">sig=$(<span class="built_in">echo</span> -en <span class="variable">$&#123;header&#125;</span> | openssl sha1 -hmac <span class="variable">$&#123;secret&#125;</span> -binary | base64)</span><br><span class="line">curl -v -L -X <span class="variable">$&#123;operate&#125;</span> <span class="string">"http://&lt;your-host-ip&gt;/<span class="variable">$&#123;query&#125;</span>?format=json&amp;uid=<span class="variable">$&#123;user&#125;</span>&amp;start=<span class="variable">$&#123;stime&#125;</span>&amp;end=<span class="variable">$&#123;etime&#125;</span>"</span> \</span><br><span class="line">           -H <span class="string">"Date: <span class="variable">$&#123;date&#125;</span>"</span> \</span><br><span class="line">           -H <span class="string">"Authorization: AWS <span class="variable">$&#123;token&#125;</span>:<span class="variable">$&#123;sig&#125;</span>"</span> \</span><br><span class="line">           -H <span class="string">"Host: &lt;your-host-ip&gt;"</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yangguanjun.com/2016/12/12/rgw-oss/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/12/rgw-oss/" itemprop="url">RadosGW对象存储使用文档</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-12T15:31:17+08:00">
                2016-12-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ceph/" itemprop="url" rel="index">
                    <span itemprop="name">ceph</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/12/12/rgw-oss/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/12/12/rgw-oss/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>OSS: Object Storage Service<br>RadosGW兼容S3，我们需要依S3的方式提供OSS </p>
<h2 id="OSS功能列表"><a href="#OSS功能列表" class="headerlink" title="OSS功能列表"></a>OSS功能列表</h2><h3 id="Bucket相关"><a href="#Bucket相关" class="headerlink" title="Bucket相关"></a>Bucket相关</h3><table>
<thead>
<tr>
<th>Buckets功能</th>
<th>REST API</th>
<th>Ceph Operation &amp; Class</th>
</tr>
</thead>
<tbody>
<tr>
<td>List Buckets</td>
<td>GET / HTTP/1.1<br>Host:  <a href="http://cname.company.cn/" target="_blank" rel="noopener"><em>cname.company.cn</em></a><br>Authorization: AWS {access-key}:{hash-of-header-and-secret}</td>
<td>RGW_OP_LIST_BUCKETS<br>class RGWListBuckets_ObjStore_S3</td>
</tr>
<tr>
<td>Put Bucket</td>
<td>PUT /{bucket} HTTP/1.1<br>Host:  <a href="http://cname.company.cn/" target="_blank" rel="noopener"><em>cname.company.cn</em></a><br>x-amz-acl: public-read-write<br>Authorization: AWS {access-key}:{hash-of-header-and-secret}</td>
<td>RGW_OP_CREATE_BUCKET<br>class RGWCreateBucket_ObjStore_S3</td>
</tr>
<tr>
<td>Delete Bucket</td>
<td>DELETE /{bucket} HTTP/1.1<br>Host:  <a href="http://cname.company.cn/" target="_blank" rel="noopener"><em>cname.company.cn</em></a><br>Authorization: AWS {access-key}:{hash-of-header-and-secret}</td>
<td>RGW_OP_DELETE_BUCKET<br>class RGWDeleteBucket_ObjStore_S3</td>
</tr>
<tr>
<td>List Bucket Objects</td>
<td>GET /{bucket}?max-keys=25 HTTP/1.1<br>Host:  <a href="http://cname.company.cn/" target="_blank" rel="noopener"><em>cname.company.cn</em></a></td>
<td>RGW_OP_LIST_BUCKET<br>class RGWListBucket_ObjStore_S3</td>
</tr>
<tr>
<td>Get Bucket Location</td>
<td>GET /{bucket}?location HTTP/1.1<br>Host:  <a href="http://cname.company.cn/" target="_blank" rel="noopener"><em>cname.company.cn</em></a><br>Authorization: AWS {access-key}:{hash-of-header-and-secret}</td>
<td>class RGWGetBucketLocation_ObjStore_S3</td>
</tr>
<tr>
<td>Get Bucket ACL</td>
<td>GET /{bucket}?acl HTTP/1.1<br>Host:  <a href="http://cname.company.cn/" target="_blank" rel="noopener"><em>cname.company.cn</em></a><br>Authorization: AWS {access-key}:{hash-of-header-and-secret}</td>
<td>RGW_OP_GET_ACLS<br>class RGWGetACLs_ObjStore_S3</td>
</tr>
<tr>
<td>Put Bucket ACL</td>
<td>PUT /{bucket}?acl HTTP/1.1</td>
<td>RGW_OP_PUT_ACLS<br>class RGWPutACLs_ObjStore_S3</td>
</tr>
<tr>
<td>List Bucket MultiPart Uploads</td>
<td>GET /{bucket}?uploads HTTP/1.1</td>
<td>RGW_OP_LIST_BUCKET_MULTIPARTS<br>class RGWListBucketMultiparts_ObjStore_S3</td>
</tr>
<tr>
<td>Head Bucket</td>
<td>HEAD / HTTP/1.1<br>Host:  <a href="http://cname.company.cn/" target="_blank" rel="noopener"><em>cname.company.cn</em></a><br>Authorization: AWS {access-key}:{hash-of-header-and-secret}</td>
<td>RGW_OP_STAT_BUCKET<br>class RGWStatBucket_ObjStore_S3</td>
</tr>
</tbody>
</table>
<h3 id="Object相关"><a href="#Object相关" class="headerlink" title="Object相关"></a>Object相关</h3><table>
<thead>
<tr>
<th>Object功能</th>
<th>RESTful API</th>
<th>Ceph Operation &amp; Class</th>
</tr>
</thead>
<tbody>
<tr>
<td>Put Object</td>
<td>PUT /{bucket}/{object} HTTP/1.1</td>
<td>RGW_OP_PUT_OBJ<br>class RGWPutObj_ObjStore_S3</td>
</tr>
<tr>
<td>Copy Object</td>
<td>PUT /{dest-bucket}/{dest-object} HTTP/1.1<br>x-amz-copy-source: {source-bucket}/{source-object}</td>
<td>RGW_OP_COPY_OBJ<br>class RGWCopyObj_ObjStore_S3</td>
</tr>
<tr>
<td>Remove Object</td>
<td>DELETE /{bucket}/{object} HTTP/1.1</td>
<td>RGW_OP_DELETE_OBJ <br>class RGWDeleteObj_ObjStore_S3</td>
</tr>
<tr>
<td>Get Object</td>
<td>GET /{bucket}/{object} HTTP/1.1</td>
<td>RGW_OP_GET_OBJ <br>class RGWGetObj_ObjStore_S3</td>
</tr>
<tr>
<td>Get Object Info</td>
<td>HEAD /{bucket}/{object} HTTP/1.1</td>
<td>RGW_OP_GET_OBJ <br>class RGWGetObj_ObjStore_S3</td>
</tr>
<tr>
<td>Get Object ACL</td>
<td>GET /{bucket}/{object}?acl HTTP/1.1</td>
<td>RGW_OP_GET_ACLS <br>class RGWGetACLs_ObjStore_S3</td>
</tr>
<tr>
<td>Set Object ACL</td>
<td>PUT /{bucket}/{object}?acl</td>
<td>RGW_OP_PUT_ACLS <br>class RGWPutACLs_ObjStore_S3</td>
</tr>
<tr>
<td>Initiate MultiPart Upload</td>
<td>POST /{bucket}/{object}?uploads</td>
<td>RGW_OP_INIT_MULTIPART <br>class RGWInitMultipart_ObjStore_S3</td>
</tr>
<tr>
<td>MultiPart Upload Part</td>
<td>PUT /{bucket}/{object}?partNumber=&amp;uploadId= HTTP/1.1</td>
<td>RGW_OP_PUT_OBJ <br>class RGWPutObj_ObjStore_S3</td>
</tr>
<tr>
<td>List MultiPart Upload Parts</td>
<td>GET /{bucket}/{object}?uploadId=123 HTTP/1.1</td>
<td>RGW_OP_LIST_MULTIPART <br>class RGWListMultipart_ObjStore_S3</td>
</tr>
<tr>
<td>Complete MultiPart Upload</td>
<td>POST /{bucket}/{object}?uploadId= HTTP/1.1</td>
<td>RGW_OP_COMPLETE_MULTIPART <br>class RGWCompleteMultipart_ObjStore_S3</td>
</tr>
<tr>
<td>Abort MultiPart Upload</td>
<td>DELETE /{bucket}/{object}?uploadId= HTTP/1.1</td>
<td>RGW_OP_ABORT_MULTIPART <br>class RGWAbortMultipart_ObjStore_S3</td>
</tr>
</tbody>
</table>
<h2 id="如何访问对象存储？"><a href="#如何访问对象存储？" class="headerlink" title="如何访问对象存储？"></a>如何访问对象存储？</h2><h3 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h3><h5 id="Service"><a href="#Service" class="headerlink" title="Service:"></a>Service:</h5><ul>
<li>GET</li>
</ul>
<h5 id="Bucket"><a href="#Bucket" class="headerlink" title="Bucket:"></a>Bucket:</h5><ul>
<li>GET<ul>
<li>&lt;null&gt;</li>
<li>logging</li>
<li>location</li>
<li>versioning</li>
<li>acl</li>
<li>cors</li>
<li>uploads</li>
</ul>
</li>
<li>PUT<ul>
<li>&lt;null&gt;</li>
<li>logging</li>
<li>versioning</li>
<li>acl</li>
<li>cors</li>
</ul>
</li>
<li>DELETE<ul>
<li>&lt;null&gt;</li>
<li>cors</li>
</ul>
</li>
<li>HEAD<ul>
<li>&lt;null&gt;</li>
<li>acl</li>
<li>uploads</li>
</ul>
</li>
<li>POST<ul>
<li>&lt;null&gt;</li>
<li>delete</li>
</ul>
</li>
<li>OPTIONS<ul>
<li>&lt;null&gt;</li>
</ul>
</li>
</ul>
<h5 id="Object"><a href="#Object" class="headerlink" title="Object:"></a>Object:</h5><ul>
<li>GET<ul>
<li>&lt;null&gt;</li>
<li>acl</li>
<li>uploadId</li>
</ul>
</li>
<li>PUT<ul>
<li>acl</li>
<li>copy_source</li>
</ul>
</li>
<li>DELETE<ul>
<li>&lt;null&gt;</li>
<li>uploadId</li>
</ul>
</li>
<li>HEAD<ul>
<li>&lt;null&gt;</li>
<li>acl</li>
<li>uploadId</li>
</ul>
</li>
<li>POST<ul>
<li>uploadId</li>
<li>uploads</li>
</ul>
</li>
<li>OPTIONS<ul>
<li>&lt;null&gt;</li>
</ul>
</li>
</ul>
<h3 id="CLI命令行工具"><a href="#CLI命令行工具" class="headerlink" title="CLI命令行工具"></a>CLI命令行工具</h3><h5 id="s3cmd工具："><a href="#s3cmd工具：" class="headerlink" title="s3cmd工具："></a>s3cmd工具：</h5><pre><code>apt-get install s3cmd

s3cmd --configure

s3cmd --help
</code></pre><h3 id="SDK包"><a href="#SDK包" class="headerlink" title="SDK包"></a>SDK包</h3><pre><code>兼容AWS S3提供的SDK包，但有部分功能不支持。
</code></pre><h3 id="GUI管理界面"><a href="#GUI管理界面" class="headerlink" title="GUI管理界面"></a>GUI管理界面</h3><pre><code>需要前端支持添加GUI管理界面。 
</code></pre><h2 id="RadosGW的用户帐号"><a href="#RadosGW的用户帐号" class="headerlink" title="RadosGW的用户帐号"></a>RadosGW的用户帐号</h2><h3 id="user类型"><a href="#user类型" class="headerlink" title="user类型"></a>user类型</h3><pre><code>There are two user types:
</code></pre><ol>
<li><p><strong>User</strong>: The term ‘user’ reflects a user of the S3 interface.</p>
</li>
<li><p><strong>Subuser</strong>: The term ‘subuser’ reflects a user of the Swift interface. A subuser is associated to a user .<br><img src="/images/rgw-user.jpg" alt="rgw-user"></p>
</li>
</ol>
<h3 id="user操作"><a href="#user操作" class="headerlink" title="user操作"></a>user操作</h3><ol>
<li><p>CREATE A USER</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adosgw-admin user create --uid=&#123;username&#125; --display-name=<span class="string">"&#123;display-name&#125;"</span> \[--email=&#123;email&#125;\]</span><br></pre></td></tr></table></figure>
</li>
<li><p>GET USER INFO</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">radosgw-admin user info --uid=johndoe</span><br></pre></td></tr></table></figure>
</li>
<li><p>MODIFY USER INFO</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">radosgw-admin user modify --uid=johndoe --display-name=<span class="string">"John E. Doe"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>USER ENABLE/SUSPEND</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">radosgw-admin user <span class="built_in">suspend</span> --uid=johndoe</span><br><span class="line">radosgw-admin user <span class="built_in">enable</span> --uid=johndoe</span><br></pre></td></tr></table></figure>
</li>
<li><p>REMOVE A USER</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">radosgw-admin user rm --uid=johndoe</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="RadosGW兼容Keystone认证"><a href="#RadosGW兼容Keystone认证" class="headerlink" title="RadosGW兼容Keystone认证"></a>RadosGW兼容Keystone认证</h2><p>官网上指出RadosGW兼容Openstack KeyStone认证，<br><a href="http://docs.ceph.com/docs/hammer/radosgw/keystone/" target="_blank" rel="noopener"><em>http://docs.ceph.com/docs/hammer/radosgw/keystone/</em></a></p>
<p>但搜索发现Mirantis分析测试了RGW with Keystone，并不推荐这么做。</p>
<h3 id="RGW中S3的认证方式"><a href="#RGW中S3的认证方式" class="headerlink" title="RGW中S3的认证方式"></a>RGW中S3的认证方式</h3><ol>
<li><p>Keystone-based （disable default）</p>
<p> 如何配置：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[client.radosgw.gateway]</span><br><span class="line">	rgw s3 auth use keystone = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>RADOS-based（internal）</p>
</li>
</ol>
<h3 id="S3使用KeyStone认证的优缺点"><a href="#S3使用KeyStone认证的优缺点" class="headerlink" title="S3使用KeyStone认证的优缺点"></a>S3使用KeyStone认证的优缺点</h3><h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h5><ul>
<li><p>所有认证存储在统一的Keystone</p>
</li>
<li><p>不需要配置额外的S3认证管理系统，可以用Horizon替代</p>
</li>
</ul>
<h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h5><ul>
<li><p>需要提升Keystone的性能以支持S3的请求</p>
</li>
<li><p>因为Keystone认证方式优先于内部的RADOS认证，则打开Keystone认证会使所有的S3认证先走KeyStone认证方式，如果失败了再尝试RADOS认证。这样使得正常使用S3<br>RADOS认证的请求时延增大，影响S3的性能。</p>
</li>
<li><p>S3频繁访问Keystone服务，可能影响其他的Openstack service</p>
</li>
</ul>
<h3 id="我们如何使用"><a href="#我们如何使用" class="headerlink" title="我们如何使用?"></a>我们如何使用?</h3><p>个人推荐不使用Keystone认证S3的方式，而使用RadosGW内部的认证机制比较好。</p>
<p>但这样就引入了我们的注册用户如何使用S3的问题，结合阿里云，金山云，可以做如下实现：</p>
<ol>
<li><p>类似阿里云，用户默认不能使用S3功能，需要点击“开通对象存储”按钮。</p>
<p> 可以在开通对象存储过程中，给用户创建对应的S3 user和AccessKey/SecretKey对，与前端帐号信息绑定。</p>
</li>
<li><p>金山云用户注册后，登录对象存储跳转到单独的控制台界面，里面的帐号设置里就有两个AccessKey/SecretKey对。</p>
<p> 这种方式也需要AccessKey/SecretKey对与前端帐号信息绑定。</p>
</li>
</ol>
<h3 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h3><p><a href="https://content.mirantis.com/rs/451-RBY-185/images/Mirantis-Technical-Bulletin-S3-API-Keystone-integration-in-Ceph-RADOS-Gateway.pdf" target="_blank" rel="noopener">https://content.mirantis.com/rs/451-RBY-185/images/Mirantis-Technical-Bulletin-S3-API-Keystone-integration-in-Ceph-RADOS-Gateway.pdf</a><br><a href="http://dolphm.com/benchmarking-openstack-keystone-token-formats/" target="_blank" rel="noopener">http://dolphm.com/benchmarking-openstack-keystone-token-formats/</a></p>
<h2 id="RadosGW提供OSS服务功能"><a href="#RadosGW提供OSS服务功能" class="headerlink" title="RadosGW提供OSS服务功能"></a>RadosGW提供OSS服务功能</h2><p>基于上面的分析，使用RadosGW我们可以提供如下OSS功能，<br>对象存储OSSV1.0.0版本功能具体包括哪些？还需找再讨论确定。</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>描述</th>
<th>操作</th>
<th>Amazon</th>
<th>金山云</th>
<th>我们公司</th>
</tr>
</thead>
<tbody>
<tr>
<td>Service Operation</td>
<td>获取所有bucket信息</td>
<td>GET Service</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>Bucket Operation</td>
<td>Bucket基本操作</td>
<td>DELETE Bucket</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td></td>
<td>GET Bucket</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td></td>
<td>HEAD Bucket</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td></td>
<td>PUT Bucket</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td>Bucket cors相关操作</td>
<td>DELETE Bucket cors</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td></td>
<td>GET Bucket cors</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td></td>
<td>PUT Bucket cors</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td>Bucket lifecycle相关操作</td>
<td>DELETE Bucket lifecycle</td>
<td>√</td>
<td>×</td>
<td>×</td>
</tr>
<tr>
<td></td>
<td></td>
<td>GET Bucket lifecycle</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>PUT Bucket lifecycle</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Bucket policy相关操作</td>
<td>DELETE Bucket policy</td>
<td>√</td>
<td>×</td>
<td>×</td>
</tr>
<tr>
<td></td>
<td></td>
<td>GET Bucket policy</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>PUT Bucket policy</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Bucket tagging相关操作</td>
<td>DELETE Bucket tagging</td>
<td>√</td>
<td>×</td>
<td>×</td>
</tr>
<tr>
<td></td>
<td></td>
<td>GET Bucket tagging</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>PUT Bucket tagging</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Bucket website相关操作</td>
<td>DELETE Bucket website</td>
<td>√</td>
<td>×</td>
<td>hammer: ×</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>jewel: √</td>
</tr>
<tr>
<td></td>
<td></td>
<td>GET Bucket website</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>PUT Bucket website</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Bucket logging相关操作</td>
<td>GET Bucket logging</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td></td>
<td>PUT Bucket logging</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td>Bucket notification相关操作</td>
<td>GET Bucket notification</td>
<td>√</td>
<td>×</td>
<td>×</td>
</tr>
<tr>
<td></td>
<td></td>
<td>PUT Bucket notification</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Bucket versioning相关操作</td>
<td>GET Bucket versioning</td>
<td>√</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td></td>
<td>GET Bucket Object versions</td>
<td>√</td>
<td></td>
<td>hammer: ×</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>jewel: √</td>
</tr>
<tr>
<td></td>
<td></td>
<td>PUT Bucket versioning</td>
<td>√</td>
<td></td>
<td>√</td>
</tr>
<tr>
<td></td>
<td>Bucket acl相关操作</td>
<td>PUT Bucket acl</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td></td>
<td>GET Bucket acl</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td>Bucket requestPayment相关操作</td>
<td>GET Bucket requestPayment</td>
<td>√</td>
<td>×</td>
<td>hammer: ×</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>jewel: √</td>
</tr>
<tr>
<td></td>
<td></td>
<td>PUT Bucket requestPayment</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td></td>
<td>枚举该Bucket下的所有分块上传</td>
<td>List MultiPart Uploads</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>Object Operation</td>
<td>删除Object</td>
<td>DELETE Object</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td>删除多个Object</td>
<td>Delete Multiple Objects</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td>下载Object</td>
<td>GET Object</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td>获取Object ACL</td>
<td>GET Object ACL</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td>获取Object BT 种子</td>
<td>GET Object torrent</td>
<td>√</td>
<td>×</td>
<td>×</td>
</tr>
<tr>
<td></td>
<td>获取Object 元信息</td>
<td>HEAD Object</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td>Object对HTML5浏览器跨域支持</td>
<td>OPTIONS Object</td>
<td>√</td>
<td>×</td>
<td>×</td>
</tr>
<tr>
<td></td>
<td>浏览器表单上传Object</td>
<td>POST Object</td>
<td>√</td>
<td>√</td>
<td>×?</td>
</tr>
<tr>
<td></td>
<td>Amazon Glacier存储恢复</td>
<td>POST Object restore</td>
<td>√</td>
<td>×</td>
<td>×</td>
</tr>
<tr>
<td></td>
<td>上传Object</td>
<td>PUT Object</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td>设置Object ACL</td>
<td>PUT Object acl</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td>复制Object</td>
<td>PUT Object - Copy</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td>分块上传相关操作</td>
<td>Initiate Multipart Upload</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td></td>
<td>Upload Part</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td></td>
<td>Upload Part - Copy</td>
<td>√</td>
<td>×</td>
<td>×</td>
</tr>
<tr>
<td></td>
<td></td>
<td>Complete Multipart Upload</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td></td>
<td>Abort Multipart Upload</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td></td>
<td></td>
<td>List Parts</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>Image Thumbnail</td>
<td></td>
<td></td>
<td>×</td>
<td>√</td>
<td>×</td>
</tr>
</tbody>
</table>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/ictfox.jpg"
                alt="ictfox" />
            
              <p class="site-author-name" itemprop="name">ictfox</p>
              <p class="site-description motion-element" itemprop="description">学无止境</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">77</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">50</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/ictfox" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/smart_bruins" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://weibo.com/ictfox" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-weibo"></i>Weibo</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.askceph.com" title="Ceph问答社区" target="_blank">Ceph问答社区</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/for_tech" title="CSDN博客" target="_blank">CSDN博客</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ictfox</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://ictfox.disqus.com/count.js" async></script>
    

    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
