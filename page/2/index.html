<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="学无止境">
<meta property="og:type" content="website">
<meta property="og:title" content="ictfox blog">
<meta property="og:url" content="http://www.ictfox.cn/page/2/index.html">
<meta property="og:site_name" content="ictfox blog">
<meta property="og:description" content="学无止境">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ictfox blog">
<meta name="twitter:description" content="学无止境">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.ictfox.cn/page/2/"/>





  <title>ictfox blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ictfox blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">ForTech</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ictfox.cn/2017/11/16/linx-symbolic-hard-link/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/16/linx-symbolic-hard-link/" itemprop="url">Linux 软链接和硬链接</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-16T11:40:17+08:00">
                2017-11-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/11/16/linx-symbolic-hard-link/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/11/16/linx-symbolic-hard-link/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Linux系统中为了解决文件共享问题，引入了软链接和硬链接的概念，软链接又称符号链接，即<code>soft link</code>或<code>symbolic link</code>，硬链接即为<code>hard link</code>。<br>同时它们还带来了隐藏文件路径、增加权限安全及节省存储等好处。</p>
<p>若一个文件指向另一个文件，该文件的内容仅仅是另一个文件的<code>path</code>，则其为软链接。<br>若一个<code>inode号</code>对应多个文件名，则称这些文件为硬链接。换言之，硬链接就是同一个文件使用了多个别名。<br>软链接可由命令<code>ln</code>创建，硬链接可由命令<code>link或ln</code>创建。</p>
<h3 id="硬链接"><a href="#硬链接" class="headerlink" title="硬链接"></a>硬链接</h3><p>由于硬链接的文件是有着相同<code>inode号</code>，仅文件名不同，因此硬链接存在以下几点特性：</p>
<ul>
<li>文件有相同的<code>inode 和 data blocks</code></li>
<li>只能对文件创建硬链接，不能对目录创建硬链接</li>
<li>只能对已存在的文件创建硬链接</li>
<li>不能跨文件系统创建硬链接</li>
<li>删除一个硬链接文件并不影响其他有相同<code>inode号</code>的文件</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ ll</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 928 Nov 11 08:37 tstfile</span><br><span class="line">$ ln tstfile hlink</span><br><span class="line">$ ll</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r-- 2 root root 928 Nov 11 08:37 hlink</span><br><span class="line">-rw-r--r-- 2 root root 928 Nov 11 08:37 tstfile</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">stat</span> tstfile</span><br><span class="line">  File: ‘tstfile’</span><br><span class="line">  Size: 928       	Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: 803h/2051d	Inode: 4851726     Links: 2</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2017-11-11 08:37:07.554081068 +0800</span><br><span class="line">Modify: 2017-11-11 08:37:07.554081068 +0800</span><br><span class="line">Change: 2017-11-11 08:37:42.216988088 +0800</span><br><span class="line"> Birth: -</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">stat</span> hlink</span><br><span class="line">  File: ‘hlink’</span><br><span class="line">  Size: 928       	Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: 803h/2051d	Inode: 4851726     Links: 2</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2017-11-11 08:37:07.554081068 +0800</span><br><span class="line">Modify: 2017-11-11 08:37:07.554081068 +0800</span><br><span class="line">Change: 2017-11-11 08:37:42.216988088 +0800</span><br><span class="line"> Birth: -</span><br></pre></td></tr></table></figure>
<p>因为硬链接文件具有相同的地位，并没有谁指向谁之说，所以想要查找一个<code>inode号</code>对应的所有硬链接文件并不容易，通常需要遍历目录下所有的文件，系统里可通过<code>find</code>命令查找一个文件相关的所有硬链接文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir dir</span><br><span class="line">$ ln tstfile dir/hlink</span><br><span class="line"></span><br><span class="line">$ find ./ -samefile tstfile</span><br><span class="line">./dir/hlink</span><br><span class="line">./hlink</span><br><span class="line">./tstfile</span><br><span class="line"></span><br><span class="line">$ ls -i tstfile</span><br><span class="line">4851726 tstfile</span><br><span class="line">$ find ./ -inum 4851726</span><br><span class="line">./dir/hlink</span><br><span class="line">./hlink</span><br><span class="line">./tstfile</span><br></pre></td></tr></table></figure>
<p>可以通过命令<code>strace find ./ -samefile tstfile</code>查看具体执行的系统调用，发现该命令会在输入的目录下查询所有的文件，输出与参数文件<code>inode num</code>一致的文件，所以在目录里文件非常多时，该命令会非常耗时的。</p>
<h3 id="软连接"><a href="#软连接" class="headerlink" title="软连接"></a>软连接</h3><p>软链接与硬链接不同，若一个文件的数据块中存放的内容是另一文件的路径名时，则该文件就是软链接。<br>软链接就是一个普通文件，只是数据块内容有点特殊。<br>软链接有着自己的<code>inode</code>号以及数据块，因此软链接的创建与使用没有类似硬链接的诸多限制。</p>
<p><strong>软链接的特性如下：</strong></p>
<ul>
<li>软链接有自己的文件属性及权限等</li>
<li>可对不存在的文件或目录创建软链接</li>
<li>软链接可跨文件系统创建</li>
<li>软链接即可对文件创建，也可对目录创建</li>
<li>创建软链接后，链接计数<code>i_nlink</code>不会增加</li>
<li>删除软链接并不影响被指向的文件</li>
<li>若被指向的原文件被删除，则相关软连接被称为死链接(dangling link)，若被指向路径文件被重新创建，即恢复为正常的软链接</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ ln -s tstfile slink</span><br><span class="line">$ ll</span><br><span class="line">total 4</span><br><span class="line">lrwxrwxrwx 1 root root   7 Nov 11 08:39 slink -&gt; tstfile</span><br><span class="line">-rw-r--r-- 1 root root 928 Nov 11 08:37 tstfile</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">stat</span> tstfile</span><br><span class="line">  File: ‘tstfile’</span><br><span class="line">  Size: 928       	Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: 803h/2051d	Inode: 4851726     Links: 1</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2017-11-11 08:37:07.554081068 +0800</span><br><span class="line">Modify: 2017-11-11 08:37:07.554081068 +0800</span><br><span class="line">Change: 2017-11-11 08:39:04.749766771 +0800</span><br><span class="line"> Birth: -</span><br><span class="line"> </span><br><span class="line">$ <span class="built_in">stat</span> slink</span><br><span class="line">  File: ‘slink’ -&gt; ‘tstfile’</span><br><span class="line">  Size: 7         	Blocks: 0          IO Block: 4096   symbolic link</span><br><span class="line">Device: 803h/2051d	Inode: 4851778     Links: 1</span><br><span class="line">Access: (0777/lrwxrwxrwx)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2017-11-11 08:39:24.730713312 +0800</span><br><span class="line">Modify: 2017-11-11 08:39:22.901718205 +0800</span><br><span class="line">Change: 2017-11-11 08:39:22.901718205 +0800</span><br><span class="line"> Birth: -</span><br><span class="line"></span><br><span class="line">$ readlink slink</span><br><span class="line">tstfile</span><br></pre></td></tr></table></figure>
<h3 id="测试程序"><a href="#测试程序" class="headerlink" title="测试程序"></a>测试程序</h3><p>Linux里由命令<code>stat</code>来获取一个文件的状态，文件状态保持在数据结构<code>struct stat</code>里，定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> &#123;</span></span><br><span class="line">   <span class="keyword">dev_t</span>     st_dev;     <span class="comment">/* ID of device containing file */</span></span><br><span class="line">   <span class="keyword">ino_t</span>     st_ino;     <span class="comment">/* inode number */</span></span><br><span class="line">   <span class="keyword">mode_t</span>    st_mode;    <span class="comment">/* protection */</span></span><br><span class="line">   <span class="keyword">nlink_t</span>   st_nlink;   <span class="comment">/* number of hard links */</span></span><br><span class="line">   <span class="keyword">uid_t</span>     st_uid;     <span class="comment">/* user ID of owner */</span></span><br><span class="line">   <span class="keyword">gid_t</span>     st_gid;     <span class="comment">/* group ID of owner */</span></span><br><span class="line">   <span class="keyword">dev_t</span>     st_rdev;    <span class="comment">/* device ID (if special file) */</span></span><br><span class="line">   <span class="keyword">off_t</span>     st_size;    <span class="comment">/* total size, in bytes */</span></span><br><span class="line">   <span class="keyword">blksize_t</span> st_blksize; <span class="comment">/* blocksize for file system I/O */</span></span><br><span class="line">   <span class="keyword">blkcnt_t</span>  st_blocks;  <span class="comment">/* number of 512B blocks allocated */</span></span><br><span class="line">   <span class="keyword">time_t</span>    st_atime;   <span class="comment">/* time of last access */</span></span><br><span class="line">   <span class="keyword">time_t</span>    st_mtime;   <span class="comment">/* time of last modification */</span></span><br><span class="line">   <span class="keyword">time_t</span>    st_ctime;   <span class="comment">/* time of last status change */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中<code>st_mode</code>变量用来表示文件类型的，特征位的定义如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">S_IFMT     0170000   bit mask <span class="keyword">for</span> the file <span class="built_in">type</span> bit fields</span><br><span class="line">S_IFSOCK   0140000   socket</span><br><span class="line">S_IFLNK    0120000   symbolic link</span><br><span class="line">S_IFREG    0100000   regular file</span><br><span class="line">S_IFBLK    0060000   block device</span><br><span class="line">S_IFDIR    0040000   directory</span><br><span class="line">S_IFCHR    0020000   character device</span><br><span class="line">S_IFIFO    0010000   FIFO</span><br><span class="line">S_ISUID    0004000   <span class="built_in">set</span>-user-ID bit</span><br><span class="line">S_ISGID    0002000   <span class="built_in">set</span>-group-ID bit (see below)</span><br><span class="line">S_ISVTX    0001000   sticky bit (see below)</span><br><span class="line">S_IRWXU    00700     mask <span class="keyword">for</span> file owner permissions</span><br><span class="line">S_IRUSR    00400     owner has <span class="built_in">read</span> permission</span><br><span class="line">S_IWUSR    00200     owner has write permission</span><br><span class="line">S_IXUSR    00100     owner has execute permission</span><br><span class="line">S_IRWXG    00070     mask <span class="keyword">for</span> group permissions</span><br><span class="line">S_IRGRP    00040     group has <span class="built_in">read</span> permission</span><br><span class="line">S_IWGRP    00020     group has write permission</span><br><span class="line">S_IXGRP    00010     group has execute permission</span><br><span class="line">S_IRWXO    00007     mask <span class="keyword">for</span> permissions <span class="keyword">for</span> others (not <span class="keyword">in</span> group)</span><br><span class="line">S_IROTH    00004     others have <span class="built_in">read</span> permission</span><br><span class="line">S_IWOTH    00002     others have write permission</span><br><span class="line">S_IXOTH    00001     others have execute permission</span><br></pre></td></tr></table></figure>
<p>POSIX标准里定义了如下的宏来检查文件类型：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">S_ISREG(m)  is it a regular file?</span><br><span class="line">S_ISDIR(m)  directory?</span><br><span class="line">S_ISCHR(m)  character device?</span><br><span class="line">S_ISBLK(m)  block device?</span><br><span class="line">S_ISFIFO(m) FIFO (named pipe)?</span><br><span class="line">S_ISLNK(m)  symbolic link?  (Not <span class="keyword">in</span> POSIX.1-1996.)</span><br><span class="line">S_ISSOCK(m) socket?  (Not <span class="keyword">in</span> POSIX.1-1996.)</span><br></pre></td></tr></table></figure>
<p>结合上面的描述，我们可以写如下测试代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ cat file_stat.cc</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">fstat</span>;</span></span><br><span class="line">    <span class="built_in">string</span> file_path = argv[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="meta"># use lstat instead of stat as lstat handle symbolic link itself</span></span><br><span class="line">    <span class="meta"># when input path is a symbolic, not the file it refers to.</span></span><br><span class="line">    <span class="keyword">int</span> ret = lstat(file_path.c_str(), &amp;fstat);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"file path: "</span> &lt;&lt; file_path &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"file size: "</span> &lt;&lt; fstat.st_size &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"file ino: "</span> &lt;&lt; fstat.st_ino &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"file mode: "</span> &lt;&lt; fstat.st_mode &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"file nlink: "</span> &lt;&lt; fstat.st_nlink &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (S_ISREG(fstat.st_mode)) &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"regular file: "</span> &lt;&lt; file_path &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (S_ISLNK(fstat.st_mode)) &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"link file: "</span> &lt;&lt; file_path &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">256</span>];</span><br><span class="line">        ret = readlink(file_path.c_str(), buf, <span class="number">255</span>);</span><br><span class="line">        buf[ret] = <span class="string">'\0'</span>;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"readlink return "</span> &lt;&lt; ret &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"link file real path: "</span> &lt;&lt; buf &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//g++ -std=c++11 -ofile_stat file_stat.cc</span></span><br></pre></td></tr></table></figure>
<p>命令行输出</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ./file_stat hlink</span><br><span class="line">file path: hlink</span><br><span class="line">file size: 928</span><br><span class="line">file ino: 4851726</span><br><span class="line">file mode: 33188</span><br><span class="line">file nlink: 3</span><br><span class="line">regular file: hlink</span><br><span class="line"></span><br><span class="line">$ ./file_stat slink</span><br><span class="line">file path: slink</span><br><span class="line">file size: 7</span><br><span class="line">file ino: 4851778</span><br><span class="line">file mode: 41471</span><br><span class="line">file nlink: 1</span><br><span class="line">link file: slink</span><br><span class="line">readlink <span class="built_in">return</span> 7</span><br><span class="line">link file real path: tstfile</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-hardandsymb-links/index.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/linux/l-cn-hardandsymb-links/index.html</a><br><a href="http://www.giannistsakiris.com/2011/04/15/counting-and-listing-hard-links-on-linux/" target="_blank" rel="noopener">http://www.giannistsakiris.com/2011/04/15/counting-and-listing-hard-links-on-linux/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ictfox.cn/2017/11/06/aws-sdk-cpp-s3-introduction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/06/aws-sdk-cpp-s3-introduction/" itemprop="url">aws sdk cpp中S3相关的应用和示例</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-06T09:40:17+08:00">
                2017-11-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/s3/" itemprop="url" rel="index">
                    <span itemprop="name">s3</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/11/06/aws-sdk-cpp-s3-introduction/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/11/06/aws-sdk-cpp-s3-introduction/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>aws提供多种sdk去访问S3，包括java、go、php、js、ruby、net、c++等，本篇文章结合作者最近应用的实践，介绍aws sdk cpp中访问S3的使用，示例中包括对S3的基本put，get等操作。</p>
<p>在使用aws sdk cpp中，发现它还不是那么完善，很多对S3的操作都找不到示例，并且github上这部分的源码更新很快，估计也是在持续开发和完善中，建议读者在自己应用时，下载最新的sdk版本后测试。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>测试系统：CentOS Linux release 7.2.1511</p>
<ol>
<li><p>下载github上的sdk源码</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/aws/aws-sdk-cpp</span></span><br></pre></td></tr></table></figure>
<p> 或者直接下载zip压缩包后解压缩</p>
</li>
<li><p>安装依赖包</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc-c++</span><br><span class="line">yum install -y cmake</span><br><span class="line">yum install -y zlib-devel</span><br><span class="line">yum install -y openssl-devel</span><br><span class="line">yum install -y curl-devel</span><br></pre></td></tr></table></figure>
<p> Ubuntu系统上：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y g++</span><br><span class="line">apt-get install -y cmake</span><br><span class="line">apt-get install -y libssl-dev</span><br><span class="line">apt-get install -y libcurl4-openssl-dev</span><br><span class="line">apt-get install -y uuid-dev</span><br><span class="line">apt-get install -y libboost-all-dev</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装aws cpp sdk</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir build_dir</span><br><span class="line"><span class="built_in">cd</span> build_dir</span><br><span class="line">cmake -DCMAKE_BUILD_TYPE=Release ../aws-sdk-cpp</span><br><span class="line"></span><br><span class="line"><span class="comment"># just make and install core and s3</span></span><br><span class="line">make -j `nproc` -C aws-cpp-sdk-core</span><br><span class="line">make -j `nproc` -C aws-cpp-sdk-s3</span><br><span class="line">make install -C aws-cpp-sdk-core</span><br><span class="line">make install -C aws-cpp-sdk-s3</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="基本代码"><a href="#基本代码" class="headerlink" title="基本代码"></a>基本代码</h3><p>要使用aws c++ sdk，必须包含如下基本代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;aws/core/Aws.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   Aws::SDKOptions options;</span><br><span class="line">   Aws::InitAPI(options);</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">// make your SDK calls here.</span></span><br><span class="line">   &#125;</span><br><span class="line">   Aws::ShutdownAPI(options);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用aws s3 client来访问对象存储</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Aws::Client::ClientConfiguration cfg;</span><br><span class="line">cfg.endpointOverride = <span class="string">"your s3 endpoint"</span>;</span><br><span class="line">cfg.scheme = Aws::Http::Scheme::HTTP;</span><br><span class="line">cfg.connectTimeoutMs = <span class="number">100000</span>;</span><br><span class="line">cfg.requestTimeoutMs = <span class="number">100000</span>;</span><br><span class="line"></span><br><span class="line">Aws::Auth::<span class="function">AWSCredentials <span class="title">cred</span><span class="params">(<span class="string">"your access key"</span>, <span class="string">"your secret key"</span>)</span></span>;</span><br><span class="line"><span class="function">S3Client <span class="title">client</span><span class="params">(cred, cfg, <span class="literal">false</span>, <span class="literal">false</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Then you can use this client object to access s3 object</span></span><br></pre></td></tr></table></figure>
<h3 id="示例1-list-bucket"><a href="#示例1-list-bucket" class="headerlink" title="示例1 - list bucket"></a>示例1 - list bucket</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cat aws-s3-bucket.cpp</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;aws/s3/S3Client.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;aws/core/Aws.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;aws/core/auth/AWSCredentialsProvider.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Aws::S3;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Aws::S3::Model;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Aws::SDKOptions options;</span><br><span class="line">    Aws::InitAPI(options);</span><br><span class="line"></span><br><span class="line">    Aws::Client::ClientConfiguration cfg;</span><br><span class="line">    cfg.endpointOverride = <span class="string">"..."</span>;</span><br><span class="line">    cfg.scheme = Aws::Http::Scheme::HTTP;</span><br><span class="line"></span><br><span class="line">    Aws::Auth::<span class="function">AWSCredentials <span class="title">cred</span><span class="params">(<span class="string">"..."</span>, <span class="string">"..."</span>)</span></span>;</span><br><span class="line">    <span class="function">S3Client <span class="title">client</span><span class="params">(cred, cfg, <span class="literal">false</span>, <span class="literal">false</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> response = client.ListBuckets();</span><br><span class="line">    <span class="keyword">if</span> (response.IsSuccess()) &#123;</span><br><span class="line">        <span class="keyword">auto</span> buckets = response.GetResult().GetBuckets();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> iter = buckets.begin(); iter != buckets.end(); ++iter) &#123;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; iter-&gt;GetName() &lt;&lt; <span class="string">"\t"</span></span><br><span class="line">                 &lt;&lt; iter-&gt;GetCreationDate().ToLocalTimeString(Aws::Utils::DateFormat::ISO_8601) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"Error while ListBuckets "</span> &lt;&lt; response.GetError().GetExceptionName()</span><br><span class="line">            &lt;&lt; <span class="string">" "</span> &lt;&lt; response.GetError().GetMessage() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Aws::ShutdownAPI(options);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="示例2-get-object"><a href="#示例2-get-object" class="headerlink" title="示例2 - get object"></a>示例2 - get object</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Get object range content to local file</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> S3Storage::get_object_to_file(<span class="keyword">const</span> S3Client &amp;client,</span><br><span class="line">                    				 <span class="keyword">const</span> Aws::String bucket,</span><br><span class="line">                               	 <span class="keyword">const</span> Aws::String object,</span><br><span class="line">                                 	 <span class="keyword">const</span> <span class="built_in">string</span> &amp;file_name,</span><br><span class="line">                               	 <span class="keyword">const</span> <span class="keyword">uint64_t</span> offset,</span><br><span class="line">                       			  	 <span class="keyword">uint64_t</span> length)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    GetObjectRequest request;</span><br><span class="line">    request.WithBucket(bucket).WithKey(object);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> range = S3_RANGE_STRING(offset, length);</span><br><span class="line">    request.SetRange(range.c_str());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> outcome = client.GetObject(request);</span><br><span class="line">    <span class="keyword">if</span>(!outcome.IsSuccess()) &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"GetObject error: "</span> &lt;&lt;</span><br><span class="line">            outcome.GetError().GetExceptionName() &lt;&lt; <span class="string">" - "</span> &lt;&lt;</span><br><span class="line">            outcome.GetError().GetMessage() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Aws::OFStream local_file;</span><br><span class="line">    local_file.open(file_name.c_str(), <span class="built_in">std</span>::ios::in | <span class="built_in">std</span>::ios::out | <span class="built_in">std</span>::ios::binary);</span><br><span class="line">    assert(local_file.good());</span><br><span class="line">    local_file.seekp(offset, <span class="built_in">std</span>::ios::beg);</span><br><span class="line">    local_file &lt;&lt; outcome.GetResult().GetBody().rdbuf();</span><br><span class="line">    local_file.close();</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="示例2-put-object"><a href="#示例2-put-object" class="headerlink" title="示例2 - put object"></a>示例2 - put object</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Put whole file to s3 object</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> S3Storage::put_object_from_file(<span class="keyword">const</span> S3Client &amp;client,</span><br><span class="line">										   <span class="keyword">const</span> Aws::String bucket,</span><br><span class="line">                                    <span class="keyword">const</span> Aws::String object,</span><br><span class="line">                                    <span class="keyword">const</span> <span class="built_in">string</span> &amp;file_name)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    PutObjectRequest request;</span><br><span class="line">    request.WithKey(object).WithBucket(bucket);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> input_data = Aws::MakeShared&lt;Aws::FStream&gt;(<span class="string">"PutObjectInputStream"</span>,</span><br><span class="line">                file_name.c_str(), <span class="built_in">std</span>::ios_base::in | <span class="built_in">std</span>::ios_base::binary);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//set the stream that will be put to s3</span></span><br><span class="line">    request.SetBody(input_data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> outcome = client.PutObject(request);</span><br><span class="line">    <span class="keyword">if</span>(outcome.IsSuccess()) &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"Put object succeeded!"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"PutObject error: "</span> &lt;&lt;</span><br><span class="line">             outcome.GetError().GetExceptionName() &lt;&lt; <span class="string">" - "</span> &lt;&lt;</span><br><span class="line">             outcome.GetError().GetMessage() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因有需要读取文件的一部分内容，然后上传到S3上的一个object，查询了好多资料没找到示例，最后翻阅aws cpp sdk的源码，参考相关的实现，花费了很多时间才试验出来，贴给有相同需要的朋友。。。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Put one file slice to s3 object</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">int</span> S3Storage::put_object_from_file_slice(<span class="keyword">const</span> S3Client &amp;client,</span><br><span class="line">										          <span class="keyword">const</span> Aws::String bucket,</span><br><span class="line">                                           <span class="keyword">const</span> Aws::String object,</span><br><span class="line">                                           <span class="keyword">const</span> <span class="built_in">string</span> &amp;file_name,</span><br><span class="line">                                           <span class="keyword">const</span> <span class="keyword">uint64_t</span> offset,</span><br><span class="line">                                           <span class="keyword">const</span> <span class="keyword">uint64_t</span> length)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="comment">// Upload file with slices to s3 paralleled</span></span><br><span class="line">    PutObjectRequest request;</span><br><span class="line">    request.WithKey(object).WithBucket(bucket);</span><br><span class="line"></span><br><span class="line">    Aws::FStream local_file;</span><br><span class="line">    local_file.open(file_name.c_str(), <span class="built_in">std</span>::ios::in | <span class="built_in">std</span>::ios::binary);</span><br><span class="line">    assert(local_file.good());</span><br><span class="line"></span><br><span class="line">    Array&lt;<span class="keyword">uint8_t</span>&gt; file_contents(length);</span><br><span class="line">    local_file.seekg(offset, <span class="built_in">std</span>::ios::beg);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"file read offset "</span> &lt;&lt; local_file.tellg() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    local_file.read((<span class="keyword">char</span>*)file_contents.GetUnderlyingData(),</span><br><span class="line">                    file_contents.GetLength());</span><br><span class="line">    local_file.close();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//set the stream that will be put to s3</span></span><br><span class="line">    <span class="keyword">auto</span> sbuff = Aws::New&lt;Aws::Utils::Stream::PreallocatedStreamBuf&gt;(CLASS_TAG,</span><br><span class="line">                                    &amp;file_contents, file_contents.GetLength());</span><br><span class="line">    <span class="keyword">auto</span> sbody = Aws::MakeShared&lt;Aws::IOStream&gt;(<span class="string">"whatever string"</span>, sbuff);</span><br><span class="line">    request.SetBody(sbody);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> outcome = client.PutObject(request);</span><br><span class="line">    <span class="keyword">if</span>(outcome.IsSuccess()) &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"Put object succeeded!"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"PutObject error: "</span> &lt;&lt;</span><br><span class="line">                outcome.GetError().GetExceptionName() &lt;&lt; <span class="string">" - "</span> &lt;&lt;</span><br><span class="line">                outcome.GetError().GetMessage() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://docs.aws.amazon.com/zh_cn/sdk-for-cpp/v1/developer-guide/welcome.html" target="_blank" rel="noopener">http://docs.aws.amazon.com/zh_cn/sdk-for-cpp/v1/developer-guide/welcome.html</a><br><a href="https://github.com/aws/aws-sdk-cpp" target="_blank" rel="noopener">https://github.com/aws/aws-sdk-cpp</a><br><a href="http://alientechlab.com/aws-sdk-cpp-part-1/" target="_blank" rel="noopener">http://alientechlab.com/aws-sdk-cpp-part-1/</a><br><a href="http://www.cnblogs.com/qiuyi21/p/7239129.html" target="_blank" rel="noopener">http://www.cnblogs.com/qiuyi21/p/7239129.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ictfox.cn/2017/10/25/one-issue-about-c++-fstream/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/25/one-issue-about-c++-fstream/" itemprop="url">使用c++ fstream时遇到的一个问题与分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-25T08:40:17+08:00">
                2017-10-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/c/" itemprop="url" rel="index">
                    <span itemprop="name">c++</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/25/one-issue-about-c++-fstream/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/10/25/one-issue-about-c++-fstream/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在用c++的<code>fstream</code>时遇到一个很奇怪的问题，记录和分析过程如下。</p>
<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>两个文件，一个122k（file-bak），一个100k(file)，<code>file</code>是<code>file-bak</code>的前100k的内容，需要从<code>file-bak</code>里读取后面的22k数据，写入<code>file</code>的后面，然后对比<code>file</code>和<code>file-bak</code>，数据应该一致。</p>
<h2 id="c-实现"><a href="#c-实现" class="headerlink" title="c++实现"></a>c++实现</h2><h3 id="实现1"><a href="#实现1" class="headerlink" title="实现1"></a>实现1</h3><p>打开<code>ofile</code>后调用：<code>ofile.seekp(102400, ios::beg)</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">22168</span>];</span><br><span class="line"></span><br><span class="line">    <span class="function">ifstream <span class="title">ifile</span><span class="params">(<span class="string">"file2-bak"</span>, <span class="built_in">std</span>::ios_base::in | <span class="built_in">std</span>::ios_base::binary)</span></span>;</span><br><span class="line">    ifile.seekg(<span class="number">102400</span>);</span><br><span class="line">    ifile.read(buffer, <span class="number">22168</span>);</span><br><span class="line">    ifile.close();</span><br><span class="line"></span><br><span class="line">    ofstream ofile;</span><br><span class="line">    ofile.open(<span class="string">"file2"</span>, <span class="built_in">std</span>::ios_base::out | <span class="built_in">std</span>::ios_base::binary);</span><br><span class="line">    ofile.seekp(<span class="number">102400</span>, ios::beg);	<span class="comment">// seek to offset 102400 from begin</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; ofile.tellp() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    ofile.write(buffer, <span class="number">22168</span>);</span><br><span class="line">    ofile.close();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译运行如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># g++ -std=c++11 -o fstream_tst fstream_tst.cc</span></span><br><span class="line"><span class="comment"># ll -h file*</span></span><br><span class="line">-rw-r--r-- 1 root root 100K Oct 18 17:53 file</span><br><span class="line">-rw-r--r-- 1 root root 122K Oct 18 15:18 file-bak</span><br><span class="line"><span class="comment"># ./fstream_tst</span></span><br><span class="line">102400</span><br><span class="line"><span class="comment"># ll -h file*</span></span><br><span class="line">-rw-r--r-- 1 root root 100K Oct 18 17:56 file</span><br><span class="line">-rw-r--r-- 1 root root 122K Oct 18 15:18 file-bak</span><br><span class="line"><span class="comment"># diff file1 file-bak</span></span><br><span class="line">Binary files file and file-bak differ</span><br></pre></td></tr></table></figure>
<p><strong>结果异常</strong></p>
<h3 id="实现2"><a href="#实现2" class="headerlink" title="实现2"></a>实现2</h3><p>打开<code>ofile</code>后调用：<code>ofile.seekp(0, ios::end)</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">22168</span>];</span><br><span class="line"></span><br><span class="line">    <span class="function">ifstream <span class="title">ifile</span><span class="params">(<span class="string">"file2-bak"</span>, <span class="built_in">std</span>::ios_base::in | <span class="built_in">std</span>::ios_base::binary)</span></span>;</span><br><span class="line">    ifile.seekg(<span class="number">102400</span>);</span><br><span class="line">    ifile.read(buffer, <span class="number">22168</span>);</span><br><span class="line">    ifile.close();</span><br><span class="line"></span><br><span class="line">    ofstream ofile;</span><br><span class="line">    ofile.open(<span class="string">"file2"</span>, <span class="built_in">std</span>::ios_base::out | <span class="built_in">std</span>::ios_base::binary);</span><br><span class="line">    ofile.seekp(<span class="number">0</span>, ios::end); 	<span class="comment">// seek to the end of the file</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; ofile.tellp() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    ofile.write(buffer, <span class="number">22168</span>);</span><br><span class="line">    ofile.close();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译运行如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># g++ -std=c++11 -o fstream_tst fstream_tst.cc</span></span><br><span class="line"><span class="comment"># ll -h file*</span></span><br><span class="line">-rw-r--r-- 1 root root 100K Oct 18 18:01 file</span><br><span class="line">-rw-r--r-- 1 root root 122K Oct 18 15:18 file-bak</span><br><span class="line"><span class="comment"># ./fstream_tst</span></span><br><span class="line">0</span><br><span class="line"><span class="comment"># ll -h file*</span></span><br><span class="line">-rw-r--r-- 1 root root  22K Oct 18 18:05 file</span><br><span class="line">-rw-r--r-- 1 root root 122K Oct 18 15:18 file-bak</span><br><span class="line"><span class="comment"># diff file1 file-bak</span></span><br><span class="line">Binary files file and file-bak differ</span><br></pre></td></tr></table></figure>
<p><strong>结果异常</strong></p>
<blockquote>
<p>很奇怪为啥 ofile.seekp(0, ios::end); 后 ofile.tellp() 的输出为0</p>
</blockquote>
<h3 id="实现3"><a href="#实现3" class="headerlink" title="实现3"></a>实现3</h3><p>打开<code>ofile</code>时指定：<code>std::ios_base::out | std::ios_base::binary | std::ios_base::app</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">22168</span>];</span><br><span class="line"></span><br><span class="line">    <span class="function">ifstream <span class="title">ifile</span><span class="params">(<span class="string">"file2-bak"</span>, <span class="built_in">std</span>::ios_base::in | <span class="built_in">std</span>::ios_base::binary)</span></span>;</span><br><span class="line">    ifile.seekg(<span class="number">102400</span>);</span><br><span class="line">    ifile.read(buffer, <span class="number">22168</span>);</span><br><span class="line">    ifile.close();</span><br><span class="line"></span><br><span class="line">    ofstream ofile;</span><br><span class="line">    ofile.open(<span class="string">"file2"</span>, <span class="built_in">std</span>::ios_base::out | <span class="built_in">std</span>::ios_base::binary | <span class="built_in">std</span>::ios_base::app);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; ofile.tellp() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    ofile.write(buffer, <span class="number">22168</span>);</span><br><span class="line">    ofile.close();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译运行如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># g++ -std=c++11 -o fstream_tst fstream_tst.cc</span></span><br><span class="line"><span class="comment"># ll -h file*</span></span><br><span class="line">-rw-r--r-- 1 root root 100K Oct 18 18:12 file</span><br><span class="line">-rw-r--r-- 1 root root 122K Oct 18 15:18 file-bak</span><br><span class="line"><span class="comment"># ./fstream_tst</span></span><br><span class="line">102400</span><br><span class="line"><span class="comment"># ll -h file*</span></span><br><span class="line">-rw-r--r-- 1 root root 122K Oct 18 18:15 file</span><br><span class="line">-rw-r--r-- 1 root root 122K Oct 18 15:18 file-bak</span><br><span class="line"><span class="comment"># diff file1 file-bak</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p><strong>结果正常</strong></p>
<h2 id="c实现"><a href="#c实现" class="headerlink" title="c实现"></a>c实现</h2><p>代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">22168</span>];</span><br><span class="line"></span><br><span class="line">    FILE *fpr = fopen(<span class="string">"file-bak"</span>, <span class="string">"rb"</span>);</span><br><span class="line">    fseek(fpr, <span class="number">102400</span>, SEEK_SET);</span><br><span class="line">    fread(buffer, <span class="keyword">sizeof</span>(<span class="keyword">char</span>), <span class="number">22168</span>, fpr);</span><br><span class="line">    fclose(fpr);</span><br><span class="line"></span><br><span class="line">    FILE *fpw = fopen(<span class="string">"file"</span>, <span class="string">"rwb+"</span>);</span><br><span class="line">    fseek(fpw, <span class="number">102400</span>, SEEK_SET);</span><br><span class="line">    fwrite(buffer, <span class="keyword">sizeof</span>(<span class="keyword">char</span>), <span class="number">22168</span>, fpw);</span><br><span class="line">    fclose(fpw);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译运行如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gcc -o fstream_tst fstream_tst.c</span></span><br><span class="line"><span class="comment"># ll -h file*</span></span><br><span class="line">-rw-r--r-- 1 root root 100K Oct 18 18:23 file</span><br><span class="line">-rw-r--r-- 1 root root 122K Oct 18 15:18 file-bak</span><br><span class="line"><span class="comment"># ./fstream_tst</span></span><br><span class="line"><span class="comment"># ll -h file*</span></span><br><span class="line">-rw-r--r-- 1 root root 122K Oct 18 18:25 file</span><br><span class="line">-rw-r--r-- 1 root root 122K Oct 18 15:18 file-bak</span><br><span class="line"><span class="comment"># diff file1 file-bak</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p><strong>结果正常</strong></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>用c++代码的<code>实现1</code>分析如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># strace ./fstream_tst</span></span><br><span class="line">...</span><br><span class="line">open(<span class="string">"file-bak"</span>, O_RDONLY)              = 3</span><br><span class="line">lseek(3, 102400, SEEK_SET)               = 102400</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">"4318\n4319\n4320\n4321\n4322\n4323\n43"</span>..., 22168) = 22168</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(<span class="string">"file"</span>, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 3</span><br><span class="line">lseek(3, 102400, SEEK_SET)               = 102400</span><br><span class="line">lseek(3, 0, SEEK_CUR)                   = 102400</span><br><span class="line">fstat(1, &#123;st_mode=S_IFCHR|0620, st_rdev=makedev(136, 0), ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f81ce101000</span><br><span class="line">write(1, <span class="string">"102400\n"</span>, 6102400</span><br><span class="line">)                  = 6</span><br><span class="line">writev(3, [&#123;NULL, 0&#125;, &#123;<span class="string">"4318\n4319\n4320\n4321\n4322\n4323\n43"</span>..., 22168&#125;], 2) = 22168</span><br><span class="line">close(3)</span><br></pre></td></tr></table></figure>
<p>从上面可以看出编译后的可执行文件在打开要写入的文件时调用的是：<code>open(&quot;file&quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 3</code></p>
<p><strong>好奇怪为啥译后可执行文件执行open系统调用加了truncate标记！</strong></p>
<p>网上搜索了好久，没找到相关的解释，于是翻看《C++ Primer》圣书，找到如下说明，也明白了原因：</p>
<ul>
<li>默认 <code>ofstream</code>流对象关联的文件将以<code>out模式</code>打开，使文件可写；以<code>out模式</code>打开的文件会被情况：丢弃该文件存储的所有数据；</li>
<li>所以从效果上来看，为<code>ofstream</code>对象指定<code>out模式</code>等效于同时指定了<code>out和trunc模式</code></li>
</ul>
<p>针对分析到的原因，修改代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">22168</span>];</span><br><span class="line"></span><br><span class="line">    <span class="function">ifstream <span class="title">ifile</span><span class="params">(<span class="string">"file2-bak"</span>, <span class="built_in">std</span>::ios_base::in | <span class="built_in">std</span>::ios_base::binary)</span></span>;</span><br><span class="line">    ifile.seekg(<span class="number">102400</span>);</span><br><span class="line">    ifile.read(buffer, <span class="number">22168</span>);</span><br><span class="line">    ifile.close();</span><br><span class="line"></span><br><span class="line">    ofstream ofile;</span><br><span class="line">    ofile.open(<span class="string">"file2"</span>, <span class="built_in">std</span>::ios_base::in | <span class="built_in">std</span>::ios_base::out | <span class="built_in">std</span>::ios_base::binary);</span><br><span class="line">    ofile.seekp(<span class="number">102400</span>, ios::beg);	<span class="comment">// seek to offset 102400 from begin</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; ofile.tellp() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    ofile.write(buffer, <span class="number">22168</span>);</span><br><span class="line">    ofile.close();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译运行如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gcc -o fstream_tst fstream_tst.c</span></span><br><span class="line"><span class="comment"># ll -h file*</span></span><br><span class="line">-rw-r--r-- 1 root root 100K Oct 19 12:03 file</span><br><span class="line">-rw-r--r-- 1 root root 122K Oct 18 15:18 file-bak</span><br><span class="line"><span class="comment"># ./fstream_tst</span></span><br><span class="line">102400</span><br><span class="line"><span class="comment"># ll -h file*</span></span><br><span class="line">-rw-r--r-- 1 root root 122K Oct 19 12:04 file</span><br><span class="line">-rw-r--r-- 1 root root 122K Oct 18 15:18 file-bak</span><br><span class="line"><span class="comment"># diff file1 file-bak</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p><strong>结果正常</strong></p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>经过这么大半天的测试分析查找，稍微明白了C++的<code>fstream</code>的使用，还真是不能直接想当然的拿C的那一套来推测。。。坑啊！</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://www.runoob.com/cplusplus/cpp-files-streams.html" target="_blank" rel="noopener">http://www.runoob.com/cplusplus/cpp-files-streams.html</a><br><a href="https://stackoverflow.com/questions/34238063/c-seekp0-iosend-not-working" target="_blank" rel="noopener">https://stackoverflow.com/questions/34238063/c-seekp0-iosend-not-working</a><br><a href="https://stackoverflow.com/questions/29593940/why-is-an-fstream-truncated-when-it-is-opened-with-the-flags-iosate-and-ioso" target="_blank" rel="noopener">https://stackoverflow.com/questions/29593940/why-is-an-fstream-truncated-when-it-is-opened-with-the-flags-iosate-and-ioso</a><br><a href="https://social.msdn.microsoft.com/Forums/vstudio/en-US/8f121287-539f-4fe1-96b6-db3e5b9306f4/vc10-using-stdofstream-truncates-file-without-trunc" target="_blank" rel="noopener">https://social.msdn.microsoft.com/Forums/vstudio/en-US/8f121287-539f-4fe1-96b6-db3e5b9306f4/vc10-using-stdofstream-truncates-file-without-trunc</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ictfox.cn/2017/10/19/g3log-introduction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/19/g3log-introduction/" itemprop="url">一个开源的C++日志框架-G3log的简单示例</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-19T08:41:17+08:00">
                2017-10-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tools/" itemprop="url" rel="index">
                    <span itemprop="name">tools</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/19/g3log-introduction/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/10/19/g3log-introduction/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>G3log 是一个开源、支持跨平台的异步 C++ 日志框架，支持自定义日志格式。基于 g2log 构建，提升了性能，支持自定义格式。</p>
<p>G3log 主要特性：</p>
<ul>
<li>日志和契约式设计框架</li>
<li>异步调用</li>
<li>线程安全</li>
<li>队列式日志</li>
<li>捕获和记录 SIGSEGV 以及其他严重的信号</li>
<li>在 Linux/OSX 上严重的信号会生成堆栈记录</li>
<li>G3log 跨平台，支持  Windows, Linux 和 OSX</li>
</ul>
<p>链接：<a href="https://github.com/KjellKod/g3log" target="_blank" rel="noopener">https://github.com/KjellKod/g3log</a></p>
<h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><p>从github上下载 g3log 源码</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd g3log</span></span><br><span class="line"><span class="comment"># cd 3rdParty/gtest</span></span><br><span class="line"><span class="comment"># unzip gtest-1.7.0.zip</span></span><br><span class="line"><span class="comment"># cd ../../</span></span><br><span class="line"><span class="comment"># mkdir build</span></span><br><span class="line"><span class="comment"># cd build</span></span><br></pre></td></tr></table></figure>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cmake -DCMAKE_BUILD_TYPE=Release ..</span></span><br><span class="line"><span class="comment"># make</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>当前g3log默认使用的是c++14，若系统用的是c++11，则把目录下所有的c++14都替换为c++11后即可；</p>
</blockquote>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sudo make install</span></span><br><span class="line">[ 60%] Built target g3logger</span><br><span class="line">[ 73%] Built target g3log-FATAL-contract</span><br><span class="line">[ 86%] Built target g3log-FATAL-sigsegv</span><br><span class="line">[100%] Built target g3log-FATAL-choice</span><br><span class="line">Install the project...</span><br><span class="line">-- Install configuration: <span class="string">"Release"</span></span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/lib/libg3logger.so.1.3.0-0</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/lib/libg3logger.so</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/active.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/atomicbool.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/crashhandler.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/filesink.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/future.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/g3log.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/logcapture.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/loglevels.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/logmessage.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/logworker.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/moveoncopy.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/shared_queue.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/sink.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/sinkhandle.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/sinkwrapper.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/stacktrace_windows.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/std2_make_unique.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/stlpatch_future.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/time.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/g2log.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/include/g3log/generated_definitions.hpp</span><br><span class="line">-- Up-to-date: /usr/<span class="built_in">local</span>/lib/cmake/g3logger/g3loggerConfig.cmake</span><br></pre></td></tr></table></figure>
<h2 id="使用g3log"><a href="#使用g3log" class="headerlink" title="使用g3log"></a>使用g3log</h2><h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><p>文件：g3log_tst.cc</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g3log/g3log.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g3log/logworker.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> path_to_log_file = <span class="string">"/tmp/"</span>;</span><br><span class="line"><span class="built_in">string</span> log_file = <span class="string">"g3log_file"</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;g3::LogWorker&gt; worker;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">log_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    worker = g3::LogWorker::createLogWorker();</span><br><span class="line">    <span class="keyword">auto</span> handle = worker-&gt;addDefaultLogger(log_file, path_to_log_file);</span><br><span class="line">    g3::initializeLogging(worker.get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">log_shutdown</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    g3::internal::shutDownLogging();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    log_init();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// use LOGF which like printf</span></span><br><span class="line">    LOGF(INFO, <span class="string">"Hi log %d"</span>, <span class="number">123</span>);</span><br><span class="line">    LOGF(WARNING, <span class="string">"Printf-style syntax is also %s"</span>, <span class="string">"available”);</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    // use LOG wich like std::cout</span></span><br><span class="line"><span class="string">    LOG(INFO) &lt;&lt; "</span>Hi <span class="string">" &lt;&lt; "</span>LOG<span class="string">";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    log_shutdown();</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>编译运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># g++ -std=c++11 -Wl,-rpath,/usr/local/lib -lg3logger -og3log_tst g3log_tst.cc</span></span><br><span class="line"><span class="comment"># ./g3log_tst</span></span><br><span class="line">g3log g3FileSink shutdown at: 14:56:51 332071</span><br><span class="line">Log file at: [/tmp/g3log_file.g3log.20171011-145651.log]</span><br></pre></td></tr></table></figure>
<p>查看log文件内容：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /tmp/g3log_file.g3log.20171011-145651.log</span></span><br><span class="line">        g3log created <span class="built_in">log</span> at: Wed Oct 11 14:56:51 2017</span><br><span class="line">                LOG format: [YYYY/MM/DD hh:mm:ss uuu* LEVEL FILE-&gt;FUNCTION:LINE] message        (uuu*: microseconds fractions of the seconds value)</span><br><span class="line"></span><br><span class="line">    2017/10/11 14:56:51 046351    INFO [g3log_tst.cc-&gt;main:29]    Hi <span class="built_in">log</span> 123</span><br><span class="line">    2017/10/11 14:56:51 046376    WARNING [g3log_tst.cc-&gt;main:30]    Printf-style syntax is also available</span><br><span class="line">    2017/10/11 14:56:51 046413    INFO [g3log_tst.cc-&gt;main:33]    Hi LOG</span><br><span class="line">    g3log g3FileSink shutdown at: 14:56:51 046529</span><br></pre></td></tr></table></figure>
<h2 id="g3log的动态log-level"><a href="#g3log的动态log-level" class="headerlink" title="g3log的动态log level"></a>g3log的动态log level</h2><p>g3log支持dynamic logging level，默认是关闭的，若需要使用，在编译g3log时打开。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cmake -DCMAKE_BUILD_TYPE=Release -DUSE_DYNAMIC_LOGGING_LEVELS=ON ../</span></span><br></pre></td></tr></table></figure>
<p>在文件 <code>g3log/loglevels.hpp</code> 里有各个log level的定义：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> g3 &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kDebugValue = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kInfoValue = <span class="number">300</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kWarningValue = <span class="number">500</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kFatalValue = <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kInternalFatalValue = <span class="number">2000</span>;</span><br><span class="line">&#125; <span class="comment">// g3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> LEVELS G3LOG_DEBUG&#123;g3::kDebugValue, &#123;<span class="string">"DEBUG"</span>&#125;&#125;,</span><br><span class="line">      INFO &#123;g3::kInfoValue, &#123;<span class="string">"INFO"</span>&#125;&#125;,</span><br><span class="line">      WARNING &#123;g3::kWarningValue, &#123;<span class="string">"WARNING"</span>&#125;&#125;,</span><br><span class="line">      FATAL &#123;g3::kFatalValue, &#123;<span class="string">"FATAL"</span>&#125;&#125;;</span><br></pre></td></tr></table></figure>
<p>设置log level的定义为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> log_levels &#123;</span><br><span class="line">    <span class="comment">/// Enable log level &gt;= log_level.</span></span><br><span class="line">    <span class="comment">/// log levels below will be disabled</span></span><br><span class="line">    <span class="comment">/// log levels equal or higher will be enabled.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setHighest</span><span class="params">(LEVELS level)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(LEVELS level, <span class="keyword">bool</span> enabled)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">disable</span><span class="params">(LEVELS level)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">enable</span><span class="params">(LEVELS level)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// WARNING: This will also disable FATAL events from being logged</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">disableAll</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">enableAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// print all levels with their disabled or enabled status</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">to_string</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="keyword">int</span>, g3::LoggingLevel&gt; levelsToPrint)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// print snapshot of system levels with their</span></span><br><span class="line">    <span class="comment">/// disabled or enabled status</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">to_string</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Snapshot view of the current logging levels' status</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="keyword">int</span>, g3::LoggingLevel&gt; getAll();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">status</span> &#123;</span>Absent, Enabled, Disabled&#125;;</span><br><span class="line">    <span class="function">status <span class="title">getStatus</span><span class="params">(LEVELS level)</span></span>;</span><br><span class="line">&#125; <span class="comment">// log_levels</span></span><br></pre></td></tr></table></figure>
<h3 id="代码示例-1"><a href="#代码示例-1" class="headerlink" title="代码示例"></a>代码示例</h3><p>文件：g3log_tst.cc</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g3log/g3log.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g3log/logworker.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> path_to_log_file = <span class="string">"/tmp/"</span>;</span><br><span class="line"><span class="built_in">string</span> log_file = <span class="string">"g3log_file"</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;g3::LogWorker&gt; worker;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">log_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    worker = g3::LogWorker::createLogWorker();</span><br><span class="line">    <span class="keyword">auto</span> handle = worker-&gt;addDefaultLogger(log_file, path_to_log_file);</span><br><span class="line">    g3::initializeLogging(worker.get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">log_shutdown</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    g3::internal::shutDownLogging();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_log_level</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    g3::log_levels::setHighest(INFO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    log_init();</span><br><span class="line">    set_log_level();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// use LOGF which like printf</span></span><br><span class="line">    LOGF(INFO, <span class="string">"Hi log %d"</span>, <span class="number">123</span>);</span><br><span class="line">    LOGF(DEBUG, <span class="string">"Hi debug log %d"</span>, <span class="number">123</span>);</span><br><span class="line">    LOGF(WARNING, <span class="string">"Printf-style syntax is also %s"</span>, <span class="string">"available”);</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    // use LOG wich like std::cout</span></span><br><span class="line"><span class="string">    LOG(INFO) &lt;&lt; "</span>Hi <span class="string">" &lt;&lt; "</span>LOG<span class="string">";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    log_shutdown();</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>编译运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># g++ -std=c++11 -Wl,-rpath,/usr/local/lib -lg3logger -og3log_tst g3log_tst.cc</span></span><br><span class="line"><span class="comment"># ./g3log_tst</span></span><br><span class="line">g3log g3FileSink shutdown at: 16:25:39 537074</span><br><span class="line">Log file at: [/tmp/g3log_file.g3log.20171011-162539.log]</span><br></pre></td></tr></table></figure>
<p>查看log文件输出内容如下，可以看出并没有DEBUG级别的log输出：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /tmp/g3log_file.g3log.20171011-162539.log</span></span><br><span class="line">        g3log created <span class="built_in">log</span> at: Wed Oct 11 16:25:39 2017</span><br><span class="line">                LOG format: [YYYY/MM/DD hh:mm:ss uuu* LEVEL FILE-&gt;FUNCTION:LINE] message        (uuu*: microseconds fractions of the seconds value)</span><br><span class="line"></span><br><span class="line">    2017/10/11 16:25:39 041987    INFO [g3log_tst.cc-&gt;main:35]    Hi <span class="built_in">log</span> 123</span><br><span class="line">    2017/10/11 16:25:39 042001    WARNING [g3log_tst.cc-&gt;main:37]    Printf-style syntax is also available</span><br><span class="line">    2017/10/11 16:25:39 042016    INFO [g3log_tst.cc-&gt;main:40]    Hi LOG</span><br><span class="line">    g3log g3FileSink shutdown at: 16:25:39 042180</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>g3log还有很多别的特性，有需要的朋友可以详细研究下代码，很多使用示例也可以在源码里的<code>g3log/example/</code>和<code>test_unit/</code>目录里找到，cmake和代码都可以参考之。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ictfox.cn/2017/10/10/mass-data-transport/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/10/mass-data-transport/" itemprop="url">海量数据迁移方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-10T21:41:17+08:00">
                2017-10-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index">
                    <span itemprop="name">storage</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/10/mass-data-transport/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/10/10/mass-data-transport/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>随着云的普及，越来越多的客户需要把数据迁移到云上，针对小量的数据，通过云公司提供的迁移工具走互联网就可以做到，但针对海量的数据，互联网上传输是不现实的，这就需要我们提供一种新的迁移方案来缩短数据迁移时间。</p>
<p>结合过去磁带库的容灾备份方案，针对海量数据迁移到云上的需求，云公司也采用了<code>离线设备+传统运输</code>的解决方案，能大大缩短数据迁移的时间周期，降低成本。</p>
<h3 id="方案步骤"><a href="#方案步骤" class="headerlink" title="方案步骤"></a>方案步骤</h3><ol>
<li>准备<code>离线设备</code></li>
<li>源端数据拷贝到<code>离线设备</code></li>
<li><code>离线设备</code>通过传统方式运输到云公司机房</li>
<li>云公司机房从<code>离线设备</code>上导入数据 / <code>离线设备</code>直接组建存储集群提供服务</li>
</ol>
<h2 id="友商"><a href="#友商" class="headerlink" title="友商"></a>友商</h2><p>提供服务的友商有: AWS，Azure，阿里云</p>
<h2 id="产品功能"><a href="#产品功能" class="headerlink" title="产品功能"></a>产品功能</h2><ol>
<li>定制<code>离线设备</code></li>
<li>开发客户端</li>
<li>NFS/CIFS数据导入</li>
<li>文件导出到OSS，支持配置文件存放bucket的对应关系</li>
<li>数据加密，压缩</li>
<li>数据秘钥管理</li>
</ol>
<h2 id="友商实现"><a href="#友商实现" class="headerlink" title="友商实现"></a>友商实现</h2><h3 id="AWS"><a href="#AWS" class="headerlink" title="AWS"></a>AWS</h3><p>Snowball 是一种 PB 级数据传输解决方案，它使用安全设备在 AWS 云之间传输大量数据。使用 Snowball 可解决大规模数据传输的难题（包括高昂网络成本、较长传输时间和安全问题）。使用 Snowball 传输数据简单、快速、安全，并且成本可低至高速 Internet 费用的五分之一。</p>
<p>借助 Snowball，您无需编写任何代码或购买任何硬件即可传输您的数据。只需在 AWS 管理控制台中创建一个任务，然后 Snowball 设备将自动交付于您。当它到达后，将该设备挂载到您的本地网络、下载并运行 Snowball 客户端来建立连接，然后使用该客户端选择要传输到该设备的文件目录。客户端随后将对文件进行加密，并将其高速传输至该设备。当传输完成后即可返还该设备，E-Ink 运送标签将自动更新，您可以通过 Amazon Simple Notification Service (SNS)、短信或直接在控制台中跟踪任务状态。</p>
<p><img src="/images/aws-snowball-steps.jpg" alt="snowball steps"></p>
<h4 id="硬件设备"><a href="#硬件设备" class="headerlink" title="硬件设备"></a>硬件设备</h4><p>便携式大容量设备，这些设备使用防篡改附件、加密和端到端跟踪，旨在确保数据的安全和全程监管链。<br>每台 Snowball 设备可传输数 TB 的数据，根据您需要传输的数据量，您可以使用多台 Snowball 以并行方式或一个接一个地传输大型数据集。</p>
<p><img src="/images/aws-snowball-device.jpg" alt="snowball device"></p>
<h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><p>Snowball 客户端是您安装在本地主计算机上的软件，用于高效识别、压缩、加密您指定目录中的数据并将其传输到 Snowball。</p>
<h4 id="产品特色"><a href="#产品特色" class="headerlink" title="产品特色"></a>产品特色</h4><ol>
<li>高速</li>
<li>高度可扩展</li>
<li>防状态和安全性</li>
<li>简单且可兼容</li>
<li>成本低廉</li>
<li>轻松检索数据</li>
</ol>
<h3 id="Azure"><a href="#Azure" class="headerlink" title="Azure"></a>Azure</h3><p>Azure 导入/导出服务将大型数据快速、安全地迁移到云中。</p>
<p>使用 Azure 导入/导出服务，可以将硬盘驱动器寄送到 Azure 数据中心，从而安全地将大量数据传输到 Azure Blob 存储（==高度可缩放的非结构化数据对象存储==）。 你还可以使用此服务将数据从 Azure Blob 存储传输到硬盘驱动器，然后再寄送到你的本地站点。 如果需要在本地站点和 Azure 之间传输数 TB 的数据，而由于带宽限制或网络成本过高，通过网络上传或下载数据不可行，在这种情况下，则可以使用此服务。<br>服务要求对硬盘驱动器进行 BitLocker 加密以确保数据的安全性。 服务支持所有公共 Azure 区域中的经典和 Azure Resource Manager 存储帐户（标准层和冷层）。 必须将硬盘驱动器寄送到本文后面指定的某个受支持的位置。</p>
<h4 id="产品特色-1"><a href="#产品特色-1" class="headerlink" title="产品特色"></a>产品特色</h4><ol>
<li><p>高效迁移大量数据集</p>
<p> 与网络传输相比，将物理磁盘传入/传出 Azure 可节省时间和金钱。将大量初始工作负荷数据导入 Azure，或者将数据快速发送到客户网站进行简单的内容分发。创建本地数据备份以存储到云中，然后按需将数据恢复到本地位置。</p>
</li>
<li><p>保持数据私有</p>
<p> 使用“导入/导出”服务时，数据在整个过程中都很安全。磁盘使用 Microsoft BitLocker 驱动器加密进行加密，并在 Azure 门户或 Azure REST API 上通过 SSL 管理加密密钥。在数据中心内，我们使用快速、专用的网络上传链接将用户的数据从驱动器迁移到云。</p>
</li>
<li><p>确保数据完整性</p>
<p> 使用“导入/导出”服务放心迁移数据。内置校验和以及 MD5 哈希可确保数据完整性。通过 Azure 门户上的日志和审核痕迹跟踪并监视数据迁移状态。</p>
</li>
</ol>
<h4 id="硬件设备-1"><a href="#硬件设备-1" class="headerlink" title="硬件设备"></a>硬件设备</h4><p>支持将 2.5 英寸 SSD 或者 2.5/3.5 英寸 SATA II 或 III 内部 HDD 用于导入/导出服务。</p>
<p>单个导入/导出作业最多可以有 10 个 HDD/SSD，并且每个 HDD/SSD 可以为任意大小。大量驱动器可以分布在多个作业上，并且可创建的作业数没有限制。</p>
<h4 id="导入作业"><a href="#导入作业" class="headerlink" title="导入作业"></a>导入作业</h4><p>概括而言，导入作业包括以下步骤：</p>
<ul>
<li>确定要导入的数据，以及所需驱动器数目。</li>
<li>确定 Blob 存储中用于存储数据的目标 Blob 位置。</li>
<li>使用 WAImportExport 工具将数据复制到一个或多个硬盘驱动器，并使用 BitLocker 进行加密。</li>
<li>使用 Azure 门户或导入/导出 REST API 在目标存储帐户中创建导入作业。 如果使用 Azure 门户，请上传驱动器日记文件。</li>
<li>请提供回寄地址以及快递商帐户号码，以便我们将驱动器寄回给你。</li>
<li>将硬盘驱动器寄送到在创建作业时获得的寄送地址。</li>
<li>在导入作业详细信息中更新快递跟踪号码，然后提交导入作业。</li>
<li>Azure 数据中心在收到驱动器后会对其进行处理。</li>
<li>该中心会使用你的快递商帐户将驱动器寄送到你在导入作业中提供的回寄地址。</li>
</ul>
<p><img src="/images/azure-data-import.jpg" alt="data import"></p>
<h4 id="导出作业"><a href="#导出作业" class="headerlink" title="导出作业"></a>导出作业</h4><p>概括而言，导出作业包括以下步骤：</p>
<ul>
<li>确定要导出的数据，以及所需驱动器数目。</li>
<li>确定你的数据在 Blob 存储中的源 Blob 或容器路径。</li>
<li>使用 Azure 门户或导入/导出 REST API 在源存储帐户中创建导出作业。</li>
<li>指定你的数据在导出作业中的源 Blob 或容器路径。</li>
<li>请提供回寄地址以及快递商帐户号码，以便我们将驱动器寄回给你。</li>
<li>将硬盘驱动器寄送到在创建作业时获得的寄送地址。</li>
<li>在导出作业详细信息中更新快递跟踪号码，然后提交导出作业。</li>
<li>Azure 数据中心在收到驱动器后会对其进行处理。</li>
<li>驱动器使用 BitLocker 加密；密钥通过 Azure 门户提供。</li>
<li>该中心会使用你的快递商帐户将驱动器寄送到你在导入作业中提供的回寄地址。</li>
</ul>
<p><img src="/images/azure-data-export.jpg" alt="data export"></p>
<h4 id="导入-导出工具"><a href="#导入-导出工具" class="headerlink" title="导入/导出工具"></a>导入/导出工具</h4><p>使用此 WAImportExport 工具可以方便地将数据复制到驱动器、使用 BitLocker 加密驱动器上的数据，以及生成驱动器日志文件。</p>
<p>WAImportExport 工具仅兼容 64 位 Windows 操作系统。</p>
<h3 id="阿里云"><a href="#阿里云" class="headerlink" title="阿里云"></a>阿里云</h3><p>闪电立方 Lightning Cube，支持TB到PB级别数据上云解决方案。通过定制的离线迁移设备，解决本地数据中心大规模数据传输上云的迁移周期长，网络专线费用昂贵，数据复制效率低，迁移过程数据安全等问题。快速、安全、高效、降低90%的数据迁移成本。</p>
<p>2017年6月10号，阿里云发布了产品“闪电立方”。它像是一个可移动的“数据中心”，通过一个安全的存储硬件，可将100TB数据安全地一次性转移，最快24小时即可完成PB级数据迁移。“闪电立方”外形黑色立方，可防尘防水，抗震抗压。容量上可容纳100TB数据，并能实现最高30：1的压缩比，配合高效的去重功能可节省更多的存储空间。内置了20Gbps的光纤网络连接。在数据安全性方面，“闪电立方”采用AES 256端到端加密算法，密钥由用户保管，运送过程中全程断网，同时配备24小时定位监控。</p>
<p><img src="/images/aliyun-lighting-cube.jpg" alt="aliyun lighting cube"></p>
<h4 id="产品特色-2"><a href="#产品特色-2" class="headerlink" title="产品特色"></a>产品特色</h4><ol>
<li><p>高速高效</p>
<p> 相比传统的Internet和高速专线速度提升20倍，成本降低60%</p>
<ul>
<li><p>数据压缩<br>  支持最高30倍压缩比</p>
</li>
<li><p>数据去重<br>  自动对数据进行去重处理，迁移过程中自动恢复</p>
</li>
<li><p>小文件优化<br>  小文件自动合并，提升读写效率</p>
</li>
</ul>
</li>
<li><p>安全可靠</p>
<ul>
<li>加密能力<br>  提供设备端到端的加密机制，用户自己管理密码并通过密码授权解密，保障运输过程中数据的安全  </li>
<li>权限<br>  用户主动通过RAM授权的方式，允许数据同步到云端用户的存储空间  </li>
<li>数据擦除<br>  数据迁移完毕后，通过阿里云官方数据擦除机制，确保数据不会被第三方获取</li>
</ul>
</li>
<li><p>低成本</p>
<p> 单次大容量的离线迁移能力，大幅降低物流成本和网络成本</p>
</li>
<li><p>可扩展</p>
<p> 单台设备可支持100TB或480TB的迁移能力，可横向扩展，利用多套设备同时迁移PB+级别数据</p>
</li>
</ol>
<h4 id="硬件设备-2"><a href="#硬件设备-2" class="headerlink" title="硬件设备"></a>硬件设备</h4><p>为数据迁移而生的专业设备，标准机架和电源，可多套同时部署提升迁移效率。<br>支持的数据源包括：本地文件系统，NAS，HDFS，FastDFS等。</p>
<p><img src="/images/aliyun-lighting-cube-device.jpg" alt="aliyun lighting cube device"></p>
<h4 id="客户端-1"><a href="#客户端-1" class="headerlink" title="客户端"></a>客户端</h4><p>没找到文档介绍“闪电立方”的客户端，从它支持的数据源包括：本地FS，NAS，HDFS，FastDFS等，可以推断出肯定有这样的一个客户端软件。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在海量数据上云面前，离线物理设备迁移是一种很好的解决方案，几大公有云提供商都提供了专门的迁移设备和迁移服务，比较好的会设计专门的<code>硬件设备</code>，简单点的就使用标准的 2.5/3.5 英寸磁盘，但都会考虑数据安全性，这也是客户比较关注的问题。</p>
<p>总结下产品所需的功能如下：</p>
<ol>
<li>硬件设备</li>
<li>客户端软件</li>
<li>数据加密</li>
<li>秘钥管理</li>
<li>数据压缩</li>
<li>数据校验</li>
</ol>
<h3 id="自研需求"><a href="#自研需求" class="headerlink" title="自研需求"></a>自研需求</h3><p>该产品现在没有开源的解决方案，除了AWS以外，Azure和阿里云都是今年刚推出该服务，我们也只能参考他们的实现来自己研发产品。</p>
<h4 id="硬件设备研发"><a href="#硬件设备研发" class="headerlink" title="硬件设备研发"></a>硬件设备研发</h4><p>若要设计研发可以跟友商竞争的硬件设备，包括整套专业硬件设备的研发，难点非常大</p>
<p>难度：★★★★★</p>
<h4 id="客户端软件"><a href="#客户端软件" class="headerlink" title="客户端软件"></a>客户端软件</h4><p>客户端软件研发也是重点，需要包括的功能有：</p>
<ul>
<li>支持哪些数据源？</li>
<li>数据源跟云上产品的映射关系？</li>
<li>数据加密，压缩，一致性校验</li>
<li>秘钥管理</li>
</ul>
<p>难度：★★★★☆</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ictfox.cn/2017/09/18/cephfs-knowledge-share-part2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/18/cephfs-knowledge-share-part2/" itemprop="url">cephfs架构解读与测试分析-part2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-18T20:41:17+08:00">
                2017-09-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ceph/" itemprop="url" rel="index">
                    <span itemprop="name">ceph</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/09/18/cephfs-knowledge-share-part2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/09/18/cephfs-knowledge-share-part2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文是在日知录社区里分享内容的第二部分，主要介绍CephFS的测试方法和结果分析，对视频分享和第一部分感兴趣的请阅读如下链接：</p>
<p><a href="http://www.yangguanjun.com/2017/08/30/cephfs-knowledge-share-part1/" target="_blank" rel="noopener">cephfs架构解读与测试分析-part1</a><br><a href="https://m.qlchat.com/topic/details?topicId=240000540003989" target="_blank" rel="noopener">日知录 - CephFS架构解读与测试分析</a></p>
<h2 id="CephFS测试"><a href="#CephFS测试" class="headerlink" title="CephFS测试"></a>CephFS测试</h2><p>为了验证CephFS是否满足产品需求，我们基于最新的Ceph Jewel 10.2.7版本做了测试。</p>
<h3 id="CephFS-Jewel版本特性"><a href="#CephFS-Jewel版本特性" class="headerlink" title="CephFS Jewel版本特性"></a>CephFS Jewel版本特性</h3><ol>
<li>CephFS – Production Ready</li>
<li>Single Active MDS，Active-Standby MDSs</li>
<li>Single CephFS within a single Ceph Cluster</li>
<li>CephFS requires at least kernel 3.10.x </li>
<li>Experimental Features<ul>
<li>Multi Active MDSs</li>
<li>Multiple CephFS file systems within a single Ceph Cluster</li>
<li>Directory Fragmentation</li>
</ul>
</li>
</ol>
<h3 id="CephFS测试目的"><a href="#CephFS测试目的" class="headerlink" title="CephFS测试目的"></a>CephFS测试目的</h3><ol>
<li>CephFS POSIX基本功能完备？</li>
<li>CephFS性能跑满整个集群？</li>
<li>CephFS长时间是否稳定？</li>
<li>CephFS能否应对MDS异常？</li>
</ol>
<p><strong>NO：</strong></p>
<ol>
<li>不是针对MDS的参数调优</li>
<li>不是MDS的压力测试<ul>
<li>MDS压力测试时建议配置在单独的机器上</li>
<li>调大 <code>mds_cache_size</code></li>
</ul>
</li>
</ol>
<p>MDS压力测试请参考<br><a href="https://www.slideshare.net/XiaoxiChen3/cephfs-jewel-mds-performance-benchmark" target="_blank" rel="noopener">https://www.slideshare.net/XiaoxiChen3/cephfs-jewel-mds-performance-benchmark</a></p>
<h3 id="CephFS测试环境"><a href="#CephFS测试环境" class="headerlink" title="CephFS测试环境"></a>CephFS测试环境</h3><p>针对测试目的，我们选择了三台物理机搭建一个全新的Ceph集群，提供CephFS服务。</p>
<h4 id="物理机的配置"><a href="#物理机的配置" class="headerlink" title="物理机的配置"></a>物理机的配置</h4><ul>
<li>10个4T 7200RPM SATA盘</li>
<li>2个480GB的SATA SSD盘，Intel S3500</li>
<li>2个万兆网卡</li>
</ul>
<p>SSD盘的性能为：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>性能</th>
</tr>
</thead>
<tbody>
<tr>
<td>容量</td>
<td>480GB</td>
</tr>
<tr>
<td>顺序读取(最高)</td>
<td>500 MB/s</td>
</tr>
<tr>
<td>顺序写入(最高)</td>
<td>410 MB/s</td>
</tr>
<tr>
<td>随机读取(100% 跨度)</td>
<td>75000 IOPS</td>
</tr>
<tr>
<td>随机写入(100% 跨度)</td>
<td>11000 IOPS</td>
</tr>
</tbody>
</table>
<p>SATA盘的性能为：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>性能</th>
</tr>
</thead>
<tbody>
<tr>
<td>容量</td>
<td>4TB</td>
</tr>
<tr>
<td>顺序读写</td>
<td>120 MB/s</td>
</tr>
<tr>
<td>IOPS</td>
<td>130</td>
</tr>
</tbody>
</table>
<h4 id="Ceph配置参数"><a href="#Ceph配置参数" class="headerlink" title="Ceph配置参数"></a>Ceph配置参数</h4><p>测试用的CephFS client为单独的服务器，128G内存，万兆网络连接Ceph集群。</p>
<p><img src="/images/cephfs-tstenv-structure.jpg" alt="tstenv structure"></p>
<p>如上图所示，Ceph集群的部署配置为：</p>
<ul>
<li>replica为3</li>
<li>三个Monitor</li>
<li>两个MDS部署为Active/Standy</li>
</ul>
<p>Ceph集群和CephFS client的系统版本信息如下：</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ceph Version</td>
<td>Jewel 10.2.7  </td>
</tr>
<tr>
<td>Ceph Cluster OS</td>
<td>CentOS Linux release 7.2.1511 (Core)</td>
</tr>
<tr>
<td>Ceph Cluster kernel version</td>
<td>3.10.0-327.el7.x86_64</td>
</tr>
<tr>
<td>Cephfs Client OS</td>
<td>CentOS Linux release 7.2.1511 (Core)  </td>
</tr>
<tr>
<td>Cephfs kernel version</td>
<td>4.11.3-1.el7.elrepo.x86_64</td>
</tr>
</tbody>
</table>
<h4 id="预估Ceph集群性能"><a href="#预估Ceph集群性能" class="headerlink" title="预估Ceph集群性能"></a>预估Ceph集群性能</h4><p>通过Ceph集群架构和物理磁盘、网络的性能指标，就可以预估整个Ceph集群的性能了。</p>
<p>如我们这个Ceph集群，三台物理机，配置三副本，又受限于单Client端的万兆网络性能，所以整个集群的最大吞吐量为：<code>单台物理机上的磁盘性能 / 万兆网络性能</code>的最小值。</p>
<p>每个物理机上，2个SSD做10个OSD的journal，其整体性能约为：<br><code>2 * (单个ssd盘的性能)</code> / <code>10 * (单个sata盘的性能)</code> / <code>万兆网络性能</code> 的最小值。</p>
<h3 id="CephFS测试工具"><a href="#CephFS测试工具" class="headerlink" title="CephFS测试工具"></a>CephFS测试工具</h3><ol>
<li><p>功能测试</p>
<p> 手动，fstest</p>
</li>
<li><p>性能测试</p>
<p> dd，fio，iozone，filebench</p>
</li>
<li><p>稳定性测试</p>
<p> fio，iozone，自写脚本</p>
</li>
<li><p>异常测试</p>
<p> 手动</p>
</li>
</ol>
<h3 id="CephFS测试分析"><a href="#CephFS测试分析" class="headerlink" title="CephFS测试分析"></a>CephFS测试分析</h3><h4 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a>功能测试</h4><ol>
<li><p>手动</p>
<p> 我们使用文件系统的常用操作：<code>mkdir/cd/touch/echo/cat/chmod/chown/mv/ln/rm</code>等。</p>
</li>
</ol>
<ol>
<li><p>fstest</p>
<p> fstest是一套简化版的文件系统posix兼容性测试条件，有3600来个回归测试，测试的系统调用覆盖的也比较全面。<br> <code>chmod, chown, link, mkdir, mkfifo, open, rename, rmdir, symlink, truncate, unlink</code></p>
</li>
</ol>
<p><strong>结论</strong><br>功能测试通过</p>
<h4 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h4><p>性能测试比较重要，也是我们测试的重点，按照CephFS的Layout配置，我们选择了三类Layout配置：</p>
<ol>
<li><p><code>stripe_unit=1M, stripe_count=4, object_size=4M</code></p>
<p> 目录为: dir-1M-4-4M，条带大小为1M，条带数目为4，object大小为4M</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">配置测试目录attr</span><br><span class="line"><span class="comment"># setfattr -n ceph.dir.layout -v "stripe_unit=1048576 stripe_count=4 object_size=4194304" dir-1M-4-4M</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>stripe_unit=4M, stripe_count=1, object_size=4M</code></p>
<p> 目录为: dir-4M-1-4M，也是系统默认配置</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">配置测试目录attr</span><br><span class="line"><span class="comment"># setfattr -n ceph.dir.layout -v "stripe_unit= 4194304 stripe_count=1 object_size=4194304" dir-4M-1-4M</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p><code>stripe_unit=4M, stripe_count=4, object_size=64M</code></p>
<p> 目录为: dir-4M-4-64M，条带大小为4M，条带数目为4，object大小为64M</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">配置测试目录attr</span><br><span class="line"><span class="comment"># setfattr -n ceph.dir.layout -v "stripe_unit=4194304 stripe_count=4 object_size=67108864" dir-4M-4-64M</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>==注：后续图表中分别拿上述目录名来代表三种CephFS Layout配置分类==</p>
<ul>
<li>dir-1M-4-4M</li>
<li>dir-4M-1-4M</li>
<li>dir-4M-4-64M</li>
</ul>
<h5 id="dd"><a href="#dd" class="headerlink" title="dd"></a>dd</h5><p>linux系统常用的测试设备和系统性能的工具。</p>
<p><strong>测试命令：</strong></p>
<ul>
<li>Direct IO： oflag/iflag=direct</li>
<li>Sync IO：oflag/iflag=sync</li>
<li>Normal IO：不指定oflag/iflag</li>
</ul>
<p>测试文件大小：20G</p>
<blockquote>
<p>不能选择太小的测试文件，减少系统缓存的影响</p>
</blockquote>
<p><strong>测试结果：</strong></p>
<p><img src="/images/dd-write-perf.jpg" alt="cephfs dd perf write"><br><img src="/images/dd-read-perf.jpg" alt="cephfs dd perf read"></p>
<p><strong>结论：</strong></p>
<ol>
<li>normal io，客户端缓存影响，写性能较高，不做分析。读性能约为1GB/s，受限于万兆网卡。</li>
<li>direct io，客户端写性能只有150MB/s，读性能只有600MB/s，这个是cephfs kernel client端的direct io逻辑导致的。</li>
<li><p>sync io，随着bsd的增大性能有所提升，写性能能到 550MB/s，读性能有1GB/s</p>
</li>
<li><p>Stripe模式变化的角度分析</p>
<ul>
<li>bs=512k/1M时，各个stripe模式下的IO性能基本相同</li>
<li>bs=4M/16M时，针对direct io，stripe unit=1M的条带性能略低（kernel client的direct io逻辑有关），针对sync io，stripe unit=1M的条带性能较好（并发性较好的原因）</li>
<li>默认的file layout(橙色)，dd的性能就挺好，64Mobjcet 的stripe模式(灰色)没有明显的性能提升</li>
</ul>
</li>
</ol>
<h5 id="fio"><a href="#fio" class="headerlink" title="fio"></a>fio</h5><p>fio也是我们性能测试中常用的一个工具，详细介绍Google之。</p>
<p>我们测试中固定配置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-filename=tstfile   指定测试文件的name</span><br><span class="line">-size=20G           指定测试文件的size为20G</span><br><span class="line">-direct=1           指定测试IO为DIRECT IO</span><br><span class="line">-thread				指定使用thread模式</span><br><span class="line">-name=fio-tst-name  指定job name</span><br></pre></td></tr></table></figure>
<p>测试bandwidth时：</p>
<ol>
<li>-ioengine=libaio/sync</li>
<li>-bs=512k/1M/4M/16M</li>
<li>-rw=write/read</li>
<li>-iodepth=64 -iodepth_batch=8 -iodepth_batch_complete=8</li>
</ol>
<p>测试iops时：</p>
<ol>
<li>-ioengine=libaio</li>
<li>-bs=4k</li>
<li>-runtime=300</li>
<li>-rw=randwrite/randread</li>
<li>-iodepth=64 -iodepth_batch=1 -iodepth_batch_complete=1</li>
</ol>
<p><strong>测试结果：</strong></p>
<p>bandwidth的测试结果如下图：</p>
<p><img src="/images/fio-write-perf.jpg" alt="fio write perf"><br><img src="/images/fio-read-perf.jpg" alt="fio read perf"></p>
<ul>
<li><p>bandwidth: direct sync IO</p>
<ul>
<li>write/randwrite 性能最多约为：155 MB/s </li>
<li>read/randread 性能最多约为：600 MB/s</li>
</ul>
</li>
<li><p>bandwidth: direct libaio</p>
<ul>
<li>write/randwrite 性能最多约为：810 MB/s</li>
<li><p>read/randread 性能最多约为：1130 MB/s</p>
<blockquote>
<p>==这基本就是集群的整体性能==</p>
</blockquote>
</li>
</ul>
</li>
<li><p>bandwidth: cephfs stripe模式变化时</p>
<blockquote>
<p>结论与dd的基本相同</p>
</blockquote>
</li>
</ul>
<p>iops的测试结果如下表：</p>
<table>
<thead>
<tr>
<th>io mode</th>
<th>type</th>
<th>dir-1M-4-4M</th>
<th>dir-4M-1-4M</th>
<th>dir-4M-4-64M</th>
</tr>
</thead>
<tbody>
<tr>
<td>randwrite</td>
<td>iops</td>
<td>4791</td>
<td>4172</td>
<td>4130</td>
</tr>
<tr>
<td></td>
<td>latency(ms)</td>
<td>13.35</td>
<td>15.33</td>
<td>15.49</td>
</tr>
<tr>
<td>randread</td>
<td>iops</td>
<td>2436</td>
<td>2418</td>
<td>2261</td>
</tr>
<tr>
<td></td>
<td>latency(ms)</td>
<td>26.26</td>
<td>26.46</td>
<td>28.30</td>
</tr>
</tbody>
</table>
<blockquote>
<p>注释：上诉测试randread中，因为有cephfs这一层，所以即使direct IO，在OSD上也不一定会read磁盘，因为OSD有缓存数据；所以这里测试采取每次测试前在所有ceph cluster的host上执行<code>sync; echo 3 &gt; /proc/sys/vm/drop_caches;</code>清理缓存；</p>
</blockquote>
<h5 id="iozone"><a href="#iozone" class="headerlink" title="iozone"></a>iozone</h5><p>iozone是目前应用非常广泛的文件系统测试标准工具，它能够产生并测量各种的操作性能，包括read, write, re-read, re-write, read backwards, read strided, fread, fwrite, random read, pread ,mmap, aio_read, aio_write等操作。</p>
<ol>
<li><p>测试DIRET IO / SYNC IO - 非throughput模式</p>
<p> 不指定threads，测试单个线程的iozone性能</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iozone -a -i 0 -i 1 -i 2 -n 1m -g 10G -y 128k -q 16m -I -Rb iozone-directio-output.xls</span><br><span class="line">iozone -a -i 0 -i 1 -i 2 -n 1m -g 10G -y 128k -q 16m -o -Rb iozone-syncio-output.xls</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试系统吞吐量 - throughput模式</p>
<p> 指定threads=16，获取整个系统的throughput</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iozone -a -i 0 -i 1 -i 2 -r 16m -s 2G -I -t 16 -Rb iozone-directio-throughput-output.xls</span><br><span class="line">iozone -a -i 0 -i 1 -i 2 -r 16m -s 2G -o -t 16 -Rb iozone-syncio-throughput-output.xls</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>测试结果：</strong></p>
<p>iozone测试的结果很多，很难每个都画出图表展示出来，这里挑选几组对比数据作为对比。</p>
<blockquote>
<p>下图中的类似<code>128K/1M</code>的文字含义为：记录块为128K，测试文件为1M<br>性能输出的单位为：MB/s</p>
</blockquote>
<ul>
<li>非throughput模式</li>
</ul>
<p>write性能<br><img src="/images/iozone-write-perf.jpg" alt="iozone write"></p>
<p>read性能<br><img src="/images/iozone-read-perf.jpg" alt="iozone read"></p>
<ol>
<li>写性能：direct IO模式为 150 MB/s，sync IO模式为 350MB/s  </li>
<li><p>读性能：direct IO模式为 560 MB/s，sync IO模式为 7000 MB/s==（iozone的io模式和client端缓存的影响，指标不准确）==  </p>
</li>
<li><p>Stripe模式变化： 各个Stripe下性能基本一致，对于小文件小IO模式来说，dir-1M-4-4M的性能略好</p>
</li>
</ol>
<ul>
<li>throughput模式</li>
</ul>
<p><img src="/images/iozone-throughput-perf.jpg" alt="iozone throughput"></p>
<ol>
<li>各种write的性能基本相同，最大约为 750 MB/s，基本是集群写的极限</li>
<li>direct IO模式下，读性能约为  1120 MB/s，client端万兆网络带宽的极限</li>
<li>sync IO模式下，读性能高达 22500 MB/s，iozone的io模式和client端缓存的影响，指标不准确</li>
</ol>
<h5 id="filebench"><a href="#filebench" class="headerlink" title="filebench"></a>filebench</h5><p>filebench是一款文件系统性能的自动化测试工具，它通过快速模拟真实应用服务器的负载来测试文件系统的性能。</p>
<p>filebench有很多定义好的workload，针对cephfs的测试，我们可以选择其中一部分有代表性的workloads即可。</p>
<ul>
<li><code>createfiles.f / openfiles.f / makedirs.f / listdirs.f / removedirs.f</code></li>
<li><code>randomrw.f / fileserver.f / videoserver.f / webserver.f</code></li>
</ul>
<p><strong>结论</strong></p>
<ol>
<li>filebench测试用例，除了读写操作外，其他的都是元数据操作，基本不受cephfs stripe的影响</li>
<li>各种文件操作的时延都不高，可以满足基本的对filesystem的需求</li>
</ol>
<h4 id="稳定性测试"><a href="#稳定性测试" class="headerlink" title="稳定性测试"></a>稳定性测试</h4><p>为了测试cephfs是否能在线上提供服务，我们需要测试下其稳定性，这里采用两种方式测试。</p>
<h5 id="读写数据模式"><a href="#读写数据模式" class="headerlink" title="读写数据模式"></a>读写数据模式</h5><p>针对读写数据模式，我们选择工具<code>fio</code>，在cephfs client端长时间运行，看会不会报错。</p>
<p>测试逻辑大概如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fio循环测试读写</span></span><br><span class="line"><span class="keyword">while</span> now &lt; time</span><br><span class="line">	fio write 10G file</span><br><span class="line">	fio <span class="built_in">read</span> 10G file</span><br><span class="line">	delete file</span><br></pre></td></tr></table></figure>
<h5 id="读写元数据模式"><a href="#读写元数据模式" class="headerlink" title="读写元数据模式"></a>读写元数据模式</h5><p>针对读写元数据模式，我们采用自写脚本，大规模创建目录、文件、写很小数据到文件中，在cephfs client端长时间运行，看会不会报错。</p>
<p>测试逻辑大概如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 百万级别的文件个数</span></span><br><span class="line"><span class="keyword">while</span> now &lt; time</span><br><span class="line">	create <span class="built_in">dirs</span></span><br><span class="line">	touch files</span><br><span class="line">	write little data to each file</span><br><span class="line">	delete files</span><br><span class="line">	delete <span class="built_in">dirs</span></span><br></pre></td></tr></table></figure>
<p><strong>结论</strong></p>
<ul>
<li>通过几天的连续测试，cephfs一切正常，这说明cephfs是可以应用到生产环境的。  </li>
<li>至于上亿级别的文件测试，也遇到点问题。</li>
</ul>
<p><strong>问题与解决</strong></p>
<ul>
<li><p>日志中报<code>Behind on trimming</code>告警<br>  调整参数<code>mds_log_max_expiring，mds_log_max_segments</code></p>
</li>
<li><p>rm删除上亿文件时报<code>No space left on device</code>错误<br>  调大参数<code>mds_bal_fragment_size_max，mds_max_purge_files，mds_max_purge_ops_per_pg</code></p>
</li>
<li><p>日志中报<code>_send skipping beacon, heartbeat map not healthy</code><br>  调大参数<code>mds_beacon_grace，mds_session_timeout，mds_reconnect_timeout</code></p>
</li>
</ul>
<p><strong>基本思路：</strong></p>
<ol>
<li>查看Client和MDS端log</li>
<li>Google搜索关键字 or 搜索Ceph相关代码</li>
<li>分析原因</li>
<li>调整参数</li>
</ol>
<blockquote>
<p>当然也有的问题不是简单调整参数就搞定的，那就尽量去分析问题，向社区提bug反馈。</p>
</blockquote>
<h4 id="异常测试"><a href="#异常测试" class="headerlink" title="异常测试"></a>异常测试</h4><p>cephfs的功能依赖于MDS和Ceph Cluster，关键的元数据都通过MDS获取，这里测试的异常也主要基于MDS的异常进行分类的。</p>
<p>查看ceph MDS与interl和timeout相关的配置有：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">OPTION(mds_tick_interval, OPT_FLOAT, 5)</span><br><span class="line">OPTION(mds_mon_shutdown_timeout, OPT_DOUBLE, 5)</span><br><span class="line">OPTION(mds_op_complaint_time, OPT_FLOAT, 30)</span><br><span class="line">OPTION(mds_beacon_grace, OPT_FLOAT, 15)</span><br><span class="line">OPTION(mds_session_timeout, OPT_FLOAT, 60)    // <span class="built_in">cap</span> bits and leases time out <span class="keyword">if</span> client idle</span><br><span class="line">OPTION(mds_reconnect_timeout, OPT_FLOAT, 45)  // seconds to <span class="built_in">wait</span> <span class="keyword">for</span> clients during mds restart, make it (mds_session_timeout - mds_beacon_grace)</span><br></pre></td></tr></table></figure>
<p>在Sage weil的博士论文里提到CephFS允许客户端缓存metadata 30s，所以这里测试对MDS stop/start的时间间隔取为：2s，10s，60s</p>
<p>测试工具：fio</p>
<p><strong>测试分类：</strong></p>
<ol>
<li>单MDS</li>
<li>主从MDS</li>
</ol>
<p><strong>测试结果：</strong></p>
<ol>
<li><p>单MDS时：</p>
<ul>
<li>2s/10s 无影响</li>
<li>60s时影响IO</li>
</ul>
</li>
<li><p>主从MDS时：</p>
<ul>
<li>主从不同时停无影响</li>
<li>同时停时与单MDS一致</li>
</ul>
</li>
</ol>
<p>mds停60s时会影响IO，fio测试结果如下图：</p>
<p><img src="/images/fio-randwrite-bw-mds-crush.jpg" alt="fio rw bw"></p>
<blockquote>
<p>另外这里只举例说明了fio，同样异常测试中我们也测试了iozone，因为iozone会读写不同的文件，所以在mds停掉后，新的文件操作就会被hang住。</p>
</blockquote>
<p><strong>结论</strong></p>
<ol>
<li>单MDS的情况下，短暂的MDS crush并不会影响客户端对一个file的读写</li>
<li>单MDS的情况下，MDS crush后，client端对没有缓存过caps的文件操作会hang住</li>
<li>主从MDS的情况下，只要有一个MDS正常，CephFS的服务就不会中断</li>
<li>主从MDS的情况下，两个MDS都crush后，影响与单MDS的一致</li>
</ol>
<p>所以生产环境中，我们建议配置主从MDS的模式，提高CephFS的可用性。</p>
<h2 id="总结与展望"><a href="#总结与展望" class="headerlink" title="总结与展望"></a>总结与展望</h2><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li>CephFS是production ready的，能满足基本生产环境对文件存储的需求</li>
<li>CephFS kernel client端的Linux kernel版本最好大于4.5-rc1（支持aio）</li>
<li>对性能要求不高时，考虑使用CephFS FUSE client，支持Quotas</li>
<li>CephFS的主从MDS是稳定的，优于单MDS配置</li>
<li>生成环境使用CephFS时，独立机器上配置MDS，调大“mds_cache_size”</li>
<li>使用CephFS时，避免单个目录下包含超级多文件（more than millions）</li>
<li>CephFS能跑满整个ceph集群的性能</li>
<li>默认stripe模式下(stripe unit=4M, stripe count=1, object size=4M)， CephFS的性能就挺好</li>
<li>小文件的应用场景下，尝试配置小的stripe unit，对比默认stripe的性能</li>
<li>CephFS的Direct IO性能有限，分析后是cephfs kernel client的IO处理逻辑限制的  <a href="http://www.yangguanjun.com/2017/06/26/cephfs-dd-direct-io-tst-analysis/" target="_blank" rel="noopener">http://www.yangguanjun.com/2017/06/26/cephfs-dd-direct-io-tst-analysis/</a></li>
<li>受到CephFS client端的系统缓存影响，非Direct IO的读写性能都会比较高，这个不具有太大参考意</li>
<li>使用CephFS kernel client，且object size大于16M时，一次性读取大于16M的数据读时IO会hang住  <a href="http://www.yangguanjun.com/2017/07/18/cephfs-io-hang-analysis/" target="_blank" rel="noopener">http://www.yangguanjun.com/2017/07/18/cephfs-io-hang-analysis/</a></li>
</ol>
<h3 id="展望"><a href="#展望" class="headerlink" title="展望"></a>展望</h3><p>Ceph Luminous (v12.2.0) - next long-term stable release series</p>
<ol>
<li>The new BlueStore backend for ceph-osd is now stable and the new default for newly created OSDs</li>
<li>Multiple active MDS daemons is now considered stable</li>
<li>CephFS directory fragmentation is now stable and enabled by default</li>
<li>Directory subtrees can be explicitly pinned to specific MDS daemons</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ictfox.cn/2017/09/12/storage-backup-multisite/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/12/storage-backup-multisite/" itemprop="url">金融云存储灾备之两地三中心</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-12T09:41:17+08:00">
                2017-09-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index">
                    <span itemprop="name">storage</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/09/12/storage-backup-multisite/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/09/12/storage-backup-multisite/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在金融行业 ，特别是银行业，对数据的安全性要求特别高，对业务的连续性也是一样。传统的单数据中心模式和同城双中心的高可用模式也不能满足其需求，于是就诞生了最新的一种超高可用架构 - <code>两地三中心</code>。</p>
<p><code>两地三中心</code>，两地是指同城、异地，三中心是指生产中心、同城容灾中心、异地容灾中心。充分结合了同城的距离优势和异地的灾备优势，提供了超高可用的服务架构，模式如下图：<br><img src="/images/storage-backup-multisite-arch.jpg" alt="multisite arch"></p>
<h2 id="友商"><a href="#友商" class="headerlink" title="友商"></a>友商</h2><p>提供服务的友商有: 阿里云，腾讯云，百度云</p>
<h2 id="产品功能"><a href="#产品功能" class="headerlink" title="产品功能"></a>产品功能</h2><ol>
<li>前端负载均衡</li>
<li>同城双活</li>
<li>同城数据中心实时同步</li>
<li>异地数据中心异步复制</li>
<li>VPN专线</li>
<li>物理机独享</li>
</ol>
<h2 id="友商实现"><a href="#友商实现" class="headerlink" title="友商实现"></a>友商实现</h2><p>金融云方面，友商提供了很多解决方案，一般都采用独立的机房集群，与公有云物理隔离，且满足一行三会金融监管要求。</p>
<h3 id="阿里云"><a href="#阿里云" class="headerlink" title="阿里云"></a>阿里云</h3><h4 id="金融云解决方案"><a href="#金融云解决方案" class="headerlink" title="金融云解决方案"></a>金融云解决方案</h4><p>为新金融行业提供量身定制的云计算服务，具备低成本、高弹性、高可用、安全合规的特性。帮助金融客户实现从传统IT向云计算的转型，为客户提供完整的“云.端.数”的能力。</p>
<p>链接：<a href="https://www.aliyun.com/solution/finance" target="_blank" rel="noopener">https://www.aliyun.com/solution/finance</a></p>
<h4 id="金融云专属产品"><a href="#金融云专属产品" class="headerlink" title="金融云专属产品"></a>金融云专属产品</h4><ol>
<li><p>云服务器ECS - 专属物理集群，高级安全服务，高质量IO保障，高品质客户服务</p>
<ul>
<li>更高规格SLA保障，可用性为99.95%，可靠性达到99.9999%</li>
<li>IO性能保障，采用更可靠宽裕的资源分配机制</li>
<li>对外端口检测，默认不开放互联网访问端口</li>
<li>图形化安全组配置工具，方便用户操作，提升安全级别</li>
</ul>
</li>
<li><p>云数据库RDS - 专属物理集群，异地灾备服务，高级备份和回滚服务</p>
<ul>
<li>更高规格SLA保障，可用性99.97%，可靠性达99.999999%</li>
<li>数据更加安全，支持SQL Server 2008R2和MySQL5.5、5.6，使用强同步模式确保数据安全性</li>
<li>主备双中心和异地灾备，同城双中心，异地单向数据复制功能</li>
<li>高级备份和回滚策略，默认备份时间为30天，支持自定义数据备份时间</li>
</ul>
</li>
</ol>
<h4 id="银行架构部署图"><a href="#银行架构部署图" class="headerlink" title="银行架构部署图"></a>银行架构部署图</h4><p><img src="/images/storage-backup-mutisite-aliyun-bank-arch.jpg" alt="aliyun bank arch"></p>
<blockquote>
<p>==<strong>数据库</strong>== 实现主备数据同步，==<strong>数据传输</strong>== 实现文件同步</p>
</blockquote>
<p>链接： <a href="https://www.aliyun.com/solution/finance/bank.html" target="_blank" rel="noopener">https://www.aliyun.com/solution/finance/bank.html</a></p>
<h4 id="使用产品"><a href="#使用产品" class="headerlink" title="使用产品"></a>使用产品</h4><ol>
<li>云服务器</li>
<li>负载均衡</li>
<li>云数据库</li>
<li>对象存储</li>
<li>云监控</li>
<li>数据传输</li>
</ol>
<p><strong>金融云数据库</strong></p>
<p>MySQL 金融版 是一款具有金融级强一致性，高可靠性，能跨机房部署的增强型MySQL数据库集群，是阿里云关系型数据库的升级版本，面向对数据一致性、高可用、高安全性有强烈要求的高端企业用户。<br>链接：<a href="https://www.aliyun.com/product/mysqlenterprise" target="_blank" rel="noopener">https://www.aliyun.com/product/mysqlenterprise</a></p>
<p><strong>数据传输服务</strong></p>
<p>数据传输(Data Transmission)是阿里云提供的一种支持RDBMS(关系型数据库)、NoSQL、OLAP等多种数据源之间数据交互的数据服务。它提供了数据迁移、实时数据订阅及数据实时同步等多种数据传输能力。通过数据传输可实现不停服数据迁移、数据异地灾备、跨境数据同步、缓存更新策略等多种业务应用场景，助您构建安全、可扩展、高可用的数据架构。<br>链接：<a href="https://www.aliyun.com/product/dts" target="_blank" rel="noopener">https://www.aliyun.com/product/dts</a></p>
<blockquote>
<p>数据传输服务的描述里只写了数据库，没写支持文件同步，比较奇怪</p>
</blockquote>
<h3 id="腾讯云"><a href="#腾讯云" class="headerlink" title="腾讯云"></a>腾讯云</h3><h4 id="金融云解决方案-1"><a href="#金融云解决方案-1" class="headerlink" title="金融云解决方案"></a>金融云解决方案</h4><p>全系列云计算产品，为您实施高可用的业务容灾架构，随心打造。</p>
<p>链接：<a href="https://www.qcloud.com/solution/finance" target="_blank" rel="noopener">https://www.qcloud.com/solution/finance</a></p>
<h4 id="金融云专属产品-1"><a href="#金融云专属产品-1" class="headerlink" title="金融云专属产品"></a>金融云专属产品</h4><ol>
<li>专用宿主机 - 支持独享宿主机资源，灵活自主规划，避免资源竞争</li>
<li>金融大数据 - 独享大数据分析平台，提供精准个性化用户分析报告</li>
<li>金融数据库 - 兼容Mysql，数据强一致、异地自动同步、万级QPS高性能、自动扩容、灵活智能恢复</li>
<li>金融安全 - 专享攻击防护能力以及协同防御方案，保障金融业务安全</li>
</ol>
<h4 id="银行架构部署图-1"><a href="#银行架构部署图-1" class="headerlink" title="银行架构部署图"></a>银行架构部署图</h4><p><img src="/images/storage-backup-mutisite-qcloud-bank-arch.jpg" alt="qcloud bank arch"></p>
<p>链接：<a href="https://www.qcloud.com/solution/solutionSubpage/finance-bank" target="_blank" rel="noopener">https://www.qcloud.com/solution/solutionSubpage/finance-bank</a></p>
<p><strong>基于云的同城业务双活，两地三中心</strong></p>
<p>在腾讯云上构建的IT应用系统，可以利用腾讯云多地的合规机房和<code>分布式云数据库TDSQL</code>方便的建立同城业务双活、两地三中心的高可用架构应用。<br>两地三中心灾备部署架构如下图所示。<code>TDSQL云数据库</code>提供金融级的容灾架构支持两地三中心部署结构（异地节点直线距离一般大于100km），数据库的所有组件全部实现跨机房、跨地域部署。<br>在同城的生产中心和灾备中心之间，<code>TDSQL</code>实现数据实时同步；生产中心与异地灾备中心之间实现异步数据复制。</p>
<p><img src="/images/storage-backup-mutisite-qcloud-bank-sql.jpg" alt="qcloud bank arch"></p>
<p>通过上述架构可以以较低的成本实现同城双活，数据异地自动备份，不依赖IOE架构，以低于商业数据库1/2的成本实现99.99999%的超高可靠性。在实际应用中，以腾讯计费为例，TDSQL云数据库承载的账户量超过100亿，每日请求超10亿，99.95%的请求在5ms以内响应。连续两年多的运营零中断、零数据误差。</p>
<blockquote>
<p>可以推断是通过 ==<strong>分布式云数据库TDSQL</strong>== 实现的灾备</p>
</blockquote>
<p><strong>云数据库 MariaDB</strong></p>
<p>云数据库 MariaDB (又名 TDSQL) 是基于 MariaDB 内核高度兼容 MySQL 的关系数据库，同时具有商用数据库的高安全性、可用性和开源数据库的低成本，主要应用于企业级服务场景；您只需付出商用数据库的 1/10 费用，即可拥有商用数据库的安全性、数据一致性和可靠性。</p>
<table>
<thead>
<tr>
<th>产品特性</th>
<th>介绍</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据强一致性</td>
<td>默认配置强同步复制</td>
</tr>
<tr>
<td>更高安全</td>
<td>全面的安全防护</td>
</tr>
<tr>
<td>更高可用性</td>
<td>提供高于99.99%的可用性，透明的故障转移</td>
</tr>
<tr>
<td>更高性能</td>
<td>基于PCI-E SSD、强大IO性能</td>
</tr>
<tr>
<td>与 MySQL 兼容</td>
<td>高度兼容 MySQL5.5、5.6</td>
</tr>
</tbody>
</table>
<p>链接：<a href="https://www.qcloud.com/product/tdsql" target="_blank" rel="noopener">https://www.qcloud.com/product/tdsql</a></p>
<h4 id="使用产品-1"><a href="#使用产品-1" class="headerlink" title="使用产品"></a>使用产品</h4><ol>
<li>金融服务器/专用宿主机</li>
<li>金融数据库</li>
<li>金融大数据</li>
<li>负载均衡</li>
<li>私有网络</li>
<li>对象存储</li>
<li>云安全</li>
<li>云监控</li>
</ol>
<h3 id="百度云"><a href="#百度云" class="headerlink" title="百度云"></a>百度云</h3><h4 id="金融云解决方案-2"><a href="#金融云解决方案-2" class="headerlink" title="金融云解决方案"></a>金融云解决方案</h4><p>百度金融云解决方案为银行、证券、保险及互联网金融行业提供安全可靠的IT基础设施、大数据分析、人工智能及百度生态支持等整体方案，为金融机构的效率提升及业务创新提供技术支撑</p>
<p>链接：<a href="https://cloud.baidu.com/solution/finance.html" target="_blank" rel="noopener">https://cloud.baidu.com/solution/finance.html</a></p>
<h4 id="金融云专属产品-2"><a href="#金融云专属产品-2" class="headerlink" title="金融云专属产品"></a>金融云专属产品</h4><ol>
<li>专属资源池 - 独享的计算存储资源池</li>
<li>安全体系</li>
<li>VPN/专线 + VPC</li>
<li>大数据分析 - 提供完整的大数据分析服务</li>
<li>人工智能 - 人脸识别/文字识别</li>
<li>容灾体系 - 同城多可用区及异地云机房，构建两地三中心容灾体系</li>
</ol>
<h4 id="银行架构部署图-2"><a href="#银行架构部署图-2" class="headerlink" title="银行架构部署图"></a>银行架构部署图</h4><p><img src="/images/storage-backup-mutisite-baidu-bank-arch.jpg" alt="baidu bank arch"></p>
<blockquote>
<p>可以看出图中画的只是 ==<strong>数据库</strong>== 的同步</p>
</blockquote>
<h4 id="使用产品-2"><a href="#使用产品-2" class="headerlink" title="使用产品"></a>使用产品</h4><ol>
<li>应用服务器</li>
<li>数据库</li>
<li>负载均衡</li>
<li>云安全</li>
<li>云监控</li>
<li>大数据分析服务</li>
<li>人工智能服务</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>对比国内几家大的公有云厂商的金融云服务方案，可以得出<code>两地三中心</code>的数据灾备是其核心，其业务有可以拆分为：</p>
<ol>
<li>同城数据中心数据实时同步</li>
<li>异地数据中心数据异步复制</li>
</ol>
<h3 id="同城数据实时同步"><a href="#同城数据实时同步" class="headerlink" title="同城数据实时同步"></a>同城数据实时同步</h3><p>同城数据中心之间一般都要求数据实时同步，RPO为0，RTO为秒级。</p>
<p>上文提到的几种数据同步有：</p>
<ol>
<li><p>数据库实时同步</p>
<p> 几家的解决方案里，都提到了<code>分布式数据库</code>，实现同城两个数据中心的数据强一致性，这个可以通过部署<code>分布式数据库</code>的实例分别在两个数据中心，然后配置<code>分布式数据库</code>为<code>实时同步</code>即可。</p>
<p> 所以这里的关键为：<strong>实现<code>跨数据中心</code>的，<code>实时同步</code>的<code>分布式数据库</code></strong></p>
</li>
<li><p>主备文件同步</p>
<p> 阿里云架构图里体现了通过<code>数据传输</code>服务实现文件同步，这个不是实时的。</p>
</li>
<li><p>对象存储同步</p>
<p> 腾讯云架构图里体现了对象存储的数据同步，通过分析，这个也不是实时的。</p>
</li>
</ol>
<h3 id="异地数据异步复制"><a href="#异地数据异步复制" class="headerlink" title="异地数据异步复制"></a>异地数据异步复制</h3><p>异地数据中心之间一般只要求数据异步复制即可，RPO为秒或分钟级，RTO为分钟级。</p>
<p>上文提到的几种数据异步复制有：</p>
<ol>
<li><p>数据库异步复制</p>
<p> 这个可以通过配置数据库的<code>主从关系</code>和<code>异步复制</code>即可。</p>
</li>
<li><p>文件异步复制</p>
<p> 阿里云架构图里的文件异步复制是通过<code>数据传输</code>服务实现的。</p>
</li>
<li><p>对象存储异步复制</p>
<p> 腾讯云架构图里体现了对象存储的异步复制，应该为内部实现。</p>
</li>
</ol>
<h3 id="自研需求"><a href="#自研需求" class="headerlink" title="自研需求"></a>自研需求</h3><h4 id="分布式数据库"><a href="#分布式数据库" class="headerlink" title="分布式数据库"></a>分布式数据库</h4><p><strong>要求</strong><br>跨数据中心 + 实时同步  </p>
<p><strong>自研</strong><br>参考阿里云和腾讯云，基于<code>MySQL</code>/<code>MariaDB</code>上，配置开发跨数据中心配置的数据库<br>难度：★★★★☆</p>
<h4 id="文件同步"><a href="#文件同步" class="headerlink" title="文件同步"></a>文件同步</h4><p><strong>要求</strong><br>同城秒级，异地分钟级延迟  </p>
<p><strong>建议</strong><br><code>rsync + inotify</code>实现  </p>
<p><strong>分析</strong><br>文件同步的<code>rsync + inotify</code>方案，应用较多，比较成熟，难道不大。<br>难度：★★☆☆☆</p>
<h4 id="对象存储同步"><a href="#对象存储同步" class="headerlink" title="对象存储同步"></a>对象存储同步</h4><p><strong>要求</strong><br>同城秒级，异地分钟级延迟  </p>
<p><strong>自研</strong><br>Ceph Radosgw 支持跨区域的同步<br>难度：★★★☆☆</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ictfox.cn/2017/09/04/kubernetes-storage-confuse/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/04/kubernetes-storage-confuse/" itemprop="url">kubernetes里存储概念的解疑</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-04T21:01:17+08:00">
                2017-09-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index">
                    <span itemprop="name">storage</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/09/04/kubernetes-storage-confuse/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/09/04/kubernetes-storage-confuse/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>近日在 Kubernetes 使用 Ceph 的问题中，因为在两地，没有面对面的沟通，导致了理解的差异与不解，后来与本地同事详细沟通后，终于弄明白了之前的隔阂和问题所在，这里做下记录。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="Kubernetes存储简介"><a href="#Kubernetes存储简介" class="headerlink" title="Kubernetes存储简介"></a>Kubernetes存储简介</h3><p>Kubernetes 里存储的使用，可分为两类：</p>
<ol>
<li><p>PersistentVolume和PersistentVolumeClaims</p>
<ul>
<li>A PersistentVolume(PV) is a piece of storage in the cluster that has been provisioned by an administrator.</li>
<li>A PersistentVolumeClaims(PVC) is a request for storage by a user.</li>
</ul>
</li>
<li><p>StorageClasses</p>
<ul>
<li>A StorageClass provides a way for administrators to describe the “classes” of storage they offer.</li>
</ul>
</li>
</ol>
<p>PVs支持两种方式的provision: statically or dynamically.</p>
<ul>
<li><p>Static</p>
<p>  A cluster administrator creates a number of PVs.</p>
</li>
<li><p>Dynamic</p>
<p>  Base StorageClasses, when none of the static PVs the administrator created matches a user’s PersistentVolumeClaim, the cluster may try to dynamically provision a volume specially for the PVC.</p>
</li>
</ul>
<p>从是否支持多客户端同时读写，也可分为三类：</p>
<ol>
<li>ReadWriteOnce</li>
<li>ReadOnlyMany </li>
<li>ReadWriteMany</li>
</ol>
<h3 id="Kubernetes存储需求"><a href="#Kubernetes存储需求" class="headerlink" title="Kubernetes存储需求"></a>Kubernetes存储需求</h3><p>Kubernetes 对存储的需求，大致可以总结为两类：</p>
<ol>
<li>独立使用的PV</li>
<li>支持多客户端同时读写的PV</li>
<li>支持多客户端同时读写 + <code>Dynamic provisioning</code>的PV</li>
</ol>
<h3 id="Ceph支持Kubernetes"><a href="#Ceph支持Kubernetes" class="headerlink" title="Ceph支持Kubernetes"></a>Ceph支持Kubernetes</h3><p>使用 Ceph 支持 Kubernetes，是否满足需求？</p>
<ol>
<li><p>独立使用的PV</p>
<p> Ceph RBD支持即可</p>
</li>
<li><p>支持多客户端同时读写的PV</p>
<p> CephFS / RBD + NFS</p>
</li>
</ol>
<p>所以从我的角度理解：Ceph是可以满足Kubernetes对存储的需求的。</p>
<p>但 Kubernetes 的同事却坚持 Ceph 不能满足需求<code>支持多客户端同时读写的PV</code>，要使用 Glusterfs 。Why？</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>这个事情在后来我与本地熟悉 Kubernetes 的同事详细沟通后，才终于弄明白之前的隔阂和问题所在。</p>
<p>下面从两个人所熟悉的知识领域来分析下问题。</p>
<h3 id="volume概念"><a href="#volume概念" class="headerlink" title="volume概念"></a>volume概念</h3><h4 id="存储角度"><a href="#存储角度" class="headerlink" title="存储角度"></a>存储角度</h4><p>首先说下在存储领域的volume含义，在存储领域也工作了快十年了，以为之前做过NAS和SAN存储，提起volume，我的印象还是一个卷，一个块设备。</p>
<p>熟悉存储的都知道，块设备是没法做到支持<code>多客户端同时读写</code>的，必须通过分布式文件系统来实现。所以提到volume，我就明确的表示它不会支持多客户端同时读写。</p>
<p>在网上搜索了下volume的定义，有下面几个不同的说法：</p>
<ol>
<li><p>storage volume</p>
<blockquote>
<p>A storage volume is an identifiable unit of data storage. It can be a removable hard disk, but it does not have to be a unit that can be physically removed from a computer or storage system.</p>
</blockquote>
<p> 参考：<a href="http://searchstorage.techtarget.com/definition/volume" target="_blank" rel="noopener">http://searchstorage.techtarget.com/definition/volume</a></p>
</li>
<li><p>LUN与volume的描述</p>
<p> 这个描述，与我理解的volume不一致 :(  </p>
<blockquote>
<p>LUN是对存储设备而言的，volume是对主机而言的。<br>LUN相对于主机来讲就是一个“物理硬盘”，与C盘D盘所在IDC或SCSI硬盘的性属是相同的。在该“物理硬盘”上创建一个或多个分区，再创建文件系统，才可以得到一个VOLUME。此时VOLUME相对于主机是一个逻辑设备。<br><a href="http://blog.csdn.net/liukuan73/article/details/45506441" target="_blank" rel="noopener">http://blog.csdn.net/liukuan73/article/details/45506441</a>  </p>
</blockquote>
<p> ==我不赞同上述文章里的说法！后面介绍的才是正确的==</p>
<p> 可以参考这里的介绍，更加可靠些：</p>
<blockquote>
<p>A volume normally refers to a “disk” created via a “volume manager” such as Veritas or a volume created by an operating system such as Windows NT.<br>A LUN refers to a “logical unit number” presented to a host as ==a SCSI ID==. (i.e., LUN number 1 specifies SCSI ID 1 on that port. Therefore, the term volume can be considered software based and LUN considered hardware based.<br><a href="http://searchstorage.techtarget.com/answer/The-difference-between-volume-and-a-LUN" target="_blank" rel="noopener">http://searchstorage.techtarget.com/answer/The-difference-between-volume-and-a-LUN</a></p>
</blockquote>
<p> 在另一篇文章里也图形化描述了LUN和volume的区别：<br> <img src="/images/volume-lun-difference.jpg" alt="difference of volume and lun"></p>
<p> 参考：<a href="https://jmetz.com/2016/11/whats-the-difference-between-a-lun-and-a-volume/" target="_blank" rel="noopener">https://jmetz.com/2016/11/whats-the-difference-between-a-lun-and-a-volume/</a></p>
</li>
<li><p>Glusterfs volume</p>
<p> Glusterfs里对volume的说明  </p>
<blockquote>
<p>A volume is a logical collection of bricks where each brick is an export directory on a server in the trusted storage pool.</p>
</blockquote>
</li>
<li><p>其他</p>
<p> 在LVM和openstack里，volume的概念则与SAN中的一致，都是块设备。</p>
</li>
</ol>
<p>==<strong>所以，以后提到volume还是要看具体的应用场景！！！</strong>==</p>
<h4 id="Kubernetes角度"><a href="#Kubernetes角度" class="headerlink" title="Kubernetes角度"></a>Kubernetes角度</h4><p>在 Kubernetes 的官网上有这么一段话：</p>
<blockquote>
<p>At its core, a volume is just a directory, possibly with some data in it, which is accessible to the containers in a pod. How that directory comes to be, the medium that backs it, and the contents of it are determined by the particular volume type used.</p>
</blockquote>
<p>参考： <a href="https://kubernetes.io/docs/concepts/storage/volumes/#background" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/storage/volumes/#background</a></p>
<p>所以从上面可知，这里的volume是指后端存储提供的一个目录。</p>
<p>若volume指一个后端存储提供的目录，那是否支持<code>多客户端同时读写</code>，就看后端提供该目录的实现了。</p>
<h3 id="provisioning概念"><a href="#provisioning概念" class="headerlink" title="provisioning概念"></a>provisioning概念</h3><h4 id="存储角度-1"><a href="#存储角度-1" class="headerlink" title="存储角度"></a>存储角度</h4><p>存储里有<code>storage provisioning</code>概念，<code>storage provisioning</code>指的是分配空间的处理过程，通常这种空间是服务器磁盘空间，通过存储自动配置可以优化存储局域网（SAN）的性能，分为<code>fat-provisioning</code>和<code>thin-provisioning</code>两种。</p>
<ol>
<li><p><code>fat-provisioning</code></p>
<p> 预先分配，底层存储会预留出对应请求的存储空间。</p>
</li>
<li><p><code>thin-provisioning</code></p>
<p> 实时分配（也称为精简分配），底层存储会根据实时需求动态分配存储空间，而不预先预留出存储空间。</p>
<p> 有这么一段介绍：  </p>
<blockquote>
<p>Thin provisioning (TP) is a method of optimizing the efficiency with which the available space is utilized in storage area networks (SAN).</p>
</blockquote>
</li>
</ol>
<p>所以存储角度说的provisioning，是SAN系统相关的，不是文件系统相关的。</p>
<h4 id="Kubernetes角度-1"><a href="#Kubernetes角度-1" class="headerlink" title="Kubernetes角度"></a>Kubernetes角度</h4><p>在 Kubernetes 里，提出<code>Dynamic Provisioning</code>的概念，是在<code>Storageclass</code>里提到的，介绍如下：</p>
<p><strong>Dynamic</strong>  </p>
<blockquote>
<p>When none of the static PVs the administrator created matches a user’s PersistentVolumeClaim, the cluster may try to dynamically provision a volume specially for the PVC. This provisioning is based on StorageClasses: the PVC must request a class and the administrator must have created and configured that class in order for dynamic provisioning to occur. Claims that request the class “” effectively disable dynamic provisioning for themselves.</p>
</blockquote>
<p>大致就是用户不用配置很多个PV了，只需要配置好<code>Storageclass</code>，在PVC里指定<code>Storageclass</code>即可，这样 Kubernetes 会自动的从<code>Storageclass</code>里配置好的存储里动态分配出一个指定size的PV，把PVC绑定到PV上。</p>
<p>参考： <a href="http://blog.kubernetes.io/2016/10/dynamic-provisioning-and-storage-in-kubernetes.html" target="_blank" rel="noopener">http://blog.kubernetes.io/2016/10/dynamic-provisioning-and-storage-in-kubernetes.html</a></p>
<p>所以 Kubernetes 角度说的provisioning，其实是PV的动态分配，跟存储里的provisioning不一样。</p>
<blockquote>
<p>同事当时说成<code>fs provisioning</code>，弄的我很困惑，存储里没有<code>fs provisioning</code>这一说</p>
</blockquote>
<h3 id="明确需求"><a href="#明确需求" class="headerlink" title="明确需求"></a>明确需求</h3><p>经过上面的分析，我明确了同事对 Kubernetes 存储的需求是要支持：<code>Storageclass的Dynamic Provisioning</code> + <code>ReadWriteMany</code>。</p>
<p>查看Kubernetes官方文档，各个后端存储的支持情况为：</p>
<h4 id="PV"><a href="#PV" class="headerlink" title="PV"></a>PV</h4><table>
<thead>
<tr>
<th>Volume Plugin</th>
<th>ReadWriteOnce</th>
<th>ReadOnlyMany</th>
<th>ReadWriteMany</th>
</tr>
</thead>
<tbody>
<tr>
<td>AWSElasticBlockStore</td>
<td>✓</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>AzureFile</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>AzureDisk</td>
<td>✓</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>==CephFS==</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>Cinder</td>
<td>✓</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>FC</td>
<td>✓</td>
<td>✓</td>
<td>-</td>
</tr>
<tr>
<td>FlexVolume</td>
<td>✓</td>
<td>✓</td>
<td>-</td>
</tr>
<tr>
<td>Flocker</td>
<td>✓</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>GCEPersistentDisk</td>
<td>✓</td>
<td>✓</td>
<td>-</td>
</tr>
<tr>
<td>==Glusterfs==</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>HostPath</td>
<td>✓</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>iSCSI</td>
<td>✓</td>
<td>✓</td>
<td>-</td>
</tr>
<tr>
<td>PhotonPersistentDisk</td>
<td>✓</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>Quobyte</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>NFS</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>==RBD==</td>
<td>✓</td>
<td>✓</td>
<td>-</td>
</tr>
<tr>
<td>VsphereVolume</td>
<td>✓</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>PortworxVolume</td>
<td>✓</td>
<td>-</td>
<td>✓</td>
</tr>
<tr>
<td>ScaleIO</td>
<td>✓</td>
<td>✓</td>
<td>-</td>
</tr>
<tr>
<td>StorageOS</td>
<td>✓</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<h4 id="StorageClasses"><a href="#StorageClasses" class="headerlink" title="StorageClasses"></a>StorageClasses</h4><table>
<thead>
<tr>
<th>Volume Plugin</th>
<th>Internal Provisioner</th>
</tr>
</thead>
<tbody>
<tr>
<td>AWSElasticBlockStore</td>
<td>✓</td>
</tr>
<tr>
<td>AzureFile</td>
<td>✓</td>
</tr>
<tr>
<td>AzureDisk</td>
<td>✓</td>
</tr>
<tr>
<td>==CephFS==</td>
<td>-</td>
</tr>
<tr>
<td>Cinder</td>
<td>✓</td>
</tr>
<tr>
<td>FC</td>
<td>-</td>
</tr>
<tr>
<td>FlexVolume</td>
<td>-</td>
</tr>
<tr>
<td>Flocker</td>
<td>✓</td>
</tr>
<tr>
<td>GCEPersistentDisk</td>
<td>✓</td>
</tr>
<tr>
<td>==Glusterfs==</td>
<td>✓</td>
</tr>
<tr>
<td>iSCSI</td>
<td>-</td>
</tr>
<tr>
<td>PhotonPersistentDisk</td>
<td>✓</td>
</tr>
<tr>
<td>Quobyte</td>
<td>✓</td>
</tr>
<tr>
<td>NFS</td>
<td>-</td>
</tr>
<tr>
<td>==RBD==</td>
<td>✓</td>
</tr>
<tr>
<td>VsphereVolume</td>
<td>✓</td>
</tr>
<tr>
<td>PortworxVolume</td>
<td>✓</td>
</tr>
<tr>
<td>ScaleIO</td>
<td>✓</td>
</tr>
</tbody>
</table>
<p>对比上面可以得知，Ceph提供的RBD和CephFS都不能满足 Kubernetes 的<code>Storageclass的Dynamic Provisioning</code> + <code>ReadWriteMany</code>的需求，而Glusterfs则可以。</p>
<blockquote>
<p>CephFS的Quota现在只有Ceph FUSE客户端支持，kernel client还不支持，这也许就是<code>Storageclass</code>还没支持<code>CephFS</code>的原因吧</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ictfox.cn/2017/08/30/cephfs-knowledge-share-part1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/30/cephfs-knowledge-share-part1/" itemprop="url">cephfs架构解读与测试分析-part1 </a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-30T20:41:17+08:00">
                2017-08-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ceph/" itemprop="url" rel="index">
                    <span itemprop="name">ceph</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/30/cephfs-knowledge-share-part1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/08/30/cephfs-knowledge-share-part1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前几天有幸在日知录社区里分享了自己对CephFS的理解与CephFS的测试分析，然后把内容整理如下，因为内容比较多，保持与日知录社区的文章一致，这里先贴出第一部分。</p>
<p>若对我的分享比较感兴趣，可以访问链接：<a href="https://m.qlchat.com/topic/details?topicId=240000540003989" target="_blank" rel="noopener">日知录 - CephFS架构解读与测试分析</a></p>
<h2 id="CephFS架构解读"><a href="#CephFS架构解读" class="headerlink" title="CephFS架构解读"></a>CephFS架构解读</h2><h3 id="cephFS简介"><a href="#cephFS简介" class="headerlink" title="cephFS简介"></a>cephFS简介</h3><p>CephFS是Ceph提供的兼容Posix协议的文件系统 ，对比RBD和RGW，它是最晚满足Production ready的一个功能。CephFS的底层还是使用rados存储数据，用MDS管理filesystem的元数据。</p>
<p>在Jewel版本里，CephFS的基本功能已经ready，但是很多feature还是experimental的，并不建议在生成环境打开这些feature。</p>
<h4 id="CephFS特性"><a href="#CephFS特性" class="headerlink" title="CephFS特性"></a>CephFS特性</h4><ol>
<li><p>可扩展性</p>
<p> CephFS的client端是直接读写OSDs的，所以OSDs的扩展性也体现在CephFS中</p>
</li>
<li><p>共享文件系统</p>
<p> CephFS是一个共享的文件系统，支持多个clients同时读写文件系统的一个file</p>
</li>
<li><p>高可用性</p>
<p> CephFS支持配置元数据服务器集群，也可以配置为Active-Standby的主从服务器，提高可用性</p>
</li>
<li><p>文件/目录Layout配置</p>
<p> CephFS支持配置任一文件/目录的Layout，文件/目录若不单独配置，默认继承父目录的Layout属性</p>
</li>
<li><p>POSIX ACLs支持</p>
<p> CephFS支持POSIX的ACLs，在CephFS支持的两个client中，kernel client默认支持，FUSE client需要修改配置来支持</p>
</li>
<li><p>Quotas支持</p>
<p> CephFS在后端没有实现Quota的功能，它的Quota是在CephFS FUSE client端实现的，而kernel client里还没有添加</p>
</li>
</ol>
<h4 id="CephFS架构"><a href="#CephFS架构" class="headerlink" title="CephFS架构"></a>CephFS架构</h4><p>如下图所示：</p>
<p><img src="/images/cephfs-arch.jpg" alt="architecture"></p>
<p>最底层还是基础的OSDs和Monitors，添加了MDSs，上层是支持客户端的CephFS kernel object，CephFS FUSE，CephFS Library等。</p>
<h4 id="CephFS组件间通信"><a href="#CephFS组件间通信" class="headerlink" title="CephFS组件间通信"></a>CephFS组件间通信</h4><p><img src="/images/cephfs-component-communication.jpg" alt="component communication"></p>
<p>如上图所示，CephFS各个组件间通信如下：</p>
<ol>
<li><p>Client &lt;–&gt; MDS</p>
<p> 元数据操作和capalities</p>
</li>
<li><p>Client &lt;–&gt; OSD</p>
<p> 数据IO</p>
</li>
<li><p>Client &lt;–&gt; Monitor</p>
<p> 认证，集群map信息等</p>
</li>
<li><p>MDS &lt;–&gt; Monitor</p>
<p> 心跳，集群map信息等</p>
</li>
<li><p>MDS &lt;–&gt; OSD</p>
<p> 元数据IO</p>
</li>
<li><p>Monitor &lt;–&gt; OSD</p>
<p> 心跳，集群map信息等</p>
</li>
</ol>
<h4 id="CephFS-MDS组件"><a href="#CephFS-MDS组件" class="headerlink" title="CephFS MDS组件"></a>CephFS MDS组件</h4><p>Ceph MDS设计的比较强大，作为一个能存储PB级数据的文件系统，它充分考虑了对元数据服务器的要求，设计了MDS集群。另外也引入了MDS的动态子树迁移，MDS的热度负载均衡。</p>
<p>但也正是这么超前的设计，使得MDS集群很难做到稳定，所以目前Jewel版本里默认还是单MDS实例，用户可配置主从MDS实例，提高可用性。 但在未来，MDS集群的这些属性都将稳定下来，为我们提供超强的元数据管理性能。</p>
<p><img src="/images/cephfs-mds-dynamic-subtree.jpg" alt="mds dynamic subtree"></p>
<p>上图描述了CephFS的Dynamic subtree partition功能，它支持目录分片在多个MDS之间服务，并支持基于MDS负载均衡的动态迁移。</p>
<p>Client跟MDS通信后，会缓存对应的“目录-MDS”映射关系，这样Client任何时候都知道从哪个MDS上获取对应的元数据信息。</p>
<p><strong>MDS自身的元数据有：</strong></p>
<ul>
<li><p>per-MDS journal</p>
<p>  每个MDS都有一个对应的journal文件，支持大到几百兆字节的size，保证元数据的一致性和顺序提交的性能，它也是直接存储到OSD cluster里的</p>
</li>
<li><p>CephFS MetaData</p>
<p>  MDS管理的CephFS的元数据也以文件格式存储到OSD cluster上，有些元数据信息会存到object的OMAP里</p>
</li>
</ul>
<h3 id="CephFS使用方式"><a href="#CephFS使用方式" class="headerlink" title="CephFS使用方式"></a>CephFS使用方式</h3><p>与通常的网络文件系统一样，要访问cephfs，需要有对应的client端。cephfs现在支持两种client端：</p>
<ul>
<li>CephFS kernel client<ul>
<li>since 2.6.34 </li>
</ul>
</li>
<li>CephFS FUSE</li>
</ul>
<p><img src="/images/cephfs-client-access-mode.jpg" alt="client access mode"></p>
<p>Client端访问CepFS的步骤如下：</p>
<ol>
<li>client端与MDS节点通讯，获取metadata信息（metadata也存在osd上）</li>
<li>client直接写数据到OSD</li>
</ol>
<h4 id="Client端访问CephFS示例"><a href="#Client端访问CephFS示例" class="headerlink" title="Client端访问CephFS示例"></a>Client端访问CephFS示例</h4><ol>
<li>Client发送open file请求给MDS </li>
<li>MDS返回file inode，file size，capability和stripe信息 </li>
<li>Client直接Read/Write数据到OSDs </li>
<li>MDS管理file的capability </li>
<li>Client发送close file请求给MDS，释放file的capability，更新file详细信息 </li>
</ol>
<blockquote>
<p>这里cephfs并没有像其他分布式文件系统设计的那样，有分布式文件锁来保障数据一致性<br>它是通过文件的capability来保证的</p>
</blockquote>
<h4 id="CephFS相关命令"><a href="#CephFS相关命令" class="headerlink" title="CephFS相关命令"></a>CephFS相关命令</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">创建MDS Daemon</span><br><span class="line"><span class="comment"># ceph-deploy mds create &lt;…&gt;</span></span><br><span class="line">创建CephFS Data Pool</span><br><span class="line"><span class="comment"># ceph osd pool create &lt;…&gt;</span></span><br><span class="line">创建CephFS Metadata Pool</span><br><span class="line"><span class="comment"># ceph osd pool create &lt;…&gt;</span></span><br><span class="line">创建CephFS</span><br><span class="line"><span class="comment"># ceph fs new &lt;…&gt;</span></span><br><span class="line">查看CephFS</span><br><span class="line"><span class="comment"># ceph fs ls </span></span><br><span class="line">	name: tstfs, metadata pool: cephfs_metadata, data pools: [cephfs_data ]</span><br><span class="line">删除CephFS</span><br><span class="line"><span class="comment"># ceph fs rm &lt;fs-name&gt; --yes-i-really-mean-it</span></span><br></pre></td></tr></table></figure>
<p>查看MDS状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ceph mds stat</span></span><br><span class="line">	e8: tstfs-1/1/1 up tstfs2-0/0/1 up &#123;[tstfs:0]=mds-daemon-1=up:active&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>e8 <ul>
<li>e表示epoch</li>
<li>8是epoch号</li>
</ul>
</li>
<li>tstfs-1/1/1 up<ul>
<li>tstfs是cephfs名字</li>
<li>三个1分别是 mds_map.in/mds_map.up/mds_map.max_mds</li>
<li>up是cephfs状态</li>
</ul>
</li>
<li>{[tstfs:0]=mds-daemon-1=up:active} <ul>
<li>[tstfs:0]指tstfs的rank 0</li>
<li>mds-daemon-1是服务tstfs的mds daemon name</li>
<li>up:active是cephfs的状态为 up &amp; active</li>
</ul>
</li>
</ul>
<h4 id="mount使用CephFS"><a href="#mount使用CephFS" class="headerlink" title="mount使用CephFS"></a>mount使用CephFS</h4><ol>
<li>CephFS kernel client</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mount -t ceph &lt;monitor ip&gt;:6789 /mntdir</span></span><br><span class="line"><span class="comment"># umount /mntdir</span></span><br></pre></td></tr></table></figure>
<ol>
<li>CephFS FUSE</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">安装ceph-fuse pkg</span><br><span class="line"><span class="comment"># yum install -y ceph-fuse</span></span><br><span class="line"><span class="comment"># ceph-fuse -m &lt;monitor ip&gt;:6789 /mntdir </span></span><br><span class="line"><span class="comment"># fusermount -u /mntdir</span></span><br><span class="line">centos7里没有fusermount命令，可以用umount替代</span><br></pre></td></tr></table></figure>
<p>FUSE的IO Path较长，会先从用户态调用到内核态，再返回到用户态使用CephFS FUSE模块访问Ceph集群，如下图所示：</p>
<p><img src="/images/cephfs-fuse-arch.jpg" alt="fuse arch"></p>
<p><strong>对比</strong></p>
<ul>
<li>性能：Kernel client &gt; ceph-fuse</li>
<li>Quota支持：只有ceph-fuse(client-side quotas)</li>
</ul>
<blockquote>
<p>Quota不是在CephFS后端实现的，而是在client-side实现的。若某些应用中要求使用Quota，这时就必须考虑使用CephFS FUSE了</p>
</blockquote>
<h3 id="CephFS-Layout"><a href="#CephFS-Layout" class="headerlink" title="CephFS Layout"></a>CephFS Layout</h3><p>Cephfs支持配置目录、文件的layout和stripe，这些元数据信息保存在目录和文件的xattr中。</p>
<ul>
<li>目录的layout xattrs为：ceph.dir.layout</li>
<li>文件的layout xattrs为：ceph.file.layout</li>
</ul>
<p>CephFS支持的layout配置项有：</p>
<ul>
<li>pool<br>  数据存储到指定pool</li>
<li>namespace<br>  数据存储到指定namespace，比pool更细的粒度(rbd/rgw/cephfs都还不支持)</li>
<li>stripe_unit<br>  条带大小，单位Byte</li>
<li>stripe_count<br>  条带个数</li>
</ul>
<p><strong>默认文件/目录继承父目录的layout和striping</strong></p>
<p><strong>示例：</strong> 配置一个目录的Layout</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># setfattr -n ceph.dir.layout -v "stripe_unit=524288 stripe_count=8 object_size=4194304 pool=cephfs_data2" /mnt/mike512K/</span></span><br></pre></td></tr></table></figure>
<p>目录中一个9MB的文件的layout分布图为：<br><img src="/images/cephfs-layout-example.jpg" alt="layout example"></p>
<h3 id="CephFS认证"><a href="#CephFS认证" class="headerlink" title="CephFS认证"></a>CephFS认证</h3><p>有时候可能应用有这样的需求，不同的用户访问不同的CephFS目录，这时候就需要开启CephFS的认证。</p>
<p>不过首先需要开启的是Ceph集群的认证，然后就可以创建CephFS认证的client端了，指定client对mon，mds，osd的访问权限。</p>
<h4 id="开启Ceph集群认证"><a href="#开启Ceph集群认证" class="headerlink" title="开启Ceph集群认证"></a>开启Ceph集群认证</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">配置ceph.conf</span><br><span class="line"><span class="comment"># vim /etc/ceph/ceph.conf</span></span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br></pre></td></tr></table></figure>
<h4 id="创建CephFS认证的client"><a href="#创建CephFS认证的client" class="headerlink" title="创建CephFS认证的client"></a>创建CephFS认证的client</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ceph auth get-or-create client.*client_name* \</span></span><br><span class="line">		mon <span class="string">'allow r'</span> \</span><br><span class="line">		mds <span class="string">'allow r, allow rw path=/*specified_directory*'</span> \</span><br><span class="line">		osd <span class="string">'allow rw pool=&lt;data pool&gt;’</span></span><br></pre></td></tr></table></figure>
<p><strong>示例与解释：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ceph auth get-or-create client.tst1 mon ‘allow r’ mds ‘allow r, allow rw path=/tst1’ osd ‘allow rw pool=cephfs_data'</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>mon ‘allow r’</p>
<p>  允许client从monitor读取数据；必须配置</p>
</li>
<li><p>mds ‘allow r, allow rw path=/tst1’</p>
<p>  允许client从MDS读取数据，允许client对目录/tst1读写；<br>  其中‘ allow r’必须配置，不然client不能从mds读取数据，mount会报permission error；</p>
</li>
<li><p>osd ‘allow rw pool=cephfs_data’</p>
<p>  允许client从osd pool=cephfs_data 上读写数据；<br>  若不配置，client只能从mds上获取FS的元数据信息，没法查看各个文件的数据</p>
</li>
</ul>
<blockquote>
<p>对osd的权限也是必须配置的，不然client只能从mds上获取fs的元数据信息，没法查看文件的数据</p>
</blockquote>
<h4 id="检查ceph-auth"><a href="#检查ceph-auth" class="headerlink" title="检查ceph auth"></a>检查ceph auth</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ceph auth get client.tst1 </span></span><br><span class="line">exported keyring <span class="keyword">for</span> client.tst1 </span><br><span class="line">[client.tst] </span><br><span class="line">    key = AQCd+UBZxpi4EBAAUNyBDGdZbPgfd4oUb+u41A== </span><br><span class="line">    caps mds = allow r, allow rw path=/tst1<span class="string">" </span></span><br><span class="line"><span class="string">    caps mon = "</span>allow r<span class="string">"</span></span><br><span class="line"><span class="string">    caps osd = "</span>allow rw pool=cephfs_data<span class="string">"</span></span><br></pre></td></tr></table></figure>
<h4 id="mount测试"><a href="#mount测试" class="headerlink" title="mount测试"></a>mount测试</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mount -t ceph &lt;ip&gt;:6789:/tst1 /mnt -o name=tst1,secret=AQCd+UBZxpi4EBAAUNyBDGdZbPgfd4oUb+u41A==</span></span><br></pre></td></tr></table></figure>
<h4 id="认证机制不完善"><a href="#认证机制不完善" class="headerlink" title="认证机制不完善"></a>认证机制不完善</h4><p>CephFS的认证机制还不完善，上述client.tst1可以mount整个CephFS目录，能看到并读取整个CephFS的文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mount -t ceph &lt;ip&gt;:6789:/ /mnt -o name=tst1,secret=AQCd+UBZxpi4EBAAUNyBDGdZbPgfd4oUb+u41A==</span></span><br></pre></td></tr></table></figure>
<p>另外没找到能支持readonly访问某一目录的方法。</p>
<blockquote>
<p>只验证了cephfs kernel client，没试过ceph-fuse的认证</p>
</blockquote>
<h3 id="CephFS的-FSCK-amp-Repair"><a href="#CephFS的-FSCK-amp-Repair" class="headerlink" title="CephFS的 FSCK &amp; Repair"></a>CephFS的 FSCK &amp; Repair</h3><p>FS的fsck和repair对一个文件系统是非常重要的，如果这个没搞定，一个文件系统是不会有人敢用的。</p>
<p>Ceph在Jewel版本里提供了Ready的CephFS的scrub和repair工具，它哪能处理大部分的元数据损坏。<br>但在使用中请记住两点：</p>
<ol>
<li>修复命令==慎重执行==，需要专业人士操作</li>
<li>若命令支持，修复前请先备份元数据</li>
</ol>
<h4 id="cephfs-journal工具"><a href="#cephfs-journal工具" class="headerlink" title="cephfs journal工具"></a>cephfs journal工具</h4><p>cephfs-journal-tool，用来修复损坏的MDS journal，它支持的命令有下面几类，详细的介绍看下help就明白了。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cephfs-journal-tool：</span><br><span class="line">	- inspect/import/<span class="built_in">export</span>/reset </span><br><span class="line">	- header get/<span class="built_in">set</span></span><br><span class="line">	- event get/apply/recover_dentries/splice</span><br></pre></td></tr></table></figure>
<h4 id="cephfs-online-check-scrub"><a href="#cephfs-online-check-scrub" class="headerlink" title="cephfs online check/scrub"></a>cephfs online check/scrub</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ceph tell mds.&lt;id&gt; damage ls </span><br><span class="line">ceph tell mds.&lt;id&gt; damage rm &lt;int&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># scrub an inode and output results</span></span><br><span class="line">ceph mds mds.&lt;id&gt; scrub_path &lt;path&gt; &#123;force|recursive|repair [force|recursive|repair...]&#125;</span><br></pre></td></tr></table></figure>
<h4 id="cephfs-offline-repair"><a href="#cephfs-offline-repair" class="headerlink" title="cephfs offline repair"></a>cephfs offline repair</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cephfs-data-scan init [--force-init] </span><br><span class="line">cephfs-data-scan scan_extents [--force-pool] &lt;data pool name&gt; </span><br><span class="line">cephfs-data-scan scan_inodes [--force-pool] [--force-corrupt] &lt;data pool name&gt;</span><br><span class="line">cephfs-data-scan scan_frags [--force-corrupt]</span><br><span class="line">cephfs-data-scan tmap_upgrade &lt;metadata_pool&gt;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ictfox.cn/2017/08/28/storage-system-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ictfox">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ictfox.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ictfox blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/28/storage-system-summary/" itemprop="url">开源存储系统罗列</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-28T13:41:17+08:00">
                2017-08-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index">
                    <span itemprop="name">storage</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/28/storage-system-summary/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/08/28/storage-system-summary/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>整理之前的文章时候，发现了这个，仅仅是一些存储系统的简单罗列，但对想熟悉开源存储系统的人来说也有些帮助。</p>
<blockquote>
<p>理解有限，若有不对的地方，欢迎指正！</p>
</blockquote>
<h2 id="分布式文件系统"><a href="#分布式文件系统" class="headerlink" title="分布式文件系统"></a>分布式文件系统</h2><table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
<th>存储功能</th>
<th>语言</th>
<th>官网 / WIKI</th>
<th>源码</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ceph</td>
<td>基于RADOS提供高扩展性、高可靠性、高性能的分布式文件系统</td>
<td>对象存储，块存储，文件存储</td>
<td>C++</td>
<td><a href="http://ceph.com/" target="_blank" rel="noopener">http://ceph.com/</a></td>
<td><a href="https://github.com/ceph/ceph" target="_blank" rel="noopener">https://github.com/ceph/ceph</a></td>
</tr>
<tr>
<td>Swift</td>
<td>Openstack官方的对象存储系统</td>
<td>对象存储</td>
<td>Python</td>
<td><a href="https://wiki.openstack.org/wiki/Swift" target="_blank" rel="noopener">https://wiki.openstack.org/wiki/Swift</a></td>
<td><a href="https://github.com/openstack/swift" target="_blank" rel="noopener">https://github.com/openstack/swift</a></td>
</tr>
<tr>
<td>Cinder</td>
<td>Openstack官方的块存储系统</td>
<td>块存储</td>
<td>Python</td>
<td><a href="https://wiki.openstack.org/wiki/Cinder" target="_blank" rel="noopener">https://wiki.openstack.org/wiki/Cinder</a></td>
<td><a href="https://github.com/openstack/cinder" target="_blank" rel="noopener">https://github.com/openstack/cinder</a></td>
</tr>
<tr>
<td>GlusterFS</td>
<td>分布式文件系统，弹性扩容 <br> 无metadata服务器</td>
<td>文件存储</td>
<td>C</td>
<td><a href="https://www.gluster.org/" target="_blank" rel="noopener">https://www.gluster.org/</a></td>
<td><a href="https://github.com/gluster/glusterfs" target="_blank" rel="noopener">https://github.com/gluster/glusterfs</a></td>
</tr>
<tr>
<td>Lustre</td>
<td>一个大规模的、安全可靠的，具备高可用性的集群文件系统</td>
<td>文件存储</td>
<td>C</td>
<td><a href="http://lustre.org/" target="_blank" rel="noopener">http://lustre.org/</a></td>
<td>git clone git://git.hpdd.intel.com/fs/lustre-release.git</td>
</tr>
<tr>
<td>Sheepdog</td>
<td>分布式块存储系统</td>
<td>块存储</td>
<td>C</td>
<td><a href="http://www.sheepdog-project.org/" target="_blank" rel="noopener">http://www.sheepdog-project.org/</a></td>
<td><a href="https://github.com/sheepdog/sheepdog" target="_blank" rel="noopener">https://github.com/sheepdog/sheepdog</a></td>
</tr>
<tr>
<td>TFS</td>
<td>淘宝针对海量非结构化数据存储设计的分布式系统</td>
<td>文件存储</td>
<td>C++</td>
<td><a href="http://tfs.taobao.org/" target="_blank" rel="noopener">http://tfs.taobao.org/</a></td>
<td><a href="https://github.com/alibaba/tfs" target="_blank" rel="noopener">https://github.com/alibaba/tfs</a></td>
</tr>
<tr>
<td>HDFS</td>
<td>基于GFS原理实现的java版的GFS</td>
<td>文件存储</td>
<td>Java</td>
<td><a href="https://wiki.apache.org/hadoop/HDFS" target="_blank" rel="noopener">https://wiki.apache.org/hadoop/HDFS</a></td>
<td><a href="https://github.com/apache/hadoop" target="_blank" rel="noopener">https://github.com/apache/hadoop</a></td>
</tr>
<tr>
<td>MooseFS</td>
<td>一个高容错性的分布式文件系统</td>
<td>文件存储</td>
<td>C</td>
<td><a href="http://moosefs.org/" target="_blank" rel="noopener">http://moosefs.org/</a></td>
<td><a href="https://github.com/moosefs/moosefs" target="_blank" rel="noopener">https://github.com/moosefs/moosefs</a></td>
</tr>
</tbody>
</table>
<p>参考：<a href="http://blog.csdn.net/metaxen/article/details/7108958" target="_blank" rel="noopener">http://blog.csdn.net/metaxen/article/details/7108958</a></p>
<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
<th>语言</th>
<th>官网 / WIKI</th>
<th>源码</th>
</tr>
</thead>
<tbody>
<tr>
<td>LevelDB</td>
<td>Google开发的，一个速度非常块的KV存储库</td>
<td>C++</td>
<td><a href="http://leveldb.org/" target="_blank" rel="noopener">http://leveldb.org/</a></td>
<td><a href="https://github.com/google/leveldb" target="_blank" rel="noopener">https://github.com/google/leveldb</a></td>
</tr>
<tr>
<td>RocksDB</td>
<td>Facebook 的可嵌入式的支持持久化的key-value 存储系统</td>
<td>C++</td>
<td><a href="http://rocksdb.org" target="_blank" rel="noopener">http://rocksdb.org</a></td>
<td><a href="https://github.com/facebook/rocksdb" target="_blank" rel="noopener">https://github.com/facebook/rocksdb</a></td>
</tr>
<tr>
<td>Redis</td>
<td>开源的，支持网络、基于内存亦可持久化的日志型键－值仓储</td>
<td>C</td>
<td><a href="http://redis.io/" target="_blank" rel="noopener">http://redis.io/</a></td>
<td><a href="https://github.com/antirez/redis" target="_blank" rel="noopener">https://github.com/antirez/redis</a></td>
</tr>
<tr>
<td>MongoDB</td>
<td>一个高性能，开源，无模式的文档型数据库 <br> 在许多场景下可用于替代传统的关系型数据库或键/值存储方式</td>
<td>C++</td>
<td><a href="https://www.mongodb.com/" target="_blank" rel="noopener">https://www.mongodb.com/</a></td>
<td><a href="https://github.com/mongodb/mongo" target="_blank" rel="noopener">https://github.com/mongodb/mongo</a></td>
</tr>
<tr>
<td>Cassandra</td>
<td>开源分布式NoSQL数据库系统 <br> 最大的特点就是完全去中心化</td>
<td>Go</td>
<td><a href="http://cassandra.apache.org/" target="_blank" rel="noopener">http://cassandra.apache.org/</a></td>
<td><a href="https://github.com/apache/cassandra" target="_blank" rel="noopener">https://github.com/apache/cassandra</a></td>
</tr>
<tr>
<td>HBase</td>
<td>运行在hadoop上的数据库 <br> 一个分布式的，扩展性高的，存储大数据的数据库</td>
<td>Jave</td>
<td><a href="https://hbase.apache.org/" target="_blank" rel="noopener">https://hbase.apache.org/</a></td>
<td><a href="https://github.com/apache/hbase" target="_blank" rel="noopener">https://github.com/apache/hbase</a></td>
</tr>
</tbody>
</table>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
<th>语言</th>
<th>官网 / WIKI</th>
<th>源码</th>
</tr>
</thead>
<tbody>
<tr>
<td>Alluxio</td>
<td>一个开源内存级虚拟大数据存储系统 <br> 它是架构在底层分布式文件系统和上层分布式计算框架之间的一个中间件 <br> 主要职责是以文件形式在内存或其它存储设施中提供数据的存取服务</td>
<td>Java</td>
<td><a href="http://www.alluxio.org/" target="_blank" rel="noopener">http://www.alluxio.org/</a></td>
<td><a href="https://github.com/Alluxio/alluxio" target="_blank" rel="noopener">https://github.com/Alluxio/alluxio</a></td>
</tr>
<tr>
<td>TiDB</td>
<td>基于Google Spanner，F1文章实现的开源版的NewSQL <br> 类似于国外Google工程师出来创建的Startup公司 CockroachDB</td>
<td>Go</td>
<td><a href="http://www.pingcap.com/" target="_blank" rel="noopener">http://www.pingcap.com/</a></td>
<td><a href="https://github.com/pingcap/tidb" target="_blank" rel="noopener">https://github.com/pingcap/tidb</a></td>
</tr>
</tbody>
</table>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/ictfox.jpg"
                alt="ictfox" />
            
              <p class="site-author-name" itemprop="name">ictfox</p>
              <p class="site-description motion-element" itemprop="description">学无止境</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">75</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">50</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/ictfox" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/smart_bruins" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://weibo.com/ictfox" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-weibo"></i>Weibo</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.askceph.com" title="Ceph问答社区" target="_blank">Ceph问答社区</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/for_tech" title="CSDN博客" target="_blank">CSDN博客</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ictfox</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://ictfox.disqus.com/count.js" async></script>
    

    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
